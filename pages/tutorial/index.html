<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Tutorial: Turning the Tables … – Scribe</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../pages/formatted-output.html" rel="prev">
<link href="../../assets/images/logo.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-3dab89b00e5da3c21c7fdf7320ab4863.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-e8ca782b0f038343a77a11b3e6da11e9.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-1c72929d01b0088021efc93cecacfdad.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-fd7f26691d08b4217965b71eb792887a.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/admonitions-1.0.0/admonitions.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


<meta property="og:title" content="Tutorial: Turning the Tables … – Scribe">
<meta property="og:description" content="">
<meta property="og:image" content="https://nessan.github.io/scribe/pages/tutorial/assets/images/logo.png">
<meta property="og:site_name" content="Scribe">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/images/logo.png" alt="The Scribe Logo" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Scribe</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/stringification.html"> 
<span class="menu-text">Stringification</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/format-options.html"> 
<span class="menu-text">Format Options</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/standard-formats.html"> 
<span class="menu-text">Standard Formats</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/custom-options.html"> 
<span class="menu-text">Custom Formats</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/formatted-output.html"> 
<span class="menu-text">Formatted Output</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../pages/tutorial/index.html"> 
<span class="menu-text">Tutorial</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-more" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">More</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-more">    
        <li>
    <a class="dropdown-item" href="https://github.com/nessan/scribe"><i class="bi bi-github" role="img">
</i> 
 <span class="dropdown-text">Project Repo</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/nessan/scribe/issues"><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report a Bug</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="mailto:nzznfitz+gh@icloud.com"><i class="bi bi-chat-right-text" role="img">
</i> 
 <span class="dropdown-text">Ask a Question</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/nessan/scribe" title="GitHub repo" class="quarto-navigation-tool px-1" aria-label="GitHub repo"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title">Tutorial: Turning the Tables …</h1>
        </a>     
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/stringification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stringification</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/format-options.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Format Options</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/standard-formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Standard Formats</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/custom-options.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Custom Formats</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/formatted-output.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Formatted Output</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../pages/tutorial/index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Turning the Tables …</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#lua-types" id="toc-lua-types" class="nav-link" data-scroll-target="#lua-types">Lua Types</a></li>
  <li><a href="#first-shot-at-tables" id="toc-first-shot-at-tables" class="nav-link" data-scroll-target="#first-shot-at-tables">First Shot at Tables</a></li>
  <li><a href="#anatomy-of-a-table" id="toc-anatomy-of-a-table" class="nav-link" data-scroll-target="#anatomy-of-a-table">Anatomy of a Table</a></li>
  <li><a href="#formatting-options" id="toc-formatting-options" class="nav-link" data-scroll-target="#formatting-options">Formatting Options</a></li>
  <li><a href="#the-comma-problem" id="toc-the-comma-problem" class="nav-link" data-scroll-target="#the-comma-problem">The Comma Problem</a></li>
  <li><a href="#arrays-vs.-tables" id="toc-arrays-vs.-tables" class="nav-link" data-scroll-target="#arrays-vs.-tables">Arrays vs.&nbsp;Tables</a></li>
  <li><a href="#adding-indentation" id="toc-adding-indentation" class="nav-link" data-scroll-target="#adding-indentation">Adding Indentation</a></li>
  <li><a href="#other-output-formats" id="toc-other-output-formats" class="nav-link" data-scroll-target="#other-output-formats">Other Output Formats</a></li>
  <li><a href="#ordered-output" id="toc-ordered-output" class="nav-link" data-scroll-target="#ordered-output">Ordered Output</a></li>
  <li><a href="#inlining-simple-sub-tables" id="toc-inlining-simple-sub-tables" class="nav-link" data-scroll-target="#inlining-simple-sub-tables">Inlining Simple Sub-Tables</a></li>
  <li><a href="#table-metadata" id="toc-table-metadata" class="nav-link" data-scroll-target="#table-metadata">Table Metadata</a></li>
  <li><a href="#cyclical-references" id="toc-cyclical-references" class="nav-link" data-scroll-target="#cyclical-references">Cyclical References</a></li>
  <li><a href="#breadth-first-traversal" id="toc-breadth-first-traversal" class="nav-link" data-scroll-target="#breadth-first-traversal">Breadth First Traversal</a></li>
  <li><a href="#scribe-facade" id="toc-scribe-facade" class="nav-link" data-scroll-target="#scribe-facade">Scribe Facade</a></li>
  <li><a href="#metamethods" id="toc-metamethods" class="nav-link" data-scroll-target="#metamethods">Metamethods</a></li>
  <li><a href="#the-scribe-module" id="toc-the-scribe-module" class="nav-link" data-scroll-target="#the-scribe-module">The <code>scribe</code> Module</a></li>
  <li><a href="#formatted-output" id="toc-formatted-output" class="nav-link" data-scroll-target="#formatted-output">Formatted Output</a></li>
  </ul>
<div class="toc-actions"><ul class="collapse"><li><a href="https://github.com/nessan/scribe/edit/main/docs/pages/tutorial/index.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/nessan/scribe/issues/new/choose" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Tutorial: Turning the Tables …</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Lua’s only rich native type is the <code>table</code>.</p>
<p>The table is the only game in town, so you will use it to implement every non-trivial data structure you need in any Lua project.</p>
<p>In this article, we will gradually build <code>scribe</code>, a Lua module that converts tables (and other Lua types) to readable strings.</p>
<p>Converting arbitrary Lua tables into descriptive strings is more complex than it initially appears. We’ll examine the issues that arise and how <code>scribe</code> addresses some of the pitfalls.</p>
<p>We will start with a trivial implementation in a dozen lines of Lua. Over time, we will evolve that code into a production-ready Lua module that handles the most complex tables with cycles and shared references. We will also see how to support multiple output formats in a single code block.</p>
<p>This blow-by-blow description and the liberally documented final product, <code>scribe.lua</code>, should be a helpful tutorial, at least for those new to Lua, especially those with experience in other languages.</p>
<div class="admonition warning">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-warning" title="Warning"></i></td>
    <td class="content">
    
This is not an introduction to Lua. Think of it as more Lua 201 than Lua 101.
</td></tr></tbody></table></div>
<p>This article is long, but we have tried to make it worthwhile. <br> And, of course, we hope you find <code>scribe</code> itself as helpful as we do!</p>
</section>
<section id="lua-types" class="level2">
<h2 class="anchored" data-anchor-id="lua-types">Lua Types</h2>
<p>Like every other programming language ever invented, the classic first Lua script is:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="va">str</span> <span class="op">=</span> <span class="st">"Hello World"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">str</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And, hey presto, it works! On your terminal, the output is:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Hello</span> World</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That handy <code>print</code> function works as you’d expect for many Lua types.</p>
<div class="admonition note">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-note" title="Note"></i></td>
    <td class="content">
    
Lua always aims for the minimal and has only eight types in <em>total</em>. <br> Compare that to Rust, which has twelve types just for integers!
</td></tr></tbody></table></div>
<p>By the way, Lua’s <code>tostring</code> function is a companion to <code>print</code> and converts any Lua type to a string.</p>
<section id="simple-types" class="level3">
<h3 class="anchored" data-anchor-id="simple-types">Simple Types</h3>
<p>The four most straightforward Lua types are <code>number</code>, <code>boolean</code>, <code>string</code> and <code>nil</code>:</p>
<div class="sourceCode" id="annotated-cell-3"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-3-1" class="code-annotation-target"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a><span class="va">str</span> <span class="op">=</span> <span class="st">"Cinderella"</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-3-2" class="code-annotation-target"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a><span class="va">answer</span> <span class="op">=</span> <span class="dv">42</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-3-3" class="code-annotation-target"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a><span class="va">pi</span> <span class="op">=</span> <span class="dv">3.14</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-3-4" class="code-annotation-target"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a><span class="va">flag</span> <span class="op">=</span> <span class="kw">false</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-3-5" class="code-annotation-target"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a><span class="va">oops</span> <span class="op">=</span> <span class="kw">nil</span></span>
<span id="annotated-cell-3-6"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">str</span><span class="op">,</span> <span class="va">answer</span><span class="op">,</span> <span class="va">pi</span><span class="op">,</span> <span class="va">flag</span><span class="op">,</span> <span class="va">oops</span><span class="op">)</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="1" data-code-annotation="1">A <code>string</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="2" data-code-annotation="2">A <code>number</code> that is an integer.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="3" data-code-annotation="3">This <code>number</code> is a float, but Lua uses one type for integers and floats.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="4" data-code-annotation="4">A <code>boolean</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="5" data-code-annotation="5">A special <code>nil</code> type indicates not-founds, fails, etc.</span>
</dd>
</dl>
<p>In each case, you get very reasonable results on your screen:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Cinderella</span>  42 3.14 false nil</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can use <code>print</code> to dump recognisable values from <code>number</code>, <code>boolean</code>, <code>string</code> and even <code>nil</code>.</p>
<p>The simplest form of debugging is to sprinkle print statements throughout your code liberally, so the more types <code>print</code> works on, the better. Sure, it’s not elegant, but every programmer uses print statements when things go awry. Even more so in a non-compiled, dynamic language like Lua, where adding a print statement and rerunning happens as fast as you can type.</p>
<p>Lua has four additional types beyond <code>number</code>, <code>string</code>, <code>boolean</code>, and <code>nil</code>.<br> These are <code>function</code>, <code>userdata</code>, <code>thread</code> and <code>table</code>.</p>
</section>
<section id="lua-functions" class="level3">
<h3 class="anchored" data-anchor-id="lua-functions">Lua Functions</h3>
<p>Lua methods you write or import all have the type <code>function</code>. <br> Let’s look at a simple function example:</p>
<div class="sourceCode" id="annotated-cell-5"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> answer<span class="op">()</span> <span class="cf">return</span> <span class="dv">42</span> <span class="kw">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-5-2" class="code-annotation-target"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span>answer<span class="op">())</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-5-3" class="code-annotation-target"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">answer</span><span class="op">)</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="2" data-code-annotation="1">This prints whatever is <em>returned</em> from our <code>answer</code> function.</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="3" data-code-annotation="2">This prints what Lua thinks of as the function itself.</span>
</dd>
</dl>
<p>Output:</p>
<div class="sourceCode" id="annotated-cell-6"><pre class="sourceCode sh code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">42</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-6-2" class="code-annotation-target"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">function:</span> 0x600003e6cca0</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="2" data-code-annotation="1">The part after the colon will vary from run to run.</span>
</dd>
</dl>
<p>The string <code>"function"</code> is descriptive enough, but the string <code>0x...</code> that follows the colon is opaque. It is the <em>address</em> in memory where Lua stores its form of the function in question. That is consistent for a single run, so if you print the function twice:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> answer<span class="op">()</span> <span class="cf">return</span> <span class="dv">42</span> <span class="kw">end</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">answer</span><span class="op">)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">answer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The code outputs the exact string twice, e.g.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">function:</span> 0x6000032a8ca0</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">function:</span> 0x6000032a8ca0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, the next time you run the program, you’ll get something else, such as</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">function:</span> 0x600002650ca0</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">function:</span> 0x600002650ca0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We don’t usually write things like <code>print(answer)</code> in our code except by accident! When we do, it’s likely a bug. We probably <em>meant</em> to write <code>print(answer())</code> with those parentheses <code>()</code> that tells Lua to please execute the <code>answer</code> function and capture the result, So, while the output from <code>print(answer)</code> is opaque, it’s generally followed by an “oops, I forgot some parentheses!”</p>
</section>
<section id="two-non-native-types" class="level3">
<h3 class="anchored" data-anchor-id="two-non-native-types">Two Non-Native Types</h3>
<p>One of Lua’s great strengths is its ability to interface with things written in other languages. Lua’s two non-native types, <code>userdata</code> and <code>thread</code>, are associated with non-native items.</p>
<p>When you try to print something implemented in another language, it is hardly surprising that Lua can only say, “I see that as a piece of user data located at this address in memory.”</p>
<p>You can’t expect much more; if you need something more descriptive, you’d expect to perform that action in another language.</p>
</section>
<section id="array-tables" class="level3">
<h3 class="anchored" data-anchor-id="array-tables">Array Tables</h3>
<p>Finally, we come to the all-important <code>table</code> type, starting with Lua arrays, a subset of this type.</p>
<p>The <code>table</code> type is Lua’s <em>only</em> “complex” <em>native</em> data type and is amazingly versatile. Once you use Lua for anything beyond trivial scripts, you will inevitably build and interpret many tables.</p>
<p>Tables can contain all Lua types, including Lua functions and other tables, which can refer to each other in cycles, etc.</p>
<p>But let’s start with a simple array example:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="va">gents</span> <span class="op">=</span> <span class="op">{</span><span class="st">'Tom'</span><span class="op">,</span> <span class="st">'Dick'</span><span class="op">,</span> <span class="st">'Harry'</span><span class="op">}</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">gents</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The corresponding output will be something like:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">table:</span> 0x600001d32980</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This output is similar in spirit to what we got by calling <code>print</code> on that Lua function shown above. Lua recognises the <code>gents</code> object as a <code>table</code> at some memory address, and that’s all it reveals.</p>
<p>To emphasise the point, we note that the Lua assignment operator for tables creates another variable that points to the <em>same</em> table:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="va">gents</span> <span class="op">=</span> <span class="op">{</span><span class="st">'Tom'</span><span class="op">,</span> <span class="st">'Dick'</span><span class="op">,</span> <span class="st">'Harry'</span><span class="op">}</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="va">aka</span> <span class="op">=</span> <span class="va">gents</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">gents</span><span class="op">)</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">aka</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This outputs:</p>
<div class="sourceCode" id="annotated-cell-13"><pre class="sourceCode sh code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-13-1" class="code-annotation-target"><a href="#annotated-cell-13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">table:</span> 0x600002e96940</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-13-2" class="code-annotation-target"><a href="#annotated-cell-13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">table:</span> 0x600002e96940</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-13" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="1" data-code-annotation="1">The variables <code>gents</code> and <code>aka</code> are really <em>pointers</em> to the same memory address.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="2" data-code-annotation="2">The specific memory location will vary from run to run,</span>
</dd>
</dl>
<p>Of course, this output is not helpful and isn’t what you’d naively expect!</p>
<p>You search for “How do I print a Lua array?” and find an answer like:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="fu">table.concat</span><span class="op">(</span><span class="va">gents</span><span class="op">,</span> <span class="st">", "</span><span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And sure enough, out pops the string “Tom, Dick, Harry”.</p>
<p>At this point, you may feel aggrieved!</p>
<p>Why didn’t <code>print(gents)</code> return something like <code>"Tom", "Dick", "Harry"</code> in the first place? What is that <code>table.concat(...)</code> call? Everybody would prefer the second output over being told that Lua recognises <code>gents</code> as a <code>table</code> that resides at some address in memory. There must be a better way!</p>
</section>
<section id="key-value-tables" class="level3">
<h3 class="anchored" data-anchor-id="key-value-tables">Key-Value Tables</h3>
<p>Things get even more screwy when you try to print a more general Lua <code>table</code> that isn’t an array:</p>
<div class="sourceCode" id="annotated-cell-15"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-15-1" class="code-annotation-target"><a href="#annotated-cell-15-1" aria-hidden="true" tabindex="-1"></a><span class="va">mouse</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="annotated-cell-15-2"><a href="#annotated-cell-15-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">first</span> <span class="op">=</span> <span class="st">'Minnie'</span><span class="op">,</span></span>
<span id="annotated-cell-15-3"><a href="#annotated-cell-15-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">last</span> <span class="op">=</span> <span class="st">'Mouse'</span></span>
<span id="annotated-cell-15-4"><a href="#annotated-cell-15-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-15" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="1" data-code-annotation="1">This is a Lua table with two name-value pairs.</span>
</dd>
</dl>
<p>Lua adheres to Mies Van der Rohe’s “less is more” mantra. It likes to keep things simple!</p>
<p>For example, we saw earlier that the Lua <code>number</code> type encompasses all classes of integers and all classes of floating-point numbers. Other “system-level” computer languages distinguish between them, as every piece of computer hardware has different paths for the types at the chip level. Programmers of those languages must understand and care about the differences between integers and floats. That distinction makes sense if you want to squeeze the maximum performance from every CPU nanosecond.</p>
<p>Lua has different goals. It is still efficient, but it is willing to spare a few compute cycles to limit type complexity for the programmer. If you code in Lua, you can only use generic “numbers” and trust that Lua handles them efficiently, whatever the form of those numbers of interest may be.</p>
<p>The Lua <code>table</code> type is similar, encompassing simple arrays, like the <code>gents</code> example, and more general hash map tables with explicit keys and values, like the <code>mouse</code> example. This combination seems odd if you have done any programming before encountering Lua.</p>
<p>The other “real” computer languages you learnt all distinguish between arrays and dictionaries. In those languages, arrays are part of the core language. A long, early manual chapter will expound on their use. The description for the name-value dictionary-type container will be in the back of the book in the section dedicated to the language’s “standard” library. This division reflects that the hardware paths for the two container types are generally very different. Arrays are considered more <em>fundamental</em> than dictionaries of name-value pairs.</p>
<p>Lua, in effect, says:</p>
<blockquote class="blockquote">
<p>Trust me, build that table however makes the most sense to you, and let me worry about efficiency.</p>
</blockquote>
<p>Overall, this works remarkably well. Lua internally splits tables into an array part that zips along the high-speed lane of the hardware highway and a dictionary part that is necessarily over on a lower-speed lane. Again, the trade-off is between programming simplicity with a “trust me, I’ll get you almost the same speed” clause and the maximum performance per nanosecond.</p>
<p>Given our lack of success at getting something useful out of <code>print</code> for an array, we aren’t going to be surprised to see similar nonsense from <code>print(mouse)</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">table:</span> 0x6000027d9b00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Lua tells you that <code>mouse</code> is a table residing at a specific memory location. <br> True, but not very helpful!</p>
<p>If we try our earlier trick</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="fu">table.concat</span><span class="op">(</span><span class="va">mouse</span><span class="op">,</span> <span class="st">", "</span><span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Lua outputs a blank line. Well, you just learnt something—apparently, <code>table.concat</code> only works on Lua array-like tables.</p>
<div class="admonition note">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-note" title="Note"></i></td>
    <td class="content">
    
A Lua array has <em>implicit</em> keys with successive integers starting at 1. General Lua hash tables have explicit keys, such as the strings <code>first</code> and <code>last</code> in the <code>mouse</code> example. The keys can be any Lua object, not just strings.
</td></tr></tbody></table></div>
<p>Of course, we can unpack our table and write:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">name</span><span class="op">.</span><span class="va">first</span><span class="op">,</span> <span class="va">name</span><span class="op">.</span><span class="va">last</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we get “Minnie Mouse”.</p>
<p>Another quick search provides an answer for tables with an arbitrary number of key-value pairs:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">mouse</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span><span class="op">(</span><span class="va">k</span><span class="op">,</span><span class="va">v</span><span class="op">)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When I ran it the first time, this output:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">last</span>    Mouse</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">first</span>   Minnie</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output is a valid representation of the data but not in a natural order. Running the script a few more times may eventually give a better order:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">first</span>   Minnie</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">last</span>    Mouse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="admonition caution">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-caution" title="Caution"></i></td>
    <td class="content">
    
Lua stores key-value tables in an <em>undefined</em> order, which can vary from run to run. The <code>pairs</code> function iterates through the key-value pairs in storage order, so it’s not constant. Arrays, on the other hand, are always stored in the natural increasing index order.
</td></tr></tbody></table></div>
</section>
</section>
<section id="first-shot-at-tables" class="level2">
<h2 class="anchored" data-anchor-id="first-shot-at-tables">First Shot at Tables</h2>
<p>At this point in your Lua journey, you probably search for “How do I convert a Lua table to a string?”. You will find a lot of suggestions, some quite good and some not so good.</p>
<p>But suppose you wish to build your very own solution based on the discovery that you can use the <code>pairs</code> function to iterate through a table.</p>
<p>Well, you know that recursion is the touch of the hand of God and that Spidey sense is telling you this is the place to use it!</p>
<p>With a little spare time on your hands, you come with code along the lines of:</p>
<div class="sourceCode" id="annotated-cell-22"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-22-1" class="code-annotation-target"><a href="#annotated-cell-22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-22-2" class="code-annotation-target"><a href="#annotated-cell-22-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="st">'    '</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-22-3" class="code-annotation-target"><a href="#annotated-cell-22-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">retval</span> <span class="op">=</span> <span class="st">'{</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-22-4"><a href="#annotated-cell-22-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-22-5" class="code-annotation-target"><a href="#annotated-cell-22-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> <span class="va">indent</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-22-6" class="code-annotation-target"><a href="#annotated-cell-22-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="st">' = '</span></span>
<span id="annotated-cell-22-7"><a href="#annotated-cell-22-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-22-8" class="code-annotation-target"><a href="#annotated-cell-22-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-22-9"><a href="#annotated-cell-22-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-22-10" class="code-annotation-target"><a href="#annotated-cell-22-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-22-11"><a href="#annotated-cell-22-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-22-12" class="code-annotation-target"><a href="#annotated-cell-22-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> <span class="st">',</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-22-13"><a href="#annotated-cell-22-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-22" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-22-14" class="code-annotation-target"><a href="#annotated-cell-22-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span>  <span class="st">'</span><span class="sc">\n</span><span class="st">}'</span></span>
<span id="annotated-cell-22-15"><a href="#annotated-cell-22-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-22-16"><a href="#annotated-cell-22-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-22" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="1" data-code-annotation="1">A descriptive function name. However, we should check that <code>tbl</code> is a Lua table!</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="2" data-code-annotation="2">We hard code the <code>indent</code> to four spaces. <br> This is a parameter the user will want to set.</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="3" data-code-annotation="3">Start the return string with a <code>{</code>and a newline character. <br> The user might want to set the table delimiters to something other than braces.</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="5" data-code-annotation="4">Indent every key-value pair inside the table.</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="6" data-code-annotation="5">Add the key <code>k</code> as a string and an assignment <code>=</code>. <br> Another potentially user-settable parameter.</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="8" data-code-annotation="6">The value <code>v</code> isn’t a table. We can use <code>tostring</code> and add it to the return value.</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="10" data-code-annotation="7">A sub-table! “Look, Ma, that’s recursion. I’m a real programmer!””</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="12" data-code-annotation="8">End the table element with a separator <code>,</code> followed by a newline character.</span>
</dd>
<dt data-target-cell="annotated-cell-22" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-22" data-code-lines="14" data-code-annotation="9">Finally, close the string with a newline character and a matching table end-delimiter <code>}</code>.</span>
</dd>
</dl>
<div class="admonition caution">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-caution" title="Caution"></i></td>
    <td class="content">
    
While we have begun handling nested sub-tables using recursion, this version will not get the indentation right. We’ll come back to that problem shortly.
</td></tr></tbody></table></div>
<p>You try it out on our little mouse by calling <code>print(table_string(mouse))</code>, which returns:</p>
<div class="sourceCode" id="annotated-cell-23"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-23-1"><a href="#annotated-cell-23-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="annotated-cell-23-2"><a href="#annotated-cell-23-2" aria-hidden="true" tabindex="-1"></a>    first = Minnie,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-23-3" class="code-annotation-target"><a href="#annotated-cell-23-3" aria-hidden="true" tabindex="-1"></a>    last = Mouse,</span>
<span id="annotated-cell-23-4"><a href="#annotated-cell-23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-23-5"><a href="#annotated-cell-23-5" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-23" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="3" data-code-annotation="1">That’s an annoying extra comma and newline character after the final table element.</span>
</dd>
</dl>
<p>Overall, it’s not bad! There is that extra comma and new line that looks a bit off, and of course, if you run that <code>print(table_string(mouse))</code> a few times, you will see that the print order of the elements changes:</p>
<div class="sourceCode" id="annotated-cell-24"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-24-1"><a href="#annotated-cell-24-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="annotated-cell-24-2"><a href="#annotated-cell-24-2" aria-hidden="true" tabindex="-1"></a>    last = Mouse,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-24-3" class="code-annotation-target"><a href="#annotated-cell-24-3" aria-hidden="true" tabindex="-1"></a>    first = Minnie,</span>
<span id="annotated-cell-24-4"><a href="#annotated-cell-24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-24-5"><a href="#annotated-cell-24-5" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-24" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="3" data-code-annotation="1">The element order changed, but the extra comma and newline character remains firmly in place.</span>
</dd>
</dl>
<section id="making-indent-a-parameter" class="level3">
<h3 class="anchored" data-anchor-id="making-indent-a-parameter">Making <code>indent</code> a Parameter</h3>
<p>Before we tackle the extra comma and newline character, let’s make <code>indent</code> a parameter. This is easy to do by adding a second optional argument to the function:</p>
<div class="sourceCode" id="annotated-cell-25"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-25-1" class="code-annotation-target"><a href="#annotated-cell-25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">indent</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-25" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-25-2" class="code-annotation-target"><a href="#annotated-cell-25-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span> <span class="op">=</span> <span class="va">indent</span> <span class="kw">or</span> <span class="st">'    '</span></span>
<span id="annotated-cell-25-3"><a href="#annotated-cell-25-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-25" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-25" data-code-lines="1" data-code-annotation="1">We add a second argument to the function, which should be a string.</span>
</dd>
<dt data-target-cell="annotated-cell-25" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-25" data-code-lines="2" data-code-annotation="2">If the user doesn’t provide a value for <code>indent</code>, we default to four spaces.</span>
</dd>
</dl>
<p>Only multiline formats will ever use indentation. The output should be a single line if the function is called with an <code>indent</code> as the <em>empty string</em>. We can use this check to trigger inline versus multiline output:</p>
<div class="sourceCode" id="annotated-cell-26"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-26-1"><a href="#annotated-cell-26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">indent</span><span class="op">)</span></span>
<span id="annotated-cell-26-2"><a href="#annotated-cell-26-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>  <span class="op">=</span> <span class="va">indent</span> <span class="kw">or</span> <span class="st">'    '</span></span>
<span id="annotated-cell-26-3"><a href="#annotated-cell-26-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-26-4" class="code-annotation-target"><a href="#annotated-cell-26-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span>     <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="st">''</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-26-5" class="code-annotation-target"><a href="#annotated-cell-26-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">retval</span> <span class="op">=</span> <span class="st">'{'</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-26-6"><a href="#annotated-cell-26-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-26-7"><a href="#annotated-cell-26-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> <span class="va">indent</span></span>
<span id="annotated-cell-26-8"><a href="#annotated-cell-26-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="st">' = '</span></span>
<span id="annotated-cell-26-9"><a href="#annotated-cell-26-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-26-10"><a href="#annotated-cell-26-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-26-11"><a href="#annotated-cell-26-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-26-12" class="code-annotation-target"><a href="#annotated-cell-26-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">indent</span><span class="op">)</span></span>
<span id="annotated-cell-26-13"><a href="#annotated-cell-26-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-26-14" class="code-annotation-target"><a href="#annotated-cell-26-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> <span class="st">','</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-26-15"><a href="#annotated-cell-26-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-26" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-26-16" class="code-annotation-target"><a href="#annotated-cell-26-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span> <span class="op">..</span> <span class="va">nl</span> <span class="op">..</span> <span class="st">'}'</span></span>
<span id="annotated-cell-26-17"><a href="#annotated-cell-26-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-26-18"><a href="#annotated-cell-26-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-26" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="4" data-code-annotation="1">We parametrise the “newline character” <code>nl</code> and set it to the empty string for inline outputs.</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="5" data-code-annotation="2">Instead of hard-coding the newline character, we add <code>nl</code> to the opening brace</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="12" data-code-annotation="3">We pass <code>indent</code> to the recursive call.</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="14" data-code-annotation="4">We add <code>nl</code> to the separator <code>,</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-26" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-26" data-code-lines="16" data-code-annotation="5">Finally, we add <code>nl</code> to the closing brace.</span>
</dd>
</dl>
<div class="admonition tip">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-tip" title="Tip"></i></td>
    <td class="content">
    
Whenever you change the calling signature of a recursive function, you must update the recursive call to match. From experience, this is a common source of bugs.
</td></tr></tbody></table></div>
<p>Now, if you call <code>print(table_string(mouse, ''))</code>, you will get:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>{first = Minnie,last = Mouse,}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That’s a single line with no newlines or indentation, though there is an extra trailing comma we need to eliminate.</p>
</section>
</section>
<section id="anatomy-of-a-table" class="level2">
<h2 class="anchored" data-anchor-id="anatomy-of-a-table">Anatomy of a Table</h2>
<p>Although our current output string is flawed, nonetheless, it highlights the general structure for any table:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>table-begin-delimiter</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    content</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>table-end-delimiter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In our first attempt, the <code>table_begin</code> and <code>table_end</code> delimiters are the opening and closing braces surrounding the table content. The table delimiters should be user-configurable.</p>
<p>The table content is a sequence of zero or more <em>elements</em>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>table-begin-delimiter</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    element,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    element,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>table-end-delimiter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each element includes a key, possibly an assignment operator, and a value. Array “keys” are the array indices and are often not shown as they are implicit in the ordering of the values.</p>
<p>In some formats like JSON, the keys must be enclosed in double-quotes. We can accommodate that requirement by introducing key delimiters, <code>key_begin</code> and <code>key_end</code>. The assignment operator can always be incorporated as part of <code>key_end</code>.</p>
<p>Elements also have begin and end delimiters, though those vary according to context. In our current implementation, the element beginning delimiter is some indentation. The element ending delimiter is the comma character followed by a new line. This is the separator between elements in the table.</p>
<p>The indentation amount and the element separator should be user-configurable.</p>
<p>Using this terminology, we can rewrite our <code>table_string</code> function:</p>
<div class="sourceCode" id="annotated-cell-30"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-30-1"><a href="#annotated-cell-30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">indent</span><span class="op">)</span></span>
<span id="annotated-cell-30-2"><a href="#annotated-cell-30-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span> <span class="op">=</span> <span class="va">indent</span> <span class="kw">or</span> <span class="st">'    '</span></span>
<span id="annotated-cell-30-3"><a href="#annotated-cell-30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-30-4"><a href="#annotated-cell-30-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span>          <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="st">''</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-30-5" class="code-annotation-target"><a href="#annotated-cell-30-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">table_begin</span> <span class="op">=</span> <span class="st">'{'</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-30-6"><a href="#annotated-cell-30-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">table_end</span>   <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="st">'}'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-30-7" class="code-annotation-target"><a href="#annotated-cell-30-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">key_begin</span>   <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-30-8"><a href="#annotated-cell-30-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">key_end</span>     <span class="op">=</span> <span class="st">' = '</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-30-9" class="code-annotation-target"><a href="#annotated-cell-30-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">sep</span>         <span class="op">=</span> <span class="st">','</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-30-10"><a href="#annotated-cell-30-10" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-30-11" class="code-annotation-target"><a href="#annotated-cell-30-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-30-12"><a href="#annotated-cell-30-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-30-13" class="code-annotation-target"><a href="#annotated-cell-30-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">key_begin</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">key_end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-30-14" class="code-annotation-target"><a href="#annotated-cell-30-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="kw">and</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="kw">or</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">indent</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-30-15" class="code-annotation-target"><a href="#annotated-cell-30-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span> <span class="op">..</span> <span class="va">sep</span></span>
<span id="annotated-cell-30-16"><a href="#annotated-cell-30-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-30" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-30-17" class="code-annotation-target"><a href="#annotated-cell-30-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">table_begin</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">table_end</span></span>
<span id="annotated-cell-30-18"><a href="#annotated-cell-30-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-30" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="5" data-code-annotation="1">We introduce the table delimiters as parameters.</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="7" data-code-annotation="2">We introduce the key delimiters as parameters.</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="9" data-code-annotation="3">We introduce the element separator as a parameter.</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="11" data-code-annotation="4">Capture the table content in <code>content</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="13" data-code-annotation="5">Appropriate delimiters surround the key string. <br> We might cause this to disappear entirely if <code>tbl</code> is a Lua array.</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="14" data-code-annotation="6">The value string may need to be found using recursion.</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="15" data-code-annotation="7">Add the current element to the content.</span>
</dd>
<dt data-target-cell="annotated-cell-30" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-30" data-code-lines="17" data-code-annotation="8">Finally, surround the table content with table delimiters.</span>
</dd>
</dl>
<p>At first blush, this does not look like an improvement. It is undoubtedly more verbose. However, it is a step towards the goal of supporting many different output formats in one function.</p>
<p>If we set <code>key_begin</code> and <code>key_end</code> to <code>'"'</code> and <code>'": '</code> respectively, we get:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    "last": Mouse,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    "first": Minnie,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is a good start on JSON output, but we still have the trailing comma problem, and the string values are not enclosed in double-quotes. We’ll return to this later.</p>
</section>
<section id="formatting-options" class="level2">
<h2 class="anchored" data-anchor-id="formatting-options">Formatting Options</h2>
<p>There are already quite a few parameters at the top of the <code>table_string</code> function that the user might want to set, and more are to come.</p>
<p>Formatting problems, such as the one here and UI settings for many programs, are notorious for having numerous settable parameters. If a parameter is missing, it should default to some reasonable value.</p>
<p>We could continue adding arguments to the function, but that’s not a great idea.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">indent</span><span class="op">,</span> <span class="va">table_begin</span><span class="op">,</span> <span class="va">table_end</span><span class="op">,</span> <span class="va">key_begin</span><span class="op">,</span> <span class="va">key_end</span><span class="op">,</span> <span class="va">sep</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This calling signature is not user-friendly. It is too verbose and error-prone. It’s easy to forget the arguments’ order or leave one out.</p>
<p>Some languages have the idea of <em>named</em> arguments, which greatly help in this situation. Lua doesn’t directly support named parameters but has a versatile <code>table</code> object. We can pack all the formatting options into a table and pass that table as a single argument:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>opts</code> is a table that holds all our formatting parameters. For example, we might query <code>opts.indent</code> for the desired tab size, etc.</p>
<p>The <code>opts</code> argument itself should be optional. For now, we’ll assume that if it is present, it has all the fields we need—it is <em>fully defined</em>.</p>
<p>Let’s set up a <em>default</em> fallback table of formatting options that might look like this:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">pretty_options</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>      <span class="op">=</span> <span class="st">'    '</span><span class="op">,</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_begin</span> <span class="op">=</span> <span class="st">'{'</span><span class="op">,</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_end</span>   <span class="op">=</span> <span class="st">'}'</span><span class="op">,</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_begin</span>   <span class="op">=</span> <span class="st">''</span><span class="op">,</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_end</span>     <span class="op">=</span> <span class="st">' = '</span><span class="op">,</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span>         <span class="op">=</span> <span class="st">','</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We should have a few different sets of formatting options. For example, we would like a multiline version, as well as a more compact, inline version. We can set up a table of options for each of these, so let’s start with that pretty version:</p>
<div class="sourceCode" id="annotated-cell-35"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-35" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-35-1" class="code-annotation-target"><a href="#annotated-cell-35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">options</span> <span class="op">=</span> <span class="op">{}</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-35" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-35-2" class="code-annotation-target"><a href="#annotated-cell-35-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">pretty</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="annotated-cell-35-3"><a href="#annotated-cell-35-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>      <span class="op">=</span> <span class="st">'    '</span><span class="op">,</span></span>
<span id="annotated-cell-35-4"><a href="#annotated-cell-35-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_begin</span> <span class="op">=</span> <span class="st">'{'</span><span class="op">,</span></span>
<span id="annotated-cell-35-5"><a href="#annotated-cell-35-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_end</span>   <span class="op">=</span> <span class="st">'}'</span><span class="op">,</span></span>
<span id="annotated-cell-35-6"><a href="#annotated-cell-35-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_begin</span>   <span class="op">=</span> <span class="st">''</span><span class="op">,</span></span>
<span id="annotated-cell-35-7"><a href="#annotated-cell-35-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_end</span>     <span class="op">=</span> <span class="st">' = '</span><span class="op">,</span></span>
<span id="annotated-cell-35-8"><a href="#annotated-cell-35-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span>         <span class="op">=</span> <span class="st">','</span></span>
<span id="annotated-cell-35-9"><a href="#annotated-cell-35-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-35" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-35" data-code-lines="1" data-code-annotation="1">We set up a table to hold all our tables of formatting parameters.</span>
</dd>
<dt data-target-cell="annotated-cell-35" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-35" data-code-lines="2" data-code-annotation="2">We set up a sub-table <code>options.pretty</code> of options for the pretty version.</span>
</dd>
</dl>
<p>To use this, our primary <code>table_string</code> function becomes:</p>
<div class="sourceCode" id="annotated-cell-36"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-36-1" class="code-annotation-target"><a href="#annotated-cell-36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-36-2" class="code-annotation-target"><a href="#annotated-cell-36-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-36-3"><a href="#annotated-cell-36-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-36-4" class="code-annotation-target"><a href="#annotated-cell-36-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-36-5"><a href="#annotated-cell-36-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span>     <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="st">''</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-36-6" class="code-annotation-target"><a href="#annotated-cell-36-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tb</span>     <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-36-7"><a href="#annotated-cell-36-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">te</span>     <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-36-8" class="code-annotation-target"><a href="#annotated-cell-36-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-36-9" class="code-annotation-target"><a href="#annotated-cell-36-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-36-10"><a href="#annotated-cell-36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-36-11"><a href="#annotated-cell-36-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-36-12"><a href="#annotated-cell-36-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-36-13"><a href="#annotated-cell-36-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-36" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-36-14" class="code-annotation-target"><a href="#annotated-cell-36-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="kw">and</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="kw">or</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-36-15"><a href="#annotated-cell-36-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span> <span class="op">..</span> <span class="va">sep</span></span>
<span id="annotated-cell-36-16"><a href="#annotated-cell-36-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-36-17"><a href="#annotated-cell-36-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-36-18"><a href="#annotated-cell-36-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-36" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-36" data-code-lines="1" data-code-annotation="1">We changed the calling signature to incorporate an optional table of formatting parameters.</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-36" data-code-lines="2" data-code-annotation="2">We use the <code>options.pretty</code> table if’ options’ is absent.</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-36" data-code-lines="4" data-code-annotation="3">Grab the <code>indent</code> field from the <code>opts</code> table.</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-36" data-code-lines="6" data-code-annotation="4">We unpack the <code>opts</code> table into local variables for convenience where <code>tb</code> is <code>table_begin</code>, etc.</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-36" data-code-lines="8" data-code-annotation="5">We unpack the <code>opts</code> table into local variables for convenience where <code>kb</code> is <code>key_begin</code>, etc.</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-36" data-code-lines="9" data-code-annotation="6">Localise the element separator.</span>
</dd>
<dt data-target-cell="annotated-cell-36" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-36" data-code-lines="14" data-code-annotation="7">Remember to pass the <code>opts</code> table to the recursive call!</span>
</dd>
</dl>
<p>We can now call <code>print(table_string(mouse))</code> and get the same output as before:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    last = Mouse,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    first = Minnie,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s add a set of options that is specifically for one-line output. We start with a little function to make a shallow clone of any table:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> table_clone<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">retval</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span><span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span> <span class="va">retval</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span> <span class="va">v</span> <span class="cf">end</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we can easily set up <code>options.inline</code>:</p>
<div class="sourceCode" id="annotated-cell-39"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-39-1" class="code-annotation-target"><a href="#annotated-cell-39-1" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-39" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-39-2" class="code-annotation-target"><a href="#annotated-cell-39-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline</span><span class="op">.</span><span class="va">indent</span> <span class="op">=</span> <span class="st">''</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-39" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-39" data-code-lines="1" data-code-annotation="1">We make a shallow copy of <code>options.pretty</code> and then override the fields we want to change.</span>
</dd>
<dt data-target-cell="annotated-cell-39" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-39" data-code-lines="2" data-code-annotation="2">We set <code>indent</code> to an empty string.</span>
</dd>
</dl>
<p>Now we can call <code>print(table_string(mouse, options.inline))</code> and get:</p>
<div class="sourceCode" id="annotated-cell-40"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-40" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-40-1" class="code-annotation-target"><a href="#annotated-cell-40-1" aria-hidden="true" tabindex="-1"></a>{last = Mouse,first = Minnie,}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-40" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-40" data-code-lines="1" data-code-annotation="1">Still have that pesky trailing comma, but we’ll fix that soon.</span>
</dd>
</dl>
<p>The inline version looks cramped. One way to improve things is to add some spaces to the table delimiters and element separator:</p>
<div class="sourceCode" id="annotated-cell-41"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-41-1"><a href="#annotated-cell-41-1" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="annotated-cell-41-2"><a href="#annotated-cell-41-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline</span><span class="op">.</span><span class="va">indent</span>      <span class="op">=</span> <span class="st">''</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-41" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-41-3" class="code-annotation-target"><a href="#annotated-cell-41-3" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline</span><span class="op">.</span><span class="va">table_begin</span> <span class="op">=</span> <span class="st">'{ '</span></span>
<span id="annotated-cell-41-4"><a href="#annotated-cell-41-4" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline</span><span class="op">.</span><span class="va">table_end</span>   <span class="op">=</span> <span class="st">' }'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-41" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-41-5" class="code-annotation-target"><a href="#annotated-cell-41-5" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline</span><span class="op">.</span><span class="va">sep</span>         <span class="op">=</span> <span class="st">', '</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-41" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-41" data-code-lines="3" data-code-annotation="1">Add some breathing room between the table delimiters and the content.</span>
</dd>
<dt data-target-cell="annotated-cell-41" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-41" data-code-lines="5" data-code-annotation="2">Space out the table elements.</span>
</dd>
</dl>
<p>An alternate approach is to add those spaces on the fly when needed. Some inline formats want to be as compact as possible, so we can make adding those spaces a formatting option:</p>
<div class="sourceCode" id="annotated-cell-42"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-42-1"><a href="#annotated-cell-42-1" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">pretty</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="annotated-cell-42-2"><a href="#annotated-cell-42-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>        <span class="op">=</span> <span class="st">'    '</span><span class="op">,</span></span>
<span id="annotated-cell-42-3"><a href="#annotated-cell-42-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_begin</span>   <span class="op">=</span> <span class="st">'{'</span><span class="op">,</span></span>
<span id="annotated-cell-42-4"><a href="#annotated-cell-42-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_end</span>     <span class="op">=</span> <span class="st">'}'</span><span class="op">,</span></span>
<span id="annotated-cell-42-5"><a href="#annotated-cell-42-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_begin</span>     <span class="op">=</span> <span class="st">''</span><span class="op">,</span></span>
<span id="annotated-cell-42-6"><a href="#annotated-cell-42-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_end</span>       <span class="op">=</span> <span class="st">' = '</span><span class="op">,</span></span>
<span id="annotated-cell-42-7"><a href="#annotated-cell-42-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span>           <span class="op">=</span> <span class="st">','</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-42" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-42-8" class="code-annotation-target"><a href="#annotated-cell-42-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_spacer</span> <span class="op">=</span> <span class="st">' '</span></span>
<span id="annotated-cell-42-9"><a href="#annotated-cell-42-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="annotated-cell-42-10"><a href="#annotated-cell-42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-42-11"><a href="#annotated-cell-42-11" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="annotated-cell-42-12"><a href="#annotated-cell-42-12" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline</span><span class="op">.</span><span class="va">indent</span> <span class="op">=</span> <span class="st">''</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-42" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-42" data-code-lines="8" data-code-annotation="1">As the name suggests, <code>inline_spacer</code> controls how generous the spacing is for the inline version of a set of formatting options.</span>
</dd>
</dl>
<p>Here’s how we use that new formatting field:</p>
<div class="sourceCode" id="annotated-cell-43"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-43-1"><a href="#annotated-cell-43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-43-2"><a href="#annotated-cell-43-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-43-3"><a href="#annotated-cell-43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-43-4"><a href="#annotated-cell-43-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tb</span><span class="op">,</span> <span class="va">te</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-43-5"><a href="#annotated-cell-43-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<span id="annotated-cell-43-6"><a href="#annotated-cell-43-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span></span>
<span id="annotated-cell-43-7"><a href="#annotated-cell-43-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-43-8"><a href="#annotated-cell-43-8" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-43" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-43-9" class="code-annotation-target"><a href="#annotated-cell-43-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span> <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-43-10"><a href="#annotated-cell-43-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span> <span class="op">=</span> <span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-43-11"><a href="#annotated-cell-43-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">tb</span>  <span class="op">=</span> <span class="va">tb</span>  <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-43-12"><a href="#annotated-cell-43-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">te</span>  <span class="op">=</span> <span class="va">nl</span>  <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-43-13"><a href="#annotated-cell-43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-43-14"><a href="#annotated-cell-43-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-43-15"><a href="#annotated-cell-43-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-43-16"><a href="#annotated-cell-43-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span></span>
<span id="annotated-cell-43-17"><a href="#annotated-cell-43-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="kw">and</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="kw">or</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-43-18"><a href="#annotated-cell-43-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span> <span class="op">..</span> <span class="va">sep</span></span>
<span id="annotated-cell-43-19"><a href="#annotated-cell-43-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-43-20"><a href="#annotated-cell-43-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-43-21"><a href="#annotated-cell-43-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-43" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-43" data-code-lines="9" data-code-annotation="1">If there is an indentation, then <code>nl</code> is a newline character; otherwise its the user-configurable spacer.</span>
</dd>
</dl>
<p>Finally, we add a couple of convenience functions that package <code>table_string</code> with a specific set of options:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> pretty<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">return</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> inline<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">options</span><span class="op">.</span><span class="va">inline</span><span class="op">)</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For example, <code>print(inline(mouse))</code> now returns:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>{ last = Mouse, first = Minnie, }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>print(pretty(mouse))</code> returns:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    last = Mouse,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    first = Minnie,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="admonition tip">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-tip" title="Tip"></i></td>
    <td class="content">
    
Adding small facade functions like <code>pretty</code> and <code>inline</code> can make the API more user-friendly. Providing a few of these functions for everyday use cases is a good idea.
</td></tr></tbody></table></div>
</section>
<section id="the-comma-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-comma-problem">The Comma Problem</h2>
<p>It’s time to eliminate the “comma” problem, which is done by not adding the element separator after the last element.</p>
<p>Let’s start with Lua <em>arrays</em>, which are tables you can iterate through using indices:</p>
<div class="sourceCode" id="annotated-cell-47"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-47" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-47-1" class="code-annotation-target"><a href="#annotated-cell-47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="op">#</span><span class="va">tbl</span> <span class="cf">do</span></span>
<span id="annotated-cell-47-2"><a href="#annotated-cell-47-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-47-3"><a href="#annotated-cell-47-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-47" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-47" data-code-lines="1" data-code-annotation="1"><code>#tbl</code> is a built-in Lua function that returns the number of elements in the <em>array</em> part of <code>tbl</code>.</span>
</dd>
</dl>
<p>For arrays, we always know when we are at the last element.</p>
<p>We can replace the line that looks like this:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span> <span class="op">..</span> <span class="va">sep</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>with</p>
<div class="sourceCode" id="annotated-cell-49"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-49-1"><a href="#annotated-cell-49-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-49-2"><a href="#annotated-cell-49-2" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-49" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-49-3" class="code-annotation-target"><a href="#annotated-cell-49-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span> <span class="op">&lt;</span> <span class="op">#</span><span class="va">tbl</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-49-4"><a href="#annotated-cell-49-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-49" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-49" data-code-lines="3" data-code-annotation="1">We are using <code>i</code> as the current element index, and if we’re at the end of the array, we avoid adding a separator.</span>
</dd>
</dl>
<p>However, we want to handle all Lua tables, which may or may not be arrays. Unfortunately, we cannot rely on <code>#tbl</code> to return the number of elements in a general <code>tbl</code>. If we have the Lua array of strings:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">friends</span> <span class="op">=</span> <span class="op">{</span> <span class="st">"Mickey"</span><span class="op">,</span> <span class="st">"Goofy"</span> <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then <code>#friends</code> will return <code>2.</code></p>
<p>If, instead, we have a general table that happens to have some key-value elements like:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">mouse_in_characters</span> <span class="op">=</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'a'</span><span class="op">,</span> <span class="st">'b'</span><span class="op">,</span> <span class="va">first</span> <span class="op">=</span> <span class="st">"Minnie"</span><span class="op">,</span> <span class="va">last</span> <span class="op">=</span> <span class="st">"Mouse"</span><span class="op">,</span> <span class="st">'c'</span><span class="op">,</span> <span class="st">'d'</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then <code>#mouse_in_characters</code> returns <code>4</code>!</p>
<p>Even though we have deliberately written <code>mouse_in_characters</code> as a couple of key-value elements <em>surrounded</em> by straight array elements, Lua will aggregate the array elements <code>{a, b, c, d}</code> into an array part for the table and, under the covers, keep the two key-value elements in a separate hash map. If you try:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="op">#</span><span class="va">mouse_in_characters</span> <span class="cf">do</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span><span class="op">(</span><span class="va">mouse_in_characters</span><span class="op">[</span><span class="va">i</span><span class="op">])</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Out pops:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>a</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>b</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>c</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We cannot access the “dictionary” part of the table this way!</p>
<div class="admonition caution">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-caution" title="Caution"></i></td>
    <td class="content">
    
Lua tables can be arrays, dictionaries, or both in a single instance! This makes Lua tables very flexible, but it can also be a source of confusion. I suspect it wasn’t a great design decision, as it makes it harder to write general-purpose functions that work with arrays and dictionaries, which are very different data structures. It is what it is, and we must work with it.
</td></tr></tbody></table></div>
<section id="using-an-extra-pass" class="level3">
<h3 class="anchored" data-anchor-id="using-an-extra-pass">Using an Extra Pass</h3>
<p>However, we know that the <code>pairs</code> function will access <strong>all</strong> the table elements:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span>  <span class="fu">pairs</span><span class="op">(</span><span class="va">mouse_in_characters</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span><span class="op">(</span><span class="st">'key'</span><span class="op">,</span> <span class="va">k</span><span class="op">,</span> <span class="st">'value'</span><span class="op">,</span> <span class="va">v</span><span class="op">)</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Yields</p>
<div class="sourceCode" id="annotated-cell-55"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-55" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-55-1" class="code-annotation-target"><a href="#annotated-cell-55-1" aria-hidden="true" tabindex="-1"></a>key 1       value   a</span>
<span id="annotated-cell-55-2"><a href="#annotated-cell-55-2" aria-hidden="true" tabindex="-1"></a>key 2       value   b</span>
<span id="annotated-cell-55-3"><a href="#annotated-cell-55-3" aria-hidden="true" tabindex="-1"></a>key 3       value   c</span>
<span id="annotated-cell-55-4"><a href="#annotated-cell-55-4" aria-hidden="true" tabindex="-1"></a>key 4       value   d</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-55" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-55-5" class="code-annotation-target"><a href="#annotated-cell-55-5" aria-hidden="true" tabindex="-1"></a>key last    value   Mouse</span>
<span id="annotated-cell-55-6"><a href="#annotated-cell-55-6" aria-hidden="true" tabindex="-1"></a>key first   value   Minnie</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-55" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-55" data-code-lines="1" data-code-annotation="1">The “array” elements will always come first and always in the natural order.</span>
</dd>
<dt data-target-cell="annotated-cell-55" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-55" data-code-lines="5" data-code-annotation="2">The general key-value elements come next but in an undefined order that changes from run to run.</span>
</dd>
</dl>
<p>So, for the price of an extra pass, we can compute the number of elements in <em>any</em> table:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> table_size<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span><span class="cn">_</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span> <span class="va">size</span> <span class="op">=</span> <span class="va">size</span> <span class="op">+</span> <span class="dv">1</span> <span class="cf">end</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">size</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then <code>print(table_size(mouse_in_characters))</code> will return <code>6</code>.</p>
<p>We can use <code>table_size</code> in our <code>table_string</code> function:</p>
<div class="sourceCode" id="annotated-cell-57"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-57-1"><a href="#annotated-cell-57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-57-2"><a href="#annotated-cell-57-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-57-3"><a href="#annotated-cell-57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-57-4"><a href="#annotated-cell-57-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tb</span><span class="op">,</span> <span class="va">te</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-57-5"><a href="#annotated-cell-57-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<span id="annotated-cell-57-6"><a href="#annotated-cell-57-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span></span>
<span id="annotated-cell-57-7"><a href="#annotated-cell-57-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-57-8"><a href="#annotated-cell-57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-57-9"><a href="#annotated-cell-57-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span> <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-57-10"><a href="#annotated-cell-57-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span> <span class="op">=</span> <span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-57-11"><a href="#annotated-cell-57-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">tb</span>  <span class="op">=</span> <span class="va">tb</span>  <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-57-12"><a href="#annotated-cell-57-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">te</span>  <span class="op">=</span> <span class="va">nl</span>  <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-57-13"><a href="#annotated-cell-57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-57-14"><a href="#annotated-cell-57-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-57-15" class="code-annotation-target"><a href="#annotated-cell-57-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">i</span><span class="op">,</span> <span class="va">size</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> table_size<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-57-16"><a href="#annotated-cell-57-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-57-17" class="code-annotation-target"><a href="#annotated-cell-57-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-57-18"><a href="#annotated-cell-57-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span></span>
<span id="annotated-cell-57-19"><a href="#annotated-cell-57-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="kw">and</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="kw">or</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-57-20"><a href="#annotated-cell-57-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-57" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-57-21" class="code-annotation-target"><a href="#annotated-cell-57-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-57-22"><a href="#annotated-cell-57-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-57-23"><a href="#annotated-cell-57-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-57-24"><a href="#annotated-cell-57-24" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-57" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="15" data-code-annotation="1"><code>i</code>’ is the current element index running from <code>1</code> to <code>size</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="17" data-code-annotation="2">Increment the element “index”.</span>
</dd>
<dt data-target-cell="annotated-cell-57" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-57" data-code-lines="21" data-code-annotation="3">Add the separator if we are not at the last element.</span>
</dd>
</dl>
<p>With this version:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span>pretty<span class="op">(</span><span class="va">mouse</span><span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Yields:</p>
<div class="sourceCode" id="annotated-cell-59"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-59-1"><a href="#annotated-cell-59-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="annotated-cell-59-2"><a href="#annotated-cell-59-2" aria-hidden="true" tabindex="-1"></a>    first = Minnie,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-59" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-59-3" class="code-annotation-target"><a href="#annotated-cell-59-3" aria-hidden="true" tabindex="-1"></a>    last = Mouse</span>
<span id="annotated-cell-59-4"><a href="#annotated-cell-59-4" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-59" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-59" data-code-lines="3" data-code-annotation="1">Yeah! That extra comma is gone!</span>
</dd>
</dl>
<p><code>print(inline(mouse))</code> is also correct:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>{ first = Minnie, last = Mouse }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="using-a-guard" class="level3">
<h3 class="anchored" data-anchor-id="using-a-guard">Using a Guard</h3>
<p>Using the <code>table_size</code> function means we make an extra pass through the table.</p>
<p>We can avoid the extra pass by using a guard variable. While we cannot know when we are at the last element, we <em>do</em> know when we are at the first element. All elements except the first element have a preceding element separator. With that in mind, we can rearrange the main loop in <code>table_string</code>:</p>
<div class="sourceCode" id="annotated-cell-61"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-61-1"><a href="#annotated-cell-61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-61-2"><a href="#annotated-cell-61-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-61-3"><a href="#annotated-cell-61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-61-4"><a href="#annotated-cell-61-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tb</span><span class="op">,</span> <span class="va">te</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-61-5"><a href="#annotated-cell-61-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<span id="annotated-cell-61-6"><a href="#annotated-cell-61-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span></span>
<span id="annotated-cell-61-7"><a href="#annotated-cell-61-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-61-8"><a href="#annotated-cell-61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-61-9"><a href="#annotated-cell-61-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span> <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-61-10"><a href="#annotated-cell-61-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span> <span class="op">=</span> <span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-61-11"><a href="#annotated-cell-61-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">tb</span>  <span class="op">=</span> <span class="va">tb</span>  <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-61-12"><a href="#annotated-cell-61-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">te</span>  <span class="op">=</span> <span class="va">nl</span>  <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-61-13"><a href="#annotated-cell-61-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-61-14"><a href="#annotated-cell-61-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-61" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-61-15" class="code-annotation-target"><a href="#annotated-cell-61-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">first_element</span> <span class="op">=</span> <span class="kw">true</span></span>
<span id="annotated-cell-61-16"><a href="#annotated-cell-61-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-61" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-61-17" class="code-annotation-target"><a href="#annotated-cell-61-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">first_element</span> <span class="cf">then</span> <span class="va">first_element</span> <span class="op">=</span> <span class="kw">false</span> <span class="cf">else</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-61-18"><a href="#annotated-cell-61-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span></span>
<span id="annotated-cell-61-19"><a href="#annotated-cell-61-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="kw">and</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="kw">or</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-61-20"><a href="#annotated-cell-61-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-61-21"><a href="#annotated-cell-61-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-61-22"><a href="#annotated-cell-61-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-61-23"><a href="#annotated-cell-61-23" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-61" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-61" data-code-lines="15" data-code-annotation="1">We initialize <code>first_element</code> to <code>true</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-61" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-61" data-code-lines="17" data-code-annotation="2">If we’re not at the first element, we start by adding an element-end delimiter before the current element.</span>
</dd>
</dl>
<div class="admonition note">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-note" title="Note"></i></td>
    <td class="content">
    
This is a common idiom in Lua for handling iterations where you must do something special for the final element. Instead, you do something special for the first element and then do the usual thing for all subsequent elements.
</td></tr></tbody></table></div>
<p>This code version avoids the extra pass and still eliminates the trailing comma.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span>pretty<span class="op">(</span><span class="va">mouse</span><span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Yields:</p>
<div class="sourceCode" id="annotated-cell-63"><pre class="sourceCode txt code-annotation-code code-with-copy"><code class="sourceCode default"><span id="annotated-cell-63-1"><a href="#annotated-cell-63-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="annotated-cell-63-2"><a href="#annotated-cell-63-2" aria-hidden="true" tabindex="-1"></a>    first = Minnie,</span>
<span id="annotated-cell-63-3"><a href="#annotated-cell-63-3" aria-hidden="true" tabindex="-1"></a>    last = Mouse</span>
<span id="annotated-cell-63-4"><a href="#annotated-cell-63-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="admonition note">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-note" title="Note"></i></td>
    <td class="content">
    
Computing the size of <code>tbl</code> does require an extra pass. However, as we shall see shortly, we can use that pass to gather other useful information, so we are happy enough to pay the price of some extra compute cycles.
</td></tr></tbody></table></div>
</section>
<section id="empty-tables" class="level3">
<h3 class="anchored" data-anchor-id="empty-tables">Empty Tables</h3>
<p>We have one more issue to address. <code>print(pretty({}))</code> returns:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>print(inline({}))</code> returns:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>{   }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We would prefer to see <code>{}</code> in both cases. If we know the size of <code>tbl</code>, then we can add a quick check for an early return at the top of the function,</p>
<div class="sourceCode" id="annotated-cell-66"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-66" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-66-1" class="code-annotation-target"><a href="#annotated-cell-66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-66" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-66-2" class="code-annotation-target"><a href="#annotated-cell-66-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">retval</span> <span class="op">=</span> <span class="op">(</span><span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span> <span class="op">..</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span><span class="op">):</span><span class="fu">gsub</span><span class="op">(</span><span class="st">'%s+'</span><span class="op">,</span> <span class="st">''</span><span class="op">)</span></span>
<span id="annotated-cell-66-3"><a href="#annotated-cell-66-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-66-4"><a href="#annotated-cell-66-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-66-5"><a href="#annotated-cell-66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-66-6"><a href="#annotated-cell-66-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-66-7"><a href="#annotated-cell-66-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-66-8"><a href="#annotated-cell-66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-66-9"><a href="#annotated-cell-66-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span> <span class="op">=</span> table_size<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-66" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-66-10" class="code-annotation-target"><a href="#annotated-cell-66-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">size</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">then</span> <span class="cf">return</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-66-11"><a href="#annotated-cell-66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-66-12"><a href="#annotated-cell-66-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tb</span><span class="op">,</span> <span class="va">te</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-66-13"><a href="#annotated-cell-66-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<span id="annotated-cell-66-14"><a href="#annotated-cell-66-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span></span>
<span id="annotated-cell-66-15"><a href="#annotated-cell-66-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-66-16"><a href="#annotated-cell-66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-66-17"><a href="#annotated-cell-66-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span> <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-66-18"><a href="#annotated-cell-66-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span> <span class="op">=</span> <span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-66-19"><a href="#annotated-cell-66-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">tb</span>  <span class="op">=</span> <span class="va">tb</span>  <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-66-20"><a href="#annotated-cell-66-20" aria-hidden="true" tabindex="-1"></a>    <span class="va">te</span>  <span class="op">=</span> <span class="va">nl</span>  <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-66-21"><a href="#annotated-cell-66-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-66-22"><a href="#annotated-cell-66-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-66-23"><a href="#annotated-cell-66-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-66-24"><a href="#annotated-cell-66-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-66-25"><a href="#annotated-cell-66-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span></span>
<span id="annotated-cell-66-26"><a href="#annotated-cell-66-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="kw">and</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="kw">or</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-66-27"><a href="#annotated-cell-66-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-66-28"><a href="#annotated-cell-66-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-66-29"><a href="#annotated-cell-66-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-66-30"><a href="#annotated-cell-66-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-66-31"><a href="#annotated-cell-66-31" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-66" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-66" data-code-lines="1" data-code-annotation="1">We add a helper function to return a string for an empty table, taking into account the table delimiters.</span>
</dd>
<dt data-target-cell="annotated-cell-66" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-66" data-code-lines="2" data-code-annotation="2">It does that by concatenating the table delimiters and then using <code>gsub</code> to remove all whitespace.</span>
</dd>
<dt data-target-cell="annotated-cell-66" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-66" data-code-lines="10" data-code-annotation="3">In our <code>table_string</code> function we look for an early exit for empty tables.</span>
</dd>
</dl>
<p>With this change in place, <code>print(pretty({}))</code> and <code>print(inline({}))</code> both return <code>{}</code>.</p>
</section>
</section>
<section id="arrays-vs.-tables" class="level2">
<h2 class="anchored" data-anchor-id="arrays-vs.-tables">Arrays vs.&nbsp;Tables</h2>
<p>Lua has one type of table. It can be an array, a dictionary, or a mix of both. Under the covers, Lua keeps the array part separate from the dictionary part for efficiency.</p>
<p>Most programming languages have a distinct array type, and differentiating between arrays and dictionaries is often crucial.</p>
<p>For example, JSON is a popular human-readable data exchange format with a separate array type. In JSON, arrays are always ordered and have implicit keys that are consecutive integers. They are represented by square brackets <code>[ ... ]</code> to distinguish them from dictionaries represented by curly braces <code>{ ... }</code>.</p>
<p>We can easily write a small function to determine whether a table is an array or a dictionary:</p>
<div class="sourceCode" id="annotated-cell-67"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-67-1"><a href="#annotated-cell-67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> table_is_array<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-67-2"><a href="#annotated-cell-67-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-67-3"><a href="#annotated-cell-67-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span><span class="cn">_</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-67-4"><a href="#annotated-cell-67-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">size</span> <span class="op">=</span> <span class="va">size</span> <span class="op">+</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-67-5" class="code-annotation-target"><a href="#annotated-cell-67-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">tbl</span><span class="op">[</span><span class="va">size</span><span class="op">]</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="cf">return</span> <span class="kw">false</span> <span class="cf">end</span></span>
<span id="annotated-cell-67-6"><a href="#annotated-cell-67-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-67" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-67-7" class="code-annotation-target"><a href="#annotated-cell-67-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span></span>
<span id="annotated-cell-67-8"><a href="#annotated-cell-67-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-67" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-67" data-code-lines="5" data-code-annotation="1">Arrays are indexed by consecutive integers from 1. If we find a hole, we know that <code>tbl</code> is not an array.</span>
</dd>
<dt data-target-cell="annotated-cell-67" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-67" data-code-lines="7" data-code-annotation="2">If we make it through the loop without finding a hole, we know that <code>tbl</code> is an array.</span>
</dd>
</dl>
<p>If <code>tbl</code> is a Lua array, a complete pass through <code>tbl</code> is required to confirm it is an array. We can add the check to our existing <code>table_size</code> function, which we rename <code>metadata</code>:</p>
<div class="sourceCode" id="annotated-cell-68"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-68-1"><a href="#annotated-cell-68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-68-2"><a href="#annotated-cell-68-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span> <span class="op">=</span> <span class="dv">0</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-68" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-68-3" class="code-annotation-target"><a href="#annotated-cell-68-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">array</span> <span class="op">=</span> <span class="kw">true</span></span>
<span id="annotated-cell-68-4"><a href="#annotated-cell-68-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span><span class="cn">_</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-68-5"><a href="#annotated-cell-68-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">size</span> <span class="op">=</span> <span class="va">size</span> <span class="op">+</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-68" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-68-6" class="code-annotation-target"><a href="#annotated-cell-68-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">tbl</span><span class="op">[</span><span class="va">size</span><span class="op">]</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="va">array</span> <span class="op">=</span> <span class="kw">false</span> <span class="cf">end</span></span>
<span id="annotated-cell-68-7"><a href="#annotated-cell-68-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-68" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-68-8" class="code-annotation-target"><a href="#annotated-cell-68-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span></span>
<span id="annotated-cell-68-9"><a href="#annotated-cell-68-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-68" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-68" data-code-lines="3" data-code-annotation="1">We assume <code>tbl</code> is an array until we find otherwise.</span>
</dd>
<dt data-target-cell="annotated-cell-68" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-68" data-code-lines="6" data-code-annotation="2">If we find a “hole”, then <code>tbl</code> is not an array.</span>
</dd>
<dt data-target-cell="annotated-cell-68" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-68" data-code-lines="8" data-code-annotation="3">Return both the computed <code>size</code> and <code>array</code> values.</span>
</dd>
</dl>
<div class="admonition note">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-note" title="Note"></i></td>
    <td class="content">
    
Lua functions can return multiple values. This feature can be handy, but you don’t want to overdo it, as the function’s caller needs to get the order of the returned values right. Correct ordering is not a problem for two or even three values. After that, it is best to put the returns in a name-value table.
</td></tr></tbody></table></div>
<div class="admonition note">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-note" title="Note"></i></td>
    <td class="content">
    
We use <code>metadata</code> to indicate that we are returning more than the table size. We will add other bits of metadata as we go along. Do not confuse this with Lua’s <code>metatable</code> concept, which allows you to override the behaviour standard operators like <code>+</code>, <code>-</code>, etc. and the behaviour of methods like <code>tostring</code>, <code>print</code>, etc.
</td></tr></tbody></table></div>
<p>We can add some array delimiters to our option tables:</p>
<div class="sourceCode" id="annotated-cell-69"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-69-1"><a href="#annotated-cell-69-1" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">pretty</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="annotated-cell-69-2"><a href="#annotated-cell-69-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>        <span class="op">=</span> <span class="st">'    '</span><span class="op">,</span></span>
<span id="annotated-cell-69-3"><a href="#annotated-cell-69-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_begin</span>   <span class="op">=</span> <span class="st">'{'</span><span class="op">,</span></span>
<span id="annotated-cell-69-4"><a href="#annotated-cell-69-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_end</span>     <span class="op">=</span> <span class="st">'}'</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-69" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-69-5" class="code-annotation-target"><a href="#annotated-cell-69-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_begin</span>   <span class="op">=</span> <span class="st">'['</span><span class="op">,</span></span>
<span id="annotated-cell-69-6"><a href="#annotated-cell-69-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_end</span>     <span class="op">=</span> <span class="st">']'</span><span class="op">,</span></span>
<span id="annotated-cell-69-7"><a href="#annotated-cell-69-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_begin</span>     <span class="op">=</span> <span class="st">''</span><span class="op">,</span></span>
<span id="annotated-cell-69-8"><a href="#annotated-cell-69-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_end</span>       <span class="op">=</span> <span class="st">' = '</span><span class="op">,</span></span>
<span id="annotated-cell-69-9"><a href="#annotated-cell-69-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span>           <span class="op">=</span> <span class="st">','</span><span class="op">,</span></span>
<span id="annotated-cell-69-10"><a href="#annotated-cell-69-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_spacer</span> <span class="op">=</span> <span class="st">' '</span></span>
<span id="annotated-cell-69-11"><a href="#annotated-cell-69-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-69" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-69" data-code-lines="5" data-code-annotation="1">We will differentiate arrays by using square bracket delimiters.</span>
</dd>
</dl>
<p>Let’s put the new <code>metadata</code> method to use in the main event:</p>
<div class="sourceCode" id="annotated-cell-70"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-70-1"><a href="#annotated-cell-70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-70-2"><a href="#annotated-cell-70-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-70-3"><a href="#annotated-cell-70-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-70" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-70-4" class="code-annotation-target"><a href="#annotated-cell-70-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-70-5"><a href="#annotated-cell-70-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">size</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">then</span> <span class="cf">return</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-70-6"><a href="#annotated-cell-70-6" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-70" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-70-7" class="code-annotation-target"><a href="#annotated-cell-70-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tb</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_begin</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span></span>
<span id="annotated-cell-70-8"><a href="#annotated-cell-70-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">te</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_end</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-70-9"><a href="#annotated-cell-70-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<span id="annotated-cell-70-10"><a href="#annotated-cell-70-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span></span>
<span id="annotated-cell-70-11"><a href="#annotated-cell-70-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-70-12"><a href="#annotated-cell-70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-70-13"><a href="#annotated-cell-70-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span> <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-70-14"><a href="#annotated-cell-70-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span> <span class="op">=</span> <span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-70-15"><a href="#annotated-cell-70-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">tb</span>  <span class="op">=</span> <span class="va">tb</span>  <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-70-16"><a href="#annotated-cell-70-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">te</span>  <span class="op">=</span> <span class="va">nl</span>  <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-70-17"><a href="#annotated-cell-70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-70-18"><a href="#annotated-cell-70-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-70-19"><a href="#annotated-cell-70-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-70-20"><a href="#annotated-cell-70-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-70-21"><a href="#annotated-cell-70-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-70-22"><a href="#annotated-cell-70-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span></span>
<span id="annotated-cell-70-23"><a href="#annotated-cell-70-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="kw">and</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="kw">or</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-70-24"><a href="#annotated-cell-70-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-70-25"><a href="#annotated-cell-70-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-70-26"><a href="#annotated-cell-70-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-70-27"><a href="#annotated-cell-70-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-70-28"><a href="#annotated-cell-70-28" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-70" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-70" data-code-lines="4" data-code-annotation="1"><code>metadata</code> returns the size <em>and</em> the type <code>tbl</code>. <br> The order is fixed.</span>
</dd>
<dt data-target-cell="annotated-cell-70" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-70" data-code-lines="7" data-code-annotation="2">We can pick suitable table delimiters depending on whether <code>tbl</code> is an array.</span>
</dd>
</dl>
<p>Now <code>print(pretty(mouse))</code> returns:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    last = Mouse,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    first = Minnie</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>while <code>print(pretty(friends))</code> returns:</p>
<div class="sourceCode" id="annotated-cell-72"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-72" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-72-1" class="code-annotation-target"><a href="#annotated-cell-72-1" aria-hidden="true" tabindex="-1"></a>[</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-72" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-72-2" class="code-annotation-target"><a href="#annotated-cell-72-2" aria-hidden="true" tabindex="-1"></a>    1 = Mickey,</span>
<span id="annotated-cell-72-3"><a href="#annotated-cell-72-3" aria-hidden="true" tabindex="-1"></a>    2 = Goofy</span>
<span id="annotated-cell-72-4"><a href="#annotated-cell-72-4" aria-hidden="true" tabindex="-1"></a>]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-72" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-72" data-code-lines="1" data-code-annotation="1">Arrays are now delimited with square brackets.</span>
</dd>
<dt data-target-cell="annotated-cell-72" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-72" data-code-lines="2" data-code-annotation="2">However, we are outputting the array indices <code>1</code>, <code>2</code>, <code>...</code>, which is generally unnecessary.</span>
</dd>
</dl>
<p>Lua has “keys” for <em>all</em> table elements. In the case of arrays, those keys are the array indices, which are consecutive integers starting at 1. You don’t usually need to see those, so we alter our function only to show keys if <code>tbl</code> is not an array.</p>
<div class="sourceCode" id="annotated-cell-73"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-73-1"><a href="#annotated-cell-73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-73-2"><a href="#annotated-cell-73-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-73-3"><a href="#annotated-cell-73-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-73-4"><a href="#annotated-cell-73-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-73" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-73-5" class="code-annotation-target"><a href="#annotated-cell-73-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">array</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="cf">end</span></span>
<span id="annotated-cell-73-6"><a href="#annotated-cell-73-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-73-7"><a href="#annotated-cell-73-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-73-8"><a href="#annotated-cell-73-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-73-9"><a href="#annotated-cell-73-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-73-10"><a href="#annotated-cell-73-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-73" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-73" data-code-lines="5" data-code-annotation="1">Now, we don’t show keys for array tables.</span>
</dd>
</dl>
<p>Now <code>print(pretty(friends))</code> returns:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    Mickey,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    Goofy</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output from <code>print(pretty(mouse))</code> remains unchanged:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    last = Mouse,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    first = Minnie</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Sometimes, you need to see the “keys:” for an array. For example, if you are debugging and want to see the array indices. Let’s add an option to show the keys for arrays:</p>
<div class="sourceCode" id="annotated-cell-76"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-76-1"><a href="#annotated-cell-76-1" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">pretty</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="annotated-cell-76-2"><a href="#annotated-cell-76-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>        <span class="op">=</span> <span class="st">'    '</span><span class="op">,</span></span>
<span id="annotated-cell-76-3"><a href="#annotated-cell-76-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_begin</span>   <span class="op">=</span> <span class="st">'{'</span><span class="op">,</span></span>
<span id="annotated-cell-76-4"><a href="#annotated-cell-76-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_end</span>     <span class="op">=</span> <span class="st">'}'</span><span class="op">,</span></span>
<span id="annotated-cell-76-5"><a href="#annotated-cell-76-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_begin</span>   <span class="op">=</span> <span class="st">'['</span><span class="op">,</span></span>
<span id="annotated-cell-76-6"><a href="#annotated-cell-76-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_end</span>     <span class="op">=</span> <span class="st">']'</span><span class="op">,</span></span>
<span id="annotated-cell-76-7"><a href="#annotated-cell-76-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_begin</span>     <span class="op">=</span> <span class="st">''</span><span class="op">,</span></span>
<span id="annotated-cell-76-8"><a href="#annotated-cell-76-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_end</span>       <span class="op">=</span> <span class="st">' = '</span><span class="op">,</span></span>
<span id="annotated-cell-76-9"><a href="#annotated-cell-76-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span>           <span class="op">=</span> <span class="st">','</span><span class="op">,</span></span>
<span id="annotated-cell-76-10"><a href="#annotated-cell-76-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_spacer</span> <span class="op">=</span> <span class="st">' '</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-76" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-76-11" class="code-annotation-target"><a href="#annotated-cell-76-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">show_indices</span>  <span class="op">=</span> <span class="kw">false</span></span>
<span id="annotated-cell-76-12"><a href="#annotated-cell-76-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-76" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-76" data-code-lines="11" data-code-annotation="1">Typically, we suppress seeing array indices.</span>
</dd>
</dl>
<p>The corresponding change to <code>table_string</code> is straightforward:</p>
<div class="sourceCode" id="annotated-cell-77"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-77-1"><a href="#annotated-cell-77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-77-2"><a href="#annotated-cell-77-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-77-3"><a href="#annotated-cell-77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-77-4"><a href="#annotated-cell-77-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-77-5"><a href="#annotated-cell-77-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">size</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">then</span> <span class="cf">return</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-77" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-77-6" class="code-annotation-target"><a href="#annotated-cell-77-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">show_keys</span> <span class="op">=</span> <span class="kw">not</span> <span class="va">array</span> <span class="kw">and</span> <span class="kw">true</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">show_indices</span></span>
<span id="annotated-cell-77-7"><a href="#annotated-cell-77-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-77-8"><a href="#annotated-cell-77-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-77-9"><a href="#annotated-cell-77-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-77" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-77-10" class="code-annotation-target"><a href="#annotated-cell-77-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="annotated-cell-77-11"><a href="#annotated-cell-77-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-77-12"><a href="#annotated-cell-77-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-77-13"><a href="#annotated-cell-77-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-77-14"><a href="#annotated-cell-77-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-77-15"><a href="#annotated-cell-77-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-77" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-77" data-code-lines="6" data-code-annotation="1">We set <code>show_keys</code> to <code>true</code> unless we are dealing with an array, in which case we use whatever is dictated by <code>opts.show_indices</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-77" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-77" data-code-lines="10" data-code-annotation="2">We only show keys if <code>show_keys</code> is <code>true</code>. <br> That is always the case for non-arrays and is user-settable for arrays.</span>
</dd>
</dl>
<p>With that change, <code>print(inline(friends))</code> returns <code>[ Mickey, Goofy ]</code>. If you set <code>opts.show_indices = true</code>, then <code>print(inline(friends))</code> returns <code>[ 1 = Mickey, 2 = Goofy ]</code>.</p>
<p>Finally, let’s add a couple of sets of formatting options that <em>don’t</em> include separate array delimiters. This is the style you most often see in Lua code, so it is handy to have it available.</p>
<div class="sourceCode" id="annotated-cell-78"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-78-1"><a href="#annotated-cell-78-1" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">classic</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-78" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-78-2" class="code-annotation-target"><a href="#annotated-cell-78-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">classic</span><span class="op">.</span><span class="va">array_begin</span> <span class="op">=</span> <span class="st">'{'</span></span>
<span id="annotated-cell-78-3"><a href="#annotated-cell-78-3" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">classic</span><span class="op">.</span><span class="va">array_end</span>   <span class="op">=</span> <span class="st">'}'</span></span>
<span id="annotated-cell-78-4"><a href="#annotated-cell-78-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-78" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-78-5" class="code-annotation-target"><a href="#annotated-cell-78-5" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> classic<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-78-6"><a href="#annotated-cell-78-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">options</span><span class="op">.</span><span class="va">classic</span><span class="op">)</span></span>
<span id="annotated-cell-78-7"><a href="#annotated-cell-78-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-78" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-78" data-code-lines="2" data-code-annotation="1">All tables use the same delimiters <code>{ ... }</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-78" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-78" data-code-lines="5" data-code-annotation="2">We add a convenience function, <code>classic</code>, that uses the <code>options.classic</code>.</span>
</dd>
</dl>
<p>Now <code>print(classic(friends))</code> returns</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    Mickey,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    Goofy</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="adding-indentation" class="level2">
<h2 class="anchored" data-anchor-id="adding-indentation">Adding Indentation</h2>
<p>Earlier, we alluded that while our solution does <em>something</em> for nested sub-tables by recursion, it certainly gets indentation screwed up in the process.</p>
<p>Suppose we introduce a table that captures Minnie’s “user profile” and try to print it:</p>
<div class="sourceCode" id="annotated-cell-80"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-80-1"><a href="#annotated-cell-80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">user</span> <span class="op">=</span></span>
<span id="annotated-cell-80-2"><a href="#annotated-cell-80-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="annotated-cell-80-3"><a href="#annotated-cell-80-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">first</span> <span class="op">=</span> <span class="st">"Minnie"</span><span class="op">,</span></span>
<span id="annotated-cell-80-4"><a href="#annotated-cell-80-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">last</span> <span class="op">=</span> <span class="st">"Mouse"</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-80" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-80-5" class="code-annotation-target"><a href="#annotated-cell-80-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">friends</span> <span class="op">=</span> <span class="op">{</span> <span class="st">"Mickey"</span><span class="op">,</span> <span class="st">"Goofy"</span> <span class="op">}</span></span>
<span id="annotated-cell-80-6"><a href="#annotated-cell-80-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-80" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-80" data-code-lines="5" data-code-annotation="1">Minnie’s friends are captured in an array.</span>
</dd>
</dl>
<p>Then, <code>print(pretty(user))</code> might yield:</p>
<div class="sourceCode" id="annotated-cell-81"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-81-1"><a href="#annotated-cell-81-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="annotated-cell-81-2"><a href="#annotated-cell-81-2" aria-hidden="true" tabindex="-1"></a>    first = Minnie,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-81" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-81-3" class="code-annotation-target"><a href="#annotated-cell-81-3" aria-hidden="true" tabindex="-1"></a>    friends = [</span>
<span id="annotated-cell-81-4"><a href="#annotated-cell-81-4" aria-hidden="true" tabindex="-1"></a>    Mickey,</span>
<span id="annotated-cell-81-5"><a href="#annotated-cell-81-5" aria-hidden="true" tabindex="-1"></a>    Goofy</span>
<span id="annotated-cell-81-6"><a href="#annotated-cell-81-6" aria-hidden="true" tabindex="-1"></a>],</span>
<span id="annotated-cell-81-7"><a href="#annotated-cell-81-7" aria-hidden="true" tabindex="-1"></a>    last = Mouse</span>
<span id="annotated-cell-81-8"><a href="#annotated-cell-81-8" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-81" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-81" data-code-lines="3" data-code-annotation="1">We see <code>friends</code> as a nice array, but the indentation is incorrect.</span>
</dd>
</dl>
<p>Ideally, we’d like to see:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    friends = [</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>        Mickey,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        Goofy</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    first = Minnie,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    last = Mouse</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Our current output is readable but gets less and less with larger tables and more nesting. <em>Deeper</em> nesting requires more indentation! We better fix that next.</p>
<p>The most straightforward idea is to add indentation to the string returned from the recursive call <code>table_string(v, opts)</code>.</p>
<p>We can make a function that adds indentation <em>line-by-line</em> to any Lua string:</p>
<div class="sourceCode" id="annotated-cell-83"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-83-1"><a href="#annotated-cell-83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> indent_string<span class="op">(</span><span class="va">str</span><span class="op">,</span> <span class="va">indent</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-83" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-83-2" class="code-annotation-target"><a href="#annotated-cell-83-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">indent</span> <span class="kw">or</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">""</span> <span class="kw">or</span> <span class="kw">not</span> <span class="va">str</span> <span class="kw">or</span> <span class="va">str</span> <span class="op">==</span> <span class="st">""</span> <span class="cf">then</span> <span class="cf">return</span> <span class="va">str</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-83" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-83-3" class="code-annotation-target"><a href="#annotated-cell-83-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">ends_with_newline</span> <span class="op">=</span> <span class="va">str</span><span class="op">:</span><span class="fu">sub</span><span class="op">(-</span><span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="annotated-cell-83-4"><a href="#annotated-cell-83-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indented_str</span> <span class="op">=</span> <span class="st">""</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-83" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-83-5" class="code-annotation-target"><a href="#annotated-cell-83-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">first_line</span> <span class="op">=</span> <span class="kw">true</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-83" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-83-6" class="code-annotation-target"><a href="#annotated-cell-83-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">line</span> <span class="kw">in</span> <span class="va">str</span><span class="op">:</span><span class="fu">gmatch</span><span class="op">(</span><span class="st">"([^</span><span class="sc">\n</span><span class="st">]*)</span><span class="sc">\n</span><span class="st">?"</span><span class="op">)</span> <span class="cf">do</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-83" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-83-7" class="code-annotation-target"><a href="#annotated-cell-83-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">first_line</span> <span class="cf">then</span> <span class="va">indented_str</span> <span class="op">=</span> <span class="va">indented_str</span> <span class="op">..</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span> <span class="cf">end</span></span>
<span id="annotated-cell-83-8"><a href="#annotated-cell-83-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">indented_str</span> <span class="op">=</span> <span class="va">indented_str</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">line</span></span>
<span id="annotated-cell-83-9"><a href="#annotated-cell-83-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">first_line</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="annotated-cell-83-10"><a href="#annotated-cell-83-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-83" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-83-11" class="code-annotation-target"><a href="#annotated-cell-83-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">ends_with_newline</span> <span class="cf">then</span> <span class="va">indented_str</span> <span class="op">=</span> <span class="va">indented_str</span> <span class="op">..</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span> <span class="cf">end</span></span>
<span id="annotated-cell-83-12"><a href="#annotated-cell-83-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">indented_str</span></span>
<span id="annotated-cell-83-13"><a href="#annotated-cell-83-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-83" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-83" data-code-lines="2" data-code-annotation="1">Handle some edge cases, as we do not need to do anything if the <code>indent</code> is the empty string. This check allows downstream methods to call <code>indent_string</code> without worrying that it will do something stupid.</span>
</dd>
<dt data-target-cell="annotated-cell-83" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-83" data-code-lines="3" data-code-annotation="2">We will add the indentation line-by-line. If the input <code>str</code> ends with a new line, the output should also.</span>
</dd>
<dt data-target-cell="annotated-cell-83" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-83" data-code-lines="5" data-code-annotation="3">This looks like that guard “trick” we discussed earlier.</span>
</dd>
<dt data-target-cell="annotated-cell-83" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-83" data-code-lines="6" data-code-annotation="4">Here, we iterate through <code>str</code> line-by-line with an unknown number of hits using Lua’s pattern search function <code>gmatch</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-83" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-83" data-code-lines="7" data-code-annotation="5">Add newline characters to all <em>but</em> the first line.</span>
</dd>
<dt data-target-cell="annotated-cell-83" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-83" data-code-lines="11" data-code-annotation="6">Match the input — if it ends with a new line, the output will also.</span>
</dd>
</dl>
<section id="aside-lua-patterns" class="level3">
<h3 class="anchored" data-anchor-id="aside-lua-patterns">Aside: Lua Patterns</h3>
<p>The <code>gmatch</code> method added to the string class is another type of iterator. In this case, it looks for a <em>pattern</em> in the string <code>str</code> and returns the <em>next</em> match. When it can find no more matches, it returns <code>nil</code> and the iteration loop finishes.</p>
<p>Lua string patterns are like regular expressions in other languages, though they use fewer features. For example, if we have the string <code>"ho,  ho, ho"</code> then the pattern <code>"ho"</code> matches the literal character <code>'h'</code> followed immediately by <code>'o'</code>. We might use it like this:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">str</span> <span class="op">=</span> <span class="st">"ho, ho, ho"</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">count</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="cn">_</span> <span class="kw">in</span> <span class="va">str</span><span class="op">:</span><span class="fu">gmatch</span><span class="op">(</span><span class="st">"ho"</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">count</span> <span class="op">=</span> <span class="va">count</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span><span class="op">(</span><span class="st">"Found"</span><span class="op">,</span> <span class="va">count</span><span class="op">)</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That will output:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>Found 1</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>Found 2</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>Found 3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Of course, if <code>gmatch</code> and friends could only find literal matches, they wouldn’t be powerful enough for most applications. While Lua’s pattern-matching library is slim, fortunately, it’s not <em>that</em> slim. Lua patterns can encompass <em>classes</em> of characters instead of literal ones.</p>
<p>In the <code>indent_string</code> function, the pattern we successively match on is <code>"([^\n]*)\n?"</code>. This has many characteristic elements of a regular expression: it is terse and full of punctuation characters!</p>
<p>If you remove the parentheses, you have <code>"[^\n]*\n?"</code>. The first part <code>"[^\n]"</code> simply says to look for a substring that starts with <em>either</em> the beginning of the string (denoted by the magic character, the caret <code>'^'</code>) <em>or</em> the newline character <code>'\n'</code>. In patterns, you create “ors” with square brackets, so <code>"[xyz]"</code> will match on <code>'x'</code> <em>or</em> <code>'y'</code> <em>or</em> <code>'z'</code>. The next part, ’ “<em>?“<code>starts with another magic character</code>’</em>’<code>that matches *anything*. The</code>‘?’` is another magic incantation; in this case, it tells the pattern matcher that the previous character (the newline character) is optional.</p>
<p>In all, the `“[^\n]*?” pattern says to match on a substring that starts at the beginning of the string or a newline character and finishes when you hit a newline character or run out of string.</p>
<p>The only thing missing is telling the pattern-matching engine which bits of the pattern constitute the substring we want. What should the pattern matcher <em>capture</em>?</p>
<p>That is what the parentheses are used for. The engine will capture whatever you put inside parentheses. In this case, we have parentheses around the first bit <code>"([^\n]*)\n?"</code> so we capture everything from either the string start <em>or</em> a newline character <em>until</em> we hit a newline character or the end of the string. In other words, we capture a line in the string. The <code>g</code> in <code>gmatch</code> stands for “global,” so it doesn’t stop at the first line but keeps iterating through the whole string line by line.</p>
</section>
<section id="indenting-tables" class="level3">
<h3 class="anchored" data-anchor-id="indenting-tables">Indenting Tables</h3>
<p>With the <code>indent_string</code> method in place, we can rewrite our primary function:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> indent_string<span class="op">(</span><span class="va">v_string</span><span class="op">,</span> <span class="va">indent</span><span class="op">)</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With those changes, we can call <code>print(pretty(user))</code> and get:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    friends =     [</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>        Mickey,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>        Goofy</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    last = Mouse,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    first = Minnie</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The elements in the <code>friends</code> array are now indented correctly, but the opening brace is also indented.</p>
<p>We can alter our <code>indent_string</code> function to ignore the first line optionally:</p>
<div class="sourceCode" id="annotated-cell-88"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-88" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-88-1" class="code-annotation-target"><a href="#annotated-cell-88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> indent_string<span class="op">(</span><span class="va">str</span><span class="op">,</span> <span class="va">indent</span><span class="op">,</span> <span class="va">ignore_first_line</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-88" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-88-2" class="code-annotation-target"><a href="#annotated-cell-88-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">ignore_first_line</span> <span class="op">=</span> <span class="va">ignore_first_line</span> <span class="kw">or</span> <span class="kw">false</span></span>
<span id="annotated-cell-88-3"><a href="#annotated-cell-88-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">indent</span> <span class="kw">or</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">""</span> <span class="kw">or</span> <span class="kw">not</span> <span class="va">str</span> <span class="kw">or</span> <span class="va">str</span> <span class="op">==</span> <span class="st">""</span> <span class="cf">then</span> <span class="cf">return</span> <span class="va">str</span> <span class="cf">end</span></span>
<span id="annotated-cell-88-4"><a href="#annotated-cell-88-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">ends_with_newline</span> <span class="op">=</span> <span class="va">str</span><span class="op">:</span><span class="fu">sub</span><span class="op">(-</span><span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="annotated-cell-88-5"><a href="#annotated-cell-88-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indented_str</span> <span class="op">=</span> <span class="st">""</span></span>
<span id="annotated-cell-88-6"><a href="#annotated-cell-88-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">first_line</span> <span class="op">=</span> <span class="kw">true</span></span>
<span id="annotated-cell-88-7"><a href="#annotated-cell-88-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">line</span> <span class="kw">in</span> <span class="va">str</span><span class="op">:</span><span class="fu">gmatch</span><span class="op">(</span><span class="st">"([^</span><span class="sc">\n</span><span class="st">]*)</span><span class="sc">\n</span><span class="st">?"</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-88-8"><a href="#annotated-cell-88-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">first_line</span> <span class="cf">then</span> <span class="va">indented_str</span> <span class="op">=</span> <span class="va">indented_str</span> <span class="op">..</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span> <span class="cf">end</span></span>
<span id="annotated-cell-88-9"><a href="#annotated-cell-88-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">tab</span> <span class="op">=</span> <span class="va">first_line</span> <span class="kw">and</span> <span class="va">ignore_first_line</span> <span class="kw">and</span> <span class="st">''</span> <span class="kw">or</span> <span class="va">indent</span></span>
<span id="annotated-cell-88-10"><a href="#annotated-cell-88-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">indented_str</span> <span class="op">=</span> <span class="va">indented_str</span> <span class="op">..</span> <span class="va">tab</span> <span class="op">..</span> <span class="va">line</span></span>
<span id="annotated-cell-88-11"><a href="#annotated-cell-88-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">first_line</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="annotated-cell-88-12"><a href="#annotated-cell-88-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-88-13"><a href="#annotated-cell-88-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">ends_with_newline</span> <span class="cf">then</span> <span class="va">indented_str</span> <span class="op">=</span> <span class="va">indented_str</span> <span class="op">..</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span> <span class="cf">end</span></span>
<span id="annotated-cell-88-14"><a href="#annotated-cell-88-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">indented_str</span></span>
<span id="annotated-cell-88-15"><a href="#annotated-cell-88-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-88" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-88" data-code-lines="1" data-code-annotation="1">We have added an optional boolean parameter <code>ignore_first_line</code> to the function.</span>
</dd>
<dt data-target-cell="annotated-cell-88" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-88" data-code-lines="2" data-code-annotation="2">If the user doesn’t provide a value for <code>ignore_first_line</code>, we default to <code>false</code>.</span>
</dd>
</dl>
<p>With those changes, we can call <code>print(pretty(user))</code> and get:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    friends = [</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>        Mickey,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>        Goofy</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    last = Mouse,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    first = Minnie</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The inline format <code>print(inline(user))</code> is also correct:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>{ last = Mouse, first = Minnie, friends = [ Mickey, Goofy ] }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="other-output-formats" class="level2">
<h2 class="anchored" data-anchor-id="other-output-formats">Other Output Formats</h2>
<p>We will look at a few other formats commonly used for viewing tables.</p>
<section id="indentation-only" class="level3">
<h3 class="anchored" data-anchor-id="indentation-only">Indentation Only</h3>
<p>Another commonly used multiline table format avoids delimiters and instead relies on indentation to show the structure. Here is how our <code>user</code> table would look in this format:</p>
<div class="sourceCode" id="annotated-cell-91"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-91-1"><a href="#annotated-cell-91-1" aria-hidden="true" tabindex="-1"></a>last: Mouse,</span>
<span id="annotated-cell-91-2"><a href="#annotated-cell-91-2" aria-hidden="true" tabindex="-1"></a>first: Minnie,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-91" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-91-3" class="code-annotation-target"><a href="#annotated-cell-91-3" aria-hidden="true" tabindex="-1"></a>friends:</span>
<span id="annotated-cell-91-4"><a href="#annotated-cell-91-4" aria-hidden="true" tabindex="-1"></a>    Mickey,</span>
<span id="annotated-cell-91-5"><a href="#annotated-cell-91-5" aria-hidden="true" tabindex="-1"></a>    Goofy</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-91" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-91" data-code-lines="3" data-code-annotation="1">This all looks straightforward, but this format is tricky to implement.</span>
</dd>
</dl>
<p>We add a new set of formatting options for this format:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">alt</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">alt</span><span class="op">.</span><span class="va">table_begin</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">alt</span><span class="op">.</span><span class="va">table_end</span>   <span class="op">=</span> <span class="st">''</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">alt</span><span class="op">.</span><span class="va">array_begin</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">alt</span><span class="op">.</span><span class="va">array_end</span>   <span class="op">=</span> <span class="st">''</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">alt</span><span class="op">.</span><span class="va">key_end</span>     <span class="op">=</span> <span class="st">': '</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Nothing too wild here; we start with <code>options.pretty</code> and set the table/array delimiters to blank strings. We also set up colons to act as the assignment operators.</p>
<p>We also add the usual convenience function that packages those formatting options with <code>table_string</code>:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> alt<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">options</span><span class="op">.</span><span class="va">alt</span><span class="op">)</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we try <code>print(alt(user))</code> we get something like:</p>
<div class="sourceCode" id="annotated-cell-94"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-94" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-94-1" class="code-annotation-target"><a href="#annotated-cell-94-1" aria-hidden="true" tabindex="-1"></a>    first: Minnie,</span>
<span id="annotated-cell-94-2"><a href="#annotated-cell-94-2" aria-hidden="true" tabindex="-1"></a>    last: Mouse,</span>
<span id="annotated-cell-94-3"><a href="#annotated-cell-94-3" aria-hidden="true" tabindex="-1"></a>    friends:</span>
<span id="annotated-cell-94-4"><a href="#annotated-cell-94-4" aria-hidden="true" tabindex="-1"></a>        Mickey,</span>
<span id="annotated-cell-94-5"><a href="#annotated-cell-94-5" aria-hidden="true" tabindex="-1"></a> Goofy</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-94" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-94" data-code-lines="1" data-code-annotation="1">An extra indentation layer isn’t needed when the table delimiters are blank.</span>
</dd>
<dt data-target-cell="annotated-cell-94" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-94" data-code-lines="6" data-code-annotation="2">There are also some extra newlines at the end of the output.</span>
</dd>
</dl>
<p>A first attempt at fixing this format is to remove the indentation from the top-level elements. We can do this by adding a check for a blank table begin-delimiter:</p>
<div class="sourceCode" id="annotated-cell-95"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-95-1"><a href="#annotated-cell-95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-95-2"><a href="#annotated-cell-95-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-95-3"><a href="#annotated-cell-95-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-95-4"><a href="#annotated-cell-95-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-95-5"><a href="#annotated-cell-95-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">size</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">then</span> <span class="cf">return</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-95-6"><a href="#annotated-cell-95-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">show_keys</span> <span class="op">=</span> <span class="kw">not</span> <span class="va">array</span> <span class="kw">and</span> <span class="kw">true</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">show_indices</span></span>
<span id="annotated-cell-95-7"><a href="#annotated-cell-95-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-95-8"><a href="#annotated-cell-95-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tb</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_begin</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span></span>
<span id="annotated-cell-95-9"><a href="#annotated-cell-95-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">te</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_end</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-95-10"><a href="#annotated-cell-95-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<span id="annotated-cell-95-11"><a href="#annotated-cell-95-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span></span>
<span id="annotated-cell-95-12"><a href="#annotated-cell-95-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-95-13"><a href="#annotated-cell-95-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span>     <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-95-14"><a href="#annotated-cell-95-14" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-95" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-95-15" class="code-annotation-target"><a href="#annotated-cell-95-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">tb</span> <span class="op">~=</span> <span class="st">''</span> <span class="cf">then</span> <span class="va">tb</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">nl</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-95" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-95-16" class="code-annotation-target"><a href="#annotated-cell-95-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">te</span> <span class="op">~=</span> <span class="st">''</span> <span class="cf">then</span> <span class="va">te</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">te</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-95" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-95-17" class="code-annotation-target"><a href="#annotated-cell-95-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span> <span class="op">=</span> <span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-95-18"><a href="#annotated-cell-95-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-95-19"><a href="#annotated-cell-95-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">no_delims</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">==</span> <span class="st">''</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-95" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-95-20" class="code-annotation-target"><a href="#annotated-cell-95-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">no_delims</span> <span class="cf">then</span> <span class="va">indent</span> <span class="op">=</span> <span class="st">''</span> <span class="cf">end</span></span>
<span id="annotated-cell-95-21"><a href="#annotated-cell-95-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-95-22"><a href="#annotated-cell-95-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-95-23"><a href="#annotated-cell-95-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-95-24"><a href="#annotated-cell-95-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-95-25"><a href="#annotated-cell-95-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-95-26"><a href="#annotated-cell-95-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="annotated-cell-95-27"><a href="#annotated-cell-95-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-95-28"><a href="#annotated-cell-95-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-95-29"><a href="#annotated-cell-95-29" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-95" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-95-30" class="code-annotation-target"><a href="#annotated-cell-95-30" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> indent_string<span class="op">(</span><span class="va">v_string</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span><span class="op">,</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="annotated-cell-95-31"><a href="#annotated-cell-95-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="annotated-cell-95-32"><a href="#annotated-cell-95-32" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-95-33"><a href="#annotated-cell-95-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-95-34"><a href="#annotated-cell-95-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-95-35"><a href="#annotated-cell-95-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-95-36"><a href="#annotated-cell-95-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-95-37"><a href="#annotated-cell-95-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-95-38"><a href="#annotated-cell-95-38" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-95" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-95" data-code-lines="15" data-code-annotation="1">We add a new line to the table begin-delimiter if we use multiline output <em>and</em> the table begin-delimiter is not blank.</span>
</dd>
<dt data-target-cell="annotated-cell-95" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-95" data-code-lines="16" data-code-annotation="2">We add a new line to the table end-delimiter if we use multiline output <em>and</em> the table end-delimiter is not blank.</span>
</dd>
<dt data-target-cell="annotated-cell-95" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-95" data-code-lines="17" data-code-annotation="3">We add a new line to the separator if we are using multiline output.</span>
</dd>
<dt data-target-cell="annotated-cell-95" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-95" data-code-lines="20" data-code-annotation="4">If the table begin-delimiter is blank, we don’t indent the top-level elements in <code>tbl</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-95" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-95" data-code-lines="30" data-code-annotation="5">We still indent any sub-table elements with the “real” indentation amount from the formatting options.</span>
</dd>
</dl>
<p>With that in place, <code>print(alt(user))</code> returns something unindented at the outermost level and without the extra newlines at the end:</p>
<div class="sourceCode" id="annotated-cell-96"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-96-1"><a href="#annotated-cell-96-1" aria-hidden="true" tabindex="-1"></a>first: Minnie,</span>
<span id="annotated-cell-96-2"><a href="#annotated-cell-96-2" aria-hidden="true" tabindex="-1"></a>last: Mouse,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-96" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-96-3" class="code-annotation-target"><a href="#annotated-cell-96-3" aria-hidden="true" tabindex="-1"></a>friends: Mickey,</span>
<span id="annotated-cell-96-4"><a href="#annotated-cell-96-4" aria-hidden="true" tabindex="-1"></a>    Goofy</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-96" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-96" data-code-lines="3" data-code-annotation="1">There should be a new line after <code>friends</code> here.</span>
</dd>
</dl>
<p>We are missing a newline character before the sub-array of friends. It should only be present if the table is multiline and the begin-delimiter is blank. This suggests a small addition to the <code>table_string</code> function:</p>
<div class="sourceCode" id="annotated-cell-97"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-97-1"><a href="#annotated-cell-97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-97-2"><a href="#annotated-cell-97-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-97-3"><a href="#annotated-cell-97-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-97-4"><a href="#annotated-cell-97-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-97-5"><a href="#annotated-cell-97-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-97-6"><a href="#annotated-cell-97-6" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-97" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-97-7" class="code-annotation-target"><a href="#annotated-cell-97-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">tb</span> <span class="op">==</span> <span class="st">''</span> <span class="cf">then</span> <span class="va">v_string</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">v_string</span> <span class="cf">end</span></span>
<span id="annotated-cell-97-8"><a href="#annotated-cell-97-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-97-9"><a href="#annotated-cell-97-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-97-10"><a href="#annotated-cell-97-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-97-11"><a href="#annotated-cell-97-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-97" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-97" data-code-lines="7" data-code-annotation="1">The suggested fix.</span>
</dd>
</dl>
<p>However, this doesn’t quite work as expected as <code>print(alt(user))</code> now returns:</p>
<div class="sourceCode" id="annotated-cell-98"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-98-1"><a href="#annotated-cell-98-1" aria-hidden="true" tabindex="-1"></a>last: Mouse,</span>
<span id="annotated-cell-98-2"><a href="#annotated-cell-98-2" aria-hidden="true" tabindex="-1"></a>first: Minnie,</span>
<span id="annotated-cell-98-3"><a href="#annotated-cell-98-3" aria-hidden="true" tabindex="-1"></a>friends:</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-98" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-98-4" class="code-annotation-target"><a href="#annotated-cell-98-4" aria-hidden="true" tabindex="-1"></a>Mickey,</span>
<span id="annotated-cell-98-5"><a href="#annotated-cell-98-5" aria-hidden="true" tabindex="-1"></a>    Goofy</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-98" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-98" data-code-lines="4" data-code-annotation="1">We’re missing an indentation on the <code>Mickey</code> line.</span>
</dd>
</dl>
<p>However, we can fix this by using that third <code>ignore_first_line</code> argument in <code>indent_string</code>:</p>
<div class="sourceCode" id="annotated-cell-99"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-99-1"><a href="#annotated-cell-99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-99-2"><a href="#annotated-cell-99-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-99-3"><a href="#annotated-cell-99-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-99-4"><a href="#annotated-cell-99-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-99-5"><a href="#annotated-cell-99-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-99-6"><a href="#annotated-cell-99-6" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-99" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-99-7" class="code-annotation-target"><a href="#annotated-cell-99-7" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> indent_string<span class="op">(</span><span class="va">v_string</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span><span class="op">,</span> <span class="kw">not</span> <span class="va">no_delims</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-99" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-99-8" class="code-annotation-target"><a href="#annotated-cell-99-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">no_delims</span> <span class="kw">and</span> <span class="va">show_keys</span> <span class="cf">then</span> <span class="va">v_string</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">v_string</span> <span class="cf">end</span></span>
<span id="annotated-cell-99-9"><a href="#annotated-cell-99-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-99-10"><a href="#annotated-cell-99-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-99-11"><a href="#annotated-cell-99-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-99-12"><a href="#annotated-cell-99-12" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-99" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-99" data-code-lines="7" data-code-annotation="1">We skip indenting the first line of the sub-table <em>unless</em> the table begin-delimiter is blank.</span>
</dd>
<dt data-target-cell="annotated-cell-99" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-99" data-code-lines="8" data-code-annotation="2">We add a newline character <em>if</em> the table begin-delimiter is blank and we are showing keys.</span>
</dd>
</dl>
<p>The full <code>table_string</code> function now looks like:</p>
<div class="sourceCode" id="annotated-cell-100"><pre class="sourceCode lua code-annotation-code code-with-copy"><code class="sourceCode lua"><span id="annotated-cell-100-1"><a href="#annotated-cell-100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-100-2"><a href="#annotated-cell-100-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-100-3"><a href="#annotated-cell-100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-100-4"><a href="#annotated-cell-100-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-100-5"><a href="#annotated-cell-100-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">size</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">then</span> <span class="cf">return</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-100-6"><a href="#annotated-cell-100-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">show_keys</span> <span class="op">=</span> <span class="kw">not</span> <span class="va">array</span> <span class="kw">and</span> <span class="kw">true</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">show_indices</span></span>
<span id="annotated-cell-100-7"><a href="#annotated-cell-100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-100-8"><a href="#annotated-cell-100-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tb</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_begin</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span></span>
<span id="annotated-cell-100-9"><a href="#annotated-cell-100-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">te</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_end</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-100-10"><a href="#annotated-cell-100-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<span id="annotated-cell-100-11"><a href="#annotated-cell-100-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span></span>
<span id="annotated-cell-100-12"><a href="#annotated-cell-100-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-100-13"><a href="#annotated-cell-100-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span>     <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-100-14"><a href="#annotated-cell-100-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-100-15"><a href="#annotated-cell-100-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span> <span class="op">=</span> <span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-100-16"><a href="#annotated-cell-100-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">tb</span> <span class="op">~=</span> <span class="st">''</span> <span class="cf">then</span> <span class="va">tb</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">nl</span> <span class="cf">end</span></span>
<span id="annotated-cell-100-17"><a href="#annotated-cell-100-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">te</span> <span class="op">~=</span> <span class="st">''</span> <span class="cf">then</span> <span class="va">te</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">te</span> <span class="cf">end</span></span>
<span id="annotated-cell-100-18"><a href="#annotated-cell-100-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-100-19"><a href="#annotated-cell-100-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">no_delims</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">==</span> <span class="st">''</span></span>
<span id="annotated-cell-100-20"><a href="#annotated-cell-100-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">no_delims</span> <span class="cf">then</span> <span class="va">indent</span> <span class="op">=</span> <span class="st">''</span> <span class="cf">end</span></span>
<span id="annotated-cell-100-21"><a href="#annotated-cell-100-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-100-22"><a href="#annotated-cell-100-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-100-23"><a href="#annotated-cell-100-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-100-24"><a href="#annotated-cell-100-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-100-25"><a href="#annotated-cell-100-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-100-26"><a href="#annotated-cell-100-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="annotated-cell-100-27"><a href="#annotated-cell-100-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-100-28"><a href="#annotated-cell-100-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-100-29"><a href="#annotated-cell-100-29" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-100-30"><a href="#annotated-cell-100-30" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> indent_string<span class="op">(</span><span class="va">v_string</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span><span class="op">,</span> <span class="kw">not</span> <span class="va">no_delims</span><span class="op">)</span></span>
<span id="annotated-cell-100-31"><a href="#annotated-cell-100-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">no_delims</span> <span class="kw">and</span> <span class="va">show_keys</span> <span class="cf">then</span> <span class="va">v_string</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">v_string</span> <span class="cf">end</span></span>
<span id="annotated-cell-100-32"><a href="#annotated-cell-100-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="annotated-cell-100-33"><a href="#annotated-cell-100-33" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-100-34"><a href="#annotated-cell-100-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-100-35"><a href="#annotated-cell-100-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-100-36"><a href="#annotated-cell-100-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-100-37"><a href="#annotated-cell-100-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-100-38"><a href="#annotated-cell-100-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-100-39"><a href="#annotated-cell-100-39" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With this change in place <code>print(alt(user))</code> returns something like:</p>
<div class="sourceCode" id="annotated-cell-101"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-101" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-101-1" class="code-annotation-target"><a href="#annotated-cell-101-1" aria-hidden="true" tabindex="-1"></a>last: Mouse,</span>
<span id="annotated-cell-101-2"><a href="#annotated-cell-101-2" aria-hidden="true" tabindex="-1"></a>first: Minnie,</span>
<span id="annotated-cell-101-3"><a href="#annotated-cell-101-3" aria-hidden="true" tabindex="-1"></a>friends:</span>
<span id="annotated-cell-101-4"><a href="#annotated-cell-101-4" aria-hidden="true" tabindex="-1"></a>    Mickey,</span>
<span id="annotated-cell-101-5"><a href="#annotated-cell-101-5" aria-hidden="true" tabindex="-1"></a>    Goofy</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-101" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-101" data-code-lines="1" data-code-annotation="1">The elements can be ordered differently.</span>
</dd>
</dl>
<p>The other formats still work as expected. <code>print(pretty(user))</code> returns:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    last = Mouse,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    first = Minnie,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    friends = [</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        Mickey,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>        Goofy</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>print(inline(user))</code> returns:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>{ last = Mouse, first = Minnie, friends = [ Mickey, Goofy ] }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="json" class="level3">
<h3 class="anchored" data-anchor-id="json">JSON</h3>
<p>The JSON format is a popular format for exchanging data between systems. Like our <code>pretty</code> format, JSON delimits tables with curly braces and arrays with square brackets. It surrounds keys with double quotes and uses colons to separate keys from values.</p>
<p>Let’s add a new set of formatting options for JSON:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">json</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">json</span><span class="op">.</span><span class="va">key_begin</span> <span class="op">=</span> <span class="st">'"'</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">json</span><span class="op">.</span><span class="va">key_end</span>   <span class="op">=</span> <span class="st">'": '</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We also add the usual convenience function that packages those formatting options with <code>table_string</code>:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> json<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">options</span><span class="op">.</span><span class="va">json</span><span class="op">)</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="va">If</span> <span class="va">we</span> <span class="va">try</span> `print<span class="op">(</span>alt<span class="op">(</span><span class="va">user</span><span class="op">))</span>` <span class="va">we</span> <span class="va">get</span><span class="op">:</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>```<span class="va">txt</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last"</span><span class="op">:</span> <span class="va">Mouse</span><span class="op">,</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"first"</span><span class="op">:</span> <span class="va">Minnie</span><span class="op">,</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"friends"</span><span class="op">:</span> <span class="op">[</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">Mickey</span><span class="op">,</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">Goofy</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a> <span class="op">]</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This isn’t quite JSON, as JSON requires string values to be surrounded by double quotes.</p>
<p>In fact, it is a good idea to always surround string values with double quotes. Lua’s <code>string</code> class has a <code>string.format</code> method that is perfect for this task.</p>
<p>For example, <code>string.format("Hello, %s!", "world")</code> returns <code>"Hello, world!"</code>. The <code>%s</code> is a placeholder for a string value that is passed as a trailing argument to <code>string.format</code>. <code>string.format</code> is a wrapper around the venerable C function <a href="https://en.cppreference.com/w/c/io/fprintf"><code>sprintf</code></a> and uses almost all the same format specifiers. So <code>%s</code> is used for strings, <code>%d</code> for integers, and <code>%f</code> for floating-point numbers etc.</p>
<p>One of Lua’s primary use cases is dealing with large amounts of text that often includes multiline strings. It is useful to be able to see those in their raw form. For that reason, Lua has a special format specifier <code>%q</code> that is used to quote strings. It is similar to <code>%s</code> but it adds double quotes around the string and escapes any special characters. For example, <code>string.format("%q", 'Hello, "world"!')</code> returns <code>'"Hello, \"world\"!"'</code>.</p>
<p>We can use this format specifier to good effect. While at it, we will add a <code>simple_string</code> counterpart to <code>table_string</code> to take any Lua object and return a simple string representation.</p>
<div class="sourceCode" id="annotated-cell-106"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-106" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-106-1" class="code-annotation-target"><a href="#annotated-cell-106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> simple_string<span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span id="annotated-cell-106-2"><a href="#annotated-cell-106-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">obj</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="cf">return</span> <span class="st">'nil'</span> <span class="cf">end</span></span>
<span id="annotated-cell-106-3"><a href="#annotated-cell-106-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">obj_type</span> <span class="op">=</span> <span class="fu">type</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-106" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-106-4" class="code-annotation-target"><a href="#annotated-cell-106-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">obj_type</span> <span class="op">==</span> <span class="st">'number'</span> <span class="kw">or</span> <span class="va">obj_type</span> <span class="op">==</span> <span class="st">'boolean'</span> <span class="kw">or</span> <span class="va">obj_type</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span></span>
<span id="annotated-cell-106-5"><a href="#annotated-cell-106-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span id="annotated-cell-106-6"><a href="#annotated-cell-106-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elseif</span> <span class="va">obj_type</span> <span class="op">==</span> <span class="st">'string'</span> <span class="cf">then</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-106" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-106-7" class="code-annotation-target"><a href="#annotated-cell-106-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">string.format</span><span class="op">(</span><span class="st">"%q"</span><span class="op">,</span> <span class="va">obj</span><span class="op">)</span></span>
<span id="annotated-cell-106-8"><a href="#annotated-cell-106-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elseif</span> <span class="va">obj_type</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-106" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-106-9" class="code-annotation-target"><a href="#annotated-cell-106-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">string.format</span><span class="op">(</span><span class="st">"%p"</span><span class="op">,</span> <span class="va">obj</span><span class="op">)</span></span>
<span id="annotated-cell-106-10"><a href="#annotated-cell-106-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elseif</span> <span class="va">obj_type</span> <span class="op">==</span> <span class="st">'function'</span> <span class="cf">then</span></span>
<span id="annotated-cell-106-11"><a href="#annotated-cell-106-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'&lt;function&gt;'</span></span>
<span id="annotated-cell-106-12"><a href="#annotated-cell-106-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elseif</span> <span class="va">obj_type</span> <span class="op">==</span> <span class="st">'userdata'</span> <span class="cf">then</span></span>
<span id="annotated-cell-106-13"><a href="#annotated-cell-106-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'&lt;userdata&gt;'</span></span>
<span id="annotated-cell-106-14"><a href="#annotated-cell-106-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elseif</span> <span class="va">obj_type</span> <span class="op">==</span> <span class="st">'thread'</span> <span class="cf">then</span></span>
<span id="annotated-cell-106-15"><a href="#annotated-cell-106-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'&lt;thread&gt;'</span></span>
<span id="annotated-cell-106-16"><a href="#annotated-cell-106-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-106" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-106-17" class="code-annotation-target"><a href="#annotated-cell-106-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'&lt;UNKNOWN type: '</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="op">..</span> <span class="st">'&gt;'</span></span>
<span id="annotated-cell-106-18"><a href="#annotated-cell-106-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-106-19"><a href="#annotated-cell-106-19" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-106" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-106" data-code-lines="1" data-code-annotation="1">The new function <code>simple_string</code> takes any Lua object and returns a simple string representation of it.</span>
</dd>
<dt data-target-cell="annotated-cell-106" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-106" data-code-lines="4" data-code-annotation="2">We let <code>tostring</code> handle numbers, booleans, and <code>nil</code> values.</span>
</dd>
<dt data-target-cell="annotated-cell-106" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-106" data-code-lines="7" data-code-annotation="3">We use <code>string.format</code> with the <code>%q</code> format specifier to quote strings.</span>
</dd>
<dt data-target-cell="annotated-cell-106" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-106" data-code-lines="9" data-code-annotation="4">We use <code>string.format</code> with the <code>%p</code> format specifier to print the memory address of a table. <br> We will usually defer table conversion to <code>table_string</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-106" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-106" data-code-lines="17" data-code-annotation="5">We should never reach this point, but add a catch-all for unknown types that Lua might introduce.</span>
</dd>
</dl>
<p>We can now use <code>simple_string</code> in our <code>table_string</code> function:</p>
<div class="sourceCode" id="annotated-cell-107"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-107-1"><a href="#annotated-cell-107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-107-2"><a href="#annotated-cell-107-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-107-3"><a href="#annotated-cell-107-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">i</span><span class="op">,</span> <span class="va">content</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="st">''</span></span>
<span id="annotated-cell-107-4"><a href="#annotated-cell-107-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-107-5"><a href="#annotated-cell-107-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-107" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-107-6" class="code-annotation-target"><a href="#annotated-cell-107-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="annotated-cell-107-7"><a href="#annotated-cell-107-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-107-8"><a href="#annotated-cell-107-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-107-9"><a href="#annotated-cell-107-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">...</span></span>
<span id="annotated-cell-107-10"><a href="#annotated-cell-107-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-107" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-107-11" class="code-annotation-target"><a href="#annotated-cell-107-11" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> simple_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-107-12"><a href="#annotated-cell-107-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-107-13"><a href="#annotated-cell-107-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-107-14"><a href="#annotated-cell-107-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-107-15"><a href="#annotated-cell-107-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-107-16"><a href="#annotated-cell-107-16" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-107" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-107" data-code-lines="6" data-code-annotation="1">We still use <code>tostring</code> to convert keys to strings and rely on key delimiters to add quotes if needed.</span>
</dd>
<dt data-target-cell="annotated-cell-107" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-107" data-code-lines="11" data-code-annotation="2">We use <code>simple_string</code> to convert non-table values to strings, so always get double quotes around strings.</span>
</dd>
</dl>
<p>With this change in place <code>print(json(user))</code> returns:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"last"</span><span class="fu">:</span> <span class="st">"Mouse"</span><span class="fu">,</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"first"</span><span class="fu">:</span> <span class="st">"Minnie"</span><span class="fu">,</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"friends"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Mickey"</span><span class="ot">,</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Goofy"</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="compact-json" class="level3">
<h3 class="anchored" data-anchor-id="compact-json">Compact JSON</h3>
<p>While JSON is often used in its pretty format, it is common to use a more compact format where all extra spaces and newlines are removed.</p>
<p>We can add a new set of formatting options for inline JSON:</p>
<div class="sourceCode" id="annotated-cell-109"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-109-1"><a href="#annotated-cell-109-1" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline_json</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="va">options</span><span class="op">.</span><span class="va">json</span><span class="op">)</span></span>
<span id="annotated-cell-109-2"><a href="#annotated-cell-109-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline_json</span><span class="op">.</span><span class="va">indent</span>        <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-109-3"><a href="#annotated-cell-109-3" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline_json</span><span class="op">.</span><span class="va">key_end</span>       <span class="op">=</span> <span class="st">'":'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-109" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-109-4" class="code-annotation-target"><a href="#annotated-cell-109-4" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">inline_json</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="op">=</span> <span class="st">''</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-109" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-109" data-code-lines="4" data-code-annotation="1">In this case, we remove the inline spacer as well to make the output even more compact.</span>
</dd>
</dl>
<p>We also add the usual convenience function that packages those formatting options with <code>table_string</code>:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> inline_json<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">options</span><span class="op">.</span><span class="va">inline_json</span><span class="op">)</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we try <code>print(inline_json(user))</code> we get:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">"last"</span><span class="fu">:</span><span class="st">"Mouse"</span><span class="fu">,</span><span class="dt">"first"</span><span class="fu">:</span><span class="st">"Minnie"</span><span class="fu">,</span><span class="dt">"friends"</span><span class="fu">:</span><span class="ot">[</span><span class="st">"Mickey"</span><span class="ot">,</span><span class="st">"Goofy"</span><span class="ot">]</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is also a valid JSON format, but it is harder to read for humans.</p>
</section>
<section id="debug-format" class="level3">
<h3 class="anchored" data-anchor-id="debug-format">Debug Format</h3>
<p>We can add a set of formatting options that makes the structure of the table explicit. This can be useful when you are trying to add a custom set of formatting options:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span><span class="op">.</span><span class="va">indent</span>        <span class="op">=</span> <span class="st">' INDENT '</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span><span class="op">.</span><span class="va">table_begin</span>   <span class="op">=</span> <span class="st">'TABLE BEGIN'</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span><span class="op">.</span><span class="va">table_end</span>     <span class="op">=</span> <span class="st">'TABLE END'</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span><span class="op">.</span><span class="va">array_begin</span>   <span class="op">=</span> <span class="st">'ARRAY BEGIN'</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span><span class="op">.</span><span class="va">array_end</span>     <span class="op">=</span> <span class="st">'ARRAY END'</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span><span class="op">.</span><span class="va">key_begin</span>     <span class="op">=</span> <span class="st">' KEY BEGIN '</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span><span class="op">.</span><span class="va">key_end</span>       <span class="op">=</span> <span class="st">' KEY END = '</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span><span class="op">.</span><span class="va">sep</span>           <span class="op">=</span> <span class="st">' SEP '</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">debug</span><span class="op">.</span><span class="va">show_indices</span>  <span class="op">=</span> <span class="kw">true</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As usual, we add the convenience function that packages those formatting options with <code>table_string</code>:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> debug<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">options</span><span class="op">.</span><span class="va">debug</span><span class="op">)</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we try <code>print(debug(user))</code> we get:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>TABLE BEGIN</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a> INDENT  KEY BEGIN first KEY END = "Minnie" SEP</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a> INDENT  KEY BEGIN last KEY END = "Mouse" SEP</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a> INDENT  KEY BEGIN friends KEY END = ARRAY BEGIN</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a> INDENT  INDENT  KEY BEGIN 1 KEY END = "Mickey" SEP</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a> INDENT  INDENT  KEY BEGIN 2 KEY END = "Goofy"</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a> INDENT ARRAY END</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>TABLE END</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="ordered-output" class="level2">
<h2 class="anchored" data-anchor-id="ordered-output">Ordered Output</h2>
<p>Lua has a single <code>table</code> type. However, as talked about several times now, under the covers, Lua distinguishes between the array part of a table and any dictionary part it might contain. The elements in a Lua array are in fixed constant order so that if:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">arr</span> <span class="op">=</span> <span class="op">{</span> <span class="st">'a'</span><span class="op">,</span> <span class="st">'b'</span><span class="op">,</span> <span class="st">'c'</span> <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, <code>print(inline(arr))</code> will <em>always</em> print <code>['a', 'b', 'c']</code>.</p>
<p>In contrast, the element order in a general key-value table is not defined or constant. If we have:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">mouse</span> <span class="op">=</span> <span class="op">{</span> <span class="va">first</span> <span class="op">=</span> <span class="st">'Minnie'</span><span class="op">,</span> <span class="va">last</span> <span class="op">=</span> <span class="st">'Mouse'</span> <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, <code>print(inline(mouse))</code> will sometimes display <code>{ last = Mouse, first = Minnie, }</code>, other times <code>{ first = Minnie, last = Mouse, }</code>.</p>
<p>Jumping around like that can be disconcerting.</p>
<p>So far, we have used the Lua standard <code>pairs</code> function to traverse through the key-value pairs in all tables.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Lua provides an efficient iterator function, <code>ipairs</code>, specifically for arrays. We can alter our iteration based on whether the table is an array or a key-value table and get a little performance boost.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">iter</span> <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="fu">ipairs</span> <span class="kw">or</span> <span class="fu">pairs</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> iter<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Of course, <code>ipairs</code> doesn’t solve the problem of inconsistent output for key-value tables.</p>
<p>Fortunately, Lua lets us define custom iterator functions, and we can create one to iterate over the keys in a consistent order.</p>
<div class="sourceCode" id="annotated-cell-119"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-119" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-119-1" class="code-annotation-target"><a href="#annotated-cell-119-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">iter</span> <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="fu">ipairs</span> <span class="kw">or</span> <span class="va">ordered_pairs</span></span>
<span id="annotated-cell-119-2"><a href="#annotated-cell-119-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> tbl<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-119-3"><a href="#annotated-cell-119-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-119-4"><a href="#annotated-cell-119-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-119" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-119" data-code-lines="1" data-code-annotation="1">We have replaced the standard <code>pairs</code> iterator with a custom <code>ordered_pairs</code> function. <br> We still use <code>ipairs</code> for arrays.</span>
</dd>
</dl>
<p>A custom iterator function is passed a table and should return the “next” key-value pair in the table. The function should return <code>nil</code> if no more key-value pairs exist. You are free to determine what “next” means in this context.</p>
<p>Here is a simple implementation of <code>ordered_pairs</code>:</p>
<div class="sourceCode" id="annotated-cell-120"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-120-1"><a href="#annotated-cell-120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> ordered_pairs<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-120-2"><a href="#annotated-cell-120-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">keys</span> <span class="op">=</span> <span class="op">{}</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-120" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-120-3" class="code-annotation-target"><a href="#annotated-cell-120-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span> <span class="fu">table.insert</span><span class="op">(</span><span class="va">keys</span><span class="op">,</span> <span class="va">k</span><span class="op">)</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-120" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-120-4" class="code-annotation-target"><a href="#annotated-cell-120-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">table.sort</span><span class="op">(</span><span class="va">keys</span><span class="op">)</span></span>
<span id="annotated-cell-120-5"><a href="#annotated-cell-120-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-120" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-120-6" class="code-annotation-target"><a href="#annotated-cell-120-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">function</span><span class="op">()</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-120" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-120-7" class="code-annotation-target"><a href="#annotated-cell-120-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-120" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-120-8" class="code-annotation-target"><a href="#annotated-cell-120-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">keys</span><span class="op">[</span><span class="va">i</span><span class="op">],</span> <span class="va">tbl</span><span class="op">[</span><span class="va">keys</span><span class="op">[</span><span class="va">i</span><span class="op">]]</span></span>
<span id="annotated-cell-120-9"><a href="#annotated-cell-120-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-120-10"><a href="#annotated-cell-120-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-120" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-120" data-code-lines="3" data-code-annotation="1">We capture all the keys from <code>tbl</code> in the <code>keys</code> <em>array</em>.</span>
</dd>
<dt data-target-cell="annotated-cell-120" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-120" data-code-lines="4" data-code-annotation="2">The default behaviour for <code>table.sort</code> is alphabetical sorting. <br> However, <code>table.sort</code> can take a comparison function as a second argument if you want to sort the keys in a different order.</span>
</dd>
<dt data-target-cell="annotated-cell-120" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-120" data-code-lines="6" data-code-annotation="3">The <code>ordered_pairs</code> function returns an <em>iterator</em> which is itself a function.</span>
</dd>
<dt data-target-cell="annotated-cell-120" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-120" data-code-lines="7" data-code-annotation="4">The iterator function is a <em>closure</em>, so it has access to the <code>keys</code> and the current index <code>i</code> from the enclosing function.</span>
</dd>
<dt data-target-cell="annotated-cell-120" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-120" data-code-lines="8" data-code-annotation="5">The iterator increments the index <code>i</code> and returns the corresponding key-value pair from <code>tbl</code>. <br> The iterator will return <code>nil, nil</code> when there are no more elements, but you could put in an explicit check on <code>i</code> if you wanted to.</span>
</dd>
</dl>
<p>This version of <code>ordered_keys</code> assumes that the keys are all the same type, which is too limiting. The <code>table.sort</code> call will fail if they aren’t. A comparison function takes two arguments and returns <code>true</code> if the first argument should come before the second. We can make a default one that works for all types:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> compare<span class="op">(</span><span class="va">a</span><span class="op">,</span> <span class="va">b</span><span class="op">)</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">ta</span><span class="op">,</span> <span class="va">tb</span> <span class="op">=</span> <span class="fu">type</span><span class="op">(</span><span class="va">a</span><span class="op">),</span> <span class="fu">type</span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">ta</span> <span class="op">~=</span> <span class="va">tb</span> <span class="cf">then</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">ta</span> <span class="op">&lt;</span> <span class="va">tb</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elseif</span> <span class="va">ta</span> <span class="op">==</span> <span class="st">'table'</span> <span class="kw">or</span> <span class="va">ta</span> <span class="op">==</span> <span class="st">'boolean'</span> <span class="kw">or</span> <span class="va">ta</span> <span class="op">==</span> <span class="st">'function'</span> <span class="cf">then</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">a</span> <span class="op">&lt;</span> <span class="va">b</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This function sorts keys first by type and then by value. We note that alphabetically, <code>number</code> comes before <code>string</code>, so we will see numbers before strings, which is the standard convention.</p>
<p>We could use this function in <code>ordered_pairs</code>:</p>
<div class="sourceCode" id="annotated-cell-122"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-122-1"><a href="#annotated-cell-122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> ordered_pairs<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-122-2"><a href="#annotated-cell-122-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-122" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-122-3" class="code-annotation-target"><a href="#annotated-cell-122-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">table.sort</span><span class="op">(</span><span class="va">keys</span><span class="op">,</span> <span class="va">compare</span><span class="op">)</span></span>
<span id="annotated-cell-122-4"><a href="#annotated-cell-122-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-122-5"><a href="#annotated-cell-122-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-122" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-122" data-code-lines="3" data-code-annotation="1">We sort the keys using the comparison function <code>compare</code>.</span>
</dd>
</dl>
<p>However, the user may want to define a custom comparison function. For example, they might want to sort the keys case-insensitively or in reverse alphabetical order.</p>
<p>Ideally, we want the user to be able to pass a comparison function to <code>ordered_pairs</code> and have it return an iterator maker that can use that comparator to iterate over any table in a consistent order.</p>
<p>An extra level of indirection is required:</p>
<div class="sourceCode" id="annotated-cell-123"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-123" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-123-1" class="code-annotation-target"><a href="#annotated-cell-123-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> ordered_pairs<span class="op">(</span><span class="va">comparator</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-123" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-123-2" class="code-annotation-target"><a href="#annotated-cell-123-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">comparator</span> <span class="op">==</span> <span class="kw">false</span> <span class="cf">then</span> <span class="cf">return</span> <span class="fu">pairs</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-123" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-123-3" class="code-annotation-target"><a href="#annotated-cell-123-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">comparator</span> <span class="op">=</span> <span class="va">comparator</span> <span class="kw">or</span> <span class="va">compare</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-123" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-123-4" class="code-annotation-target"><a href="#annotated-cell-123-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">function</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-123-5"><a href="#annotated-cell-123-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">keys</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-123-6"><a href="#annotated-cell-123-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="cn">_</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span> <span class="fu">table.insert</span><span class="op">(</span><span class="va">keys</span><span class="op">,</span> <span class="va">k</span><span class="op">)</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-123" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-123-7" class="code-annotation-target"><a href="#annotated-cell-123-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">table.sort</span><span class="op">(</span><span class="va">keys</span><span class="op">,</span> <span class="va">comparator</span><span class="op">)</span></span>
<span id="annotated-cell-123-8"><a href="#annotated-cell-123-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-123" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-123-9" class="code-annotation-target"><a href="#annotated-cell-123-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">function</span><span class="op">()</span></span>
<span id="annotated-cell-123-10"><a href="#annotated-cell-123-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-123-11"><a href="#annotated-cell-123-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">keys</span><span class="op">[</span><span class="va">i</span><span class="op">],</span> <span class="va">tbl</span><span class="op">[</span><span class="va">keys</span><span class="op">[</span><span class="va">i</span><span class="op">]]</span></span>
<span id="annotated-cell-123-12"><a href="#annotated-cell-123-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">end</span></span>
<span id="annotated-cell-123-13"><a href="#annotated-cell-123-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-123-14"><a href="#annotated-cell-123-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-123" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-123" data-code-lines="1" data-code-annotation="1">We have added a <code>comparator</code> argument, which should be a function that takes two keys and returns <code>true</code> if the first key should come before the second.</span>
</dd>
<dt data-target-cell="annotated-cell-123" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-123" data-code-lines="2" data-code-annotation="2">If <code>comparator</code> is <em>explicitly</em> set to <code>false</code>, we return the standard <code>pairs</code> iterator.</span>
</dd>
<dt data-target-cell="annotated-cell-123" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-123" data-code-lines="3" data-code-annotation="3">If <code>comparator</code> is missing, we use the <code>compare</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-123" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-123" data-code-lines="4" data-code-annotation="4">We return a function that takes a table and returns an iterator function for that table using the sorted keys.</span>
</dd>
<dt data-target-cell="annotated-cell-123" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-123" data-code-lines="7" data-code-annotation="5">We sort the keys using <code>comparator</code>, which will be set by now.</span>
</dd>
<dt data-target-cell="annotated-cell-123" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-123" data-code-lines="9" data-code-annotation="6">The iterator function is a closure with access to the sorted keys and the current index.</span>
</dd>
</dl>
<div class="admonition note">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-note" title="Note"></i></td>
    <td class="content">
    
Adding a layer of indirection is another typical pattern in programming. Our <code>ordered_pairs</code> is a function that returns a function that returns a function.
</td></tr></tbody></table></div>
<p>We add a <code>comparator</code> field to the <code>options.pretty</code> table:</p>
<div class="sourceCode" id="annotated-cell-124"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-124-1"><a href="#annotated-cell-124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">options</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-124-2"><a href="#annotated-cell-124-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">pretty</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="annotated-cell-124-3"><a href="#annotated-cell-124-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>        <span class="op">=</span> <span class="st">'    '</span><span class="op">,</span></span>
<span id="annotated-cell-124-4"><a href="#annotated-cell-124-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_begin</span>   <span class="op">=</span> <span class="st">'{'</span><span class="op">,</span></span>
<span id="annotated-cell-124-5"><a href="#annotated-cell-124-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_end</span>     <span class="op">=</span> <span class="st">'}'</span><span class="op">,</span></span>
<span id="annotated-cell-124-6"><a href="#annotated-cell-124-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_begin</span>   <span class="op">=</span> <span class="st">'['</span><span class="op">,</span></span>
<span id="annotated-cell-124-7"><a href="#annotated-cell-124-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_end</span>     <span class="op">=</span> <span class="st">']'</span><span class="op">,</span></span>
<span id="annotated-cell-124-8"><a href="#annotated-cell-124-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_begin</span>     <span class="op">=</span> <span class="st">''</span><span class="op">,</span></span>
<span id="annotated-cell-124-9"><a href="#annotated-cell-124-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_end</span>       <span class="op">=</span> <span class="st">' = '</span><span class="op">,</span></span>
<span id="annotated-cell-124-10"><a href="#annotated-cell-124-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span>           <span class="op">=</span> <span class="st">','</span><span class="op">,</span></span>
<span id="annotated-cell-124-11"><a href="#annotated-cell-124-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_spacer</span> <span class="op">=</span> <span class="st">' '</span><span class="op">,</span></span>
<span id="annotated-cell-124-12"><a href="#annotated-cell-124-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">show_indices</span>  <span class="op">=</span> <span class="kw">false</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-124" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-124-13" class="code-annotation-target"><a href="#annotated-cell-124-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">comparator</span>    <span class="op">=</span> <span class="va">compare</span></span>
<span id="annotated-cell-124-14"><a href="#annotated-cell-124-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-124" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-124" data-code-lines="13" data-code-annotation="1">We use the default comparison function unless the user specifies otherwise.</span>
</dd>
</dl>
<div class="admonition note">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-note" title="Note"></i></td>
    <td class="content">
    
The user can set the <code>comparator</code> field to <code>false</code> if they want to use the standard <code>pairs</code> iterator.
</td></tr></tbody></table></div>
<section id="aside-nil-vs.-false" class="level3">
<h3 class="anchored" data-anchor-id="aside-nil-vs.-false">Aside: <code>nil</code> vs.&nbsp;<code>false</code></h3>
<p>Like many older languages, Lua treats <code>nil</code> as <em>false</em> in a conditional test.</p>
<p>However, <code>false</code> is a distinct value in Lua. It is a <em>boolean</em> that is <code>false</code> in a conditional test. In Lua, <code>nil</code> represents the absence of a value. <code>false</code> represents a value that is explicitly <code>false</code>.</p>
<p>Choosing to treat <code>nil</code> as <code>false</code> in a conditional test probably seemed convenient. It is a common idiom in many languages, particularly C, where <code>0</code> can represent <em>false</em>. Modern languages have moved away from this.</p>
<p>This conflating of <code>nil</code> and <code>false</code> can lead to subtle bugs. This is particularly true in Lua, where you will likely have functions with optional arguments. The common idiom for optional arguments looks like this:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> foo<span class="op">(</span><span class="va">arg</span><span class="op">)</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">arg</span> <span class="op">=</span> <span class="va">arg</span> <span class="kw">or</span> <span class="st">'default'</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span><span class="op">(</span><span class="va">arg</span><span class="op">)</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If <code>arg</code> is missing or <code>nil</code>, it will be set to <code>'default'</code>. If <code>arg</code> is explicitly <code>false</code>, it will still be set to <code>'default'</code> which is probably not what you want.</p>
<p>Try it:</p>
<div class="sourceCode" id="annotated-cell-126"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-126-1"><a href="#annotated-cell-126-1" aria-hidden="true" tabindex="-1"></a>foo<span class="op">()</span>           <span class="co">-- prints 'default'</span></span>
<span id="annotated-cell-126-2"><a href="#annotated-cell-126-2" aria-hidden="true" tabindex="-1"></a>foo<span class="op">(</span><span class="kw">nil</span><span class="op">)</span>        <span class="co">-- prints 'default'</span></span>
<span id="annotated-cell-126-3"><a href="#annotated-cell-126-3" aria-hidden="true" tabindex="-1"></a>foo<span class="op">(</span><span class="st">'hello'</span><span class="op">)</span>    <span class="co">-- prints 'hello'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-126" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-126-4" class="code-annotation-target"><a href="#annotated-cell-126-4" aria-hidden="true" tabindex="-1"></a>foo<span class="op">(</span><span class="kw">false</span><span class="op">)</span>      <span class="co">-- prints 'default'</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-126" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-126" data-code-lines="4" data-code-annotation="1">This is not what you want!</span>
</dd>
</dl>
<p>From personal experience, this will bite you at some point.</p>
<p>You sometimes might want to distinguish between the absence of an argument and an explicitly <code>false</code> argument. We can rewrite <code>foo</code> to handle this:</p>
<div class="sourceCode" id="annotated-cell-127"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-127-1"><a href="#annotated-cell-127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> foo<span class="op">(</span><span class="va">arg</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-127" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-127-2" class="code-annotation-target"><a href="#annotated-cell-127-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">arg</span> <span class="op">==</span> <span class="kw">false</span> <span class="cf">then</span> <span class="fu">print</span><span class="op">(</span><span class="st">'false'</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-127-3"><a href="#annotated-cell-127-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">arg</span> <span class="op">=</span> <span class="va">arg</span> <span class="kw">or</span> <span class="st">'default'</span></span>
<span id="annotated-cell-127-4"><a href="#annotated-cell-127-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span><span class="op">(</span><span class="va">arg</span><span class="op">)</span></span>
<span id="annotated-cell-127-5"><a href="#annotated-cell-127-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-127-6"><a href="#annotated-cell-127-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-127-7"><a href="#annotated-cell-127-7" aria-hidden="true" tabindex="-1"></a>foo<span class="op">()</span>           <span class="co">-- prints 'default'</span></span>
<span id="annotated-cell-127-8"><a href="#annotated-cell-127-8" aria-hidden="true" tabindex="-1"></a>foo<span class="op">(</span><span class="kw">nil</span><span class="op">)</span>        <span class="co">-- prints 'default'</span></span>
<span id="annotated-cell-127-9"><a href="#annotated-cell-127-9" aria-hidden="true" tabindex="-1"></a>foo<span class="op">(</span><span class="st">'hello'</span><span class="op">)</span>    <span class="co">-- prints 'hello'</span></span>
<span id="annotated-cell-127-10"><a href="#annotated-cell-127-10" aria-hidden="true" tabindex="-1"></a>foo<span class="op">(</span><span class="kw">false</span><span class="op">)</span>      <span class="co">-- prints 'false'</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-127" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-127" data-code-lines="2" data-code-annotation="1">We added a check for <code>arg</code> being explicitly <code>false</code>.</span>
</dd>
</dl>
</section>
<section id="ordered-output-resolved" class="level3">
<h3 class="anchored" data-anchor-id="ordered-output-resolved">Ordered Output Resolved</h3>
<p>The change to <code>table_string</code> is quite small:</p>
<div class="sourceCode" id="annotated-cell-128"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-128-1"><a href="#annotated-cell-128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-128-2"><a href="#annotated-cell-128-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-128" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-128-3" class="code-annotation-target"><a href="#annotated-cell-128-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">iter</span> <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="fu">ipairs</span> <span class="kw">or</span> ordered_pairs<span class="op">(</span><span class="va">opts</span><span class="op">.</span><span class="va">comparator</span><span class="op">)</span></span>
<span id="annotated-cell-128-4"><a href="#annotated-cell-128-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> iter<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-128-5"><a href="#annotated-cell-128-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-128-6"><a href="#annotated-cell-128-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-128-7"><a href="#annotated-cell-128-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-128-8"><a href="#annotated-cell-128-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-128" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-128" data-code-lines="3" data-code-annotation="1">We have replaced the <code>pairs</code> iterator with <code>ordered_pairs</code> using a user-defined comparison function for non-arrays.</span>
</dd>
</dl>
<p>Now if you try <code>print(pretty(user))</code> you <em>always</em> get:</p>
<div class="sourceCode" id="annotated-cell-129"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-129" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-129-1" class="code-annotation-target"><a href="#annotated-cell-129-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="annotated-cell-129-2"><a href="#annotated-cell-129-2" aria-hidden="true" tabindex="-1"></a>    first = Minnie,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-129" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-129-3" class="code-annotation-target"><a href="#annotated-cell-129-3" aria-hidden="true" tabindex="-1"></a>    friends = [</span>
<span id="annotated-cell-129-4"><a href="#annotated-cell-129-4" aria-hidden="true" tabindex="-1"></a>        Mickey,</span>
<span id="annotated-cell-129-5"><a href="#annotated-cell-129-5" aria-hidden="true" tabindex="-1"></a>        Goofy</span>
<span id="annotated-cell-129-6"><a href="#annotated-cell-129-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="annotated-cell-129-7"><a href="#annotated-cell-129-7" aria-hidden="true" tabindex="-1"></a>    last = Mouse</span>
<span id="annotated-cell-129-8"><a href="#annotated-cell-129-8" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-129" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-129" data-code-lines="1" data-code-annotation="1"><code>user</code> is a key-value table, and the elements are shown with the keys alphabetically.</span>
</dd>
<dt data-target-cell="annotated-cell-129" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-129" data-code-lines="3" data-code-annotation="2"><code>friends</code> is a sub-array with the elements shown in index order.</span>
</dd>
</dl>
</section>
</section>
<section id="inlining-simple-sub-tables" class="level2">
<h2 class="anchored" data-anchor-id="inlining-simple-sub-tables">Inlining Simple Sub-Tables</h2>
<p>A nice feature of some pretty-printers is the ability to inline “simple” sub-tables. This option can make the output more readable and compact.</p>
<p>Of course, we need to define what “simple” means. It could be a small table that fits inside a set number of characters. Or it could be a table with a certain number of elements.</p>
<p>For our purposes, we will consider a table “simple” if it has no sub-tables. We will also add an optional limit on the number of elements to this definition.</p>
<p>We can alter our <code>metadata</code> function to return the number of sub-tables in a table:</p>
<div class="sourceCode" id="annotated-cell-130"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-130-1"><a href="#annotated-cell-130-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-130-2"><a href="#annotated-cell-130-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-130-3"><a href="#annotated-cell-130-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">array</span> <span class="op">=</span> <span class="kw">true</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-130" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-130-4" class="code-annotation-target"><a href="#annotated-cell-130-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">subs</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-130-5"><a href="#annotated-cell-130-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-130-6"><a href="#annotated-cell-130-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">size</span> <span class="op">=</span> <span class="va">size</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-130-7"><a href="#annotated-cell-130-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">tbl</span><span class="op">[</span><span class="va">size</span><span class="op">]</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="va">array</span> <span class="op">=</span> <span class="kw">false</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-130" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-130-8" class="code-annotation-target"><a href="#annotated-cell-130-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span> <span class="va">subs</span> <span class="op">=</span> <span class="va">subs</span> <span class="op">+</span> <span class="dv">1</span>  <span class="cf">end</span></span>
<span id="annotated-cell-130-9"><a href="#annotated-cell-130-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-130" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-130-10" class="code-annotation-target"><a href="#annotated-cell-130-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">md</span> <span class="op">=</span> <span class="op">{</span> <span class="va">size</span> <span class="op">=</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span> <span class="op">=</span> <span class="va">array</span><span class="op">,</span> <span class="va">subs</span> <span class="op">=</span> <span class="va">subs</span> <span class="op">}</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-130" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-130-11" class="code-annotation-target"><a href="#annotated-cell-130-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">md</span></span>
<span id="annotated-cell-130-12"><a href="#annotated-cell-130-12" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-130" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-130" data-code-lines="4" data-code-annotation="1"><code>subs</code> will be the number of sub-tables.</span>
</dd>
<dt data-target-cell="annotated-cell-130" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-130" data-code-lines="8" data-code-annotation="2">If we find a sub-table, we increment <code>subs</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-130" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-130" data-code-lines="10" data-code-annotation="3">Instead of returning three values, we create a table with three fields.</span>
</dd>
<dt data-target-cell="annotated-cell-130" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-130" data-code-lines="11" data-code-annotation="4">We return the metadata table.</span>
</dd>
</dl>
<p>If you haven’t seen this coding style before, the <code>md</code> table is created with a <em>table constructor</em>. It is a shorthand way to create a table with some initial values. Assignments of the form <code>tbl = { x = x }</code> look odd, but they are a common idiom in Lua. The assignment is shorthand for <code>tbl[x] = x</code> where the <code>x</code> key is a string, and the <code>x</code> value can be any type.</p>
<p>We can now use the <code>subs</code> field in our <code>table_string</code> method to decide whether to inline a sub-table.</p>
<p>However, whether or not to inline simple tables should also be user-configurable. To accommodate that, we can add another field to our options table.</p>
<div class="sourceCode" id="annotated-cell-131"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-131-1"><a href="#annotated-cell-131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">options</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-131-2"><a href="#annotated-cell-131-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">pretty</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="annotated-cell-131-3"><a href="#annotated-cell-131-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>        <span class="op">=</span> <span class="st">'    '</span><span class="op">,</span></span>
<span id="annotated-cell-131-4"><a href="#annotated-cell-131-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_begin</span>   <span class="op">=</span> <span class="st">'{'</span><span class="op">,</span></span>
<span id="annotated-cell-131-5"><a href="#annotated-cell-131-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_end</span>     <span class="op">=</span> <span class="st">'}'</span><span class="op">,</span></span>
<span id="annotated-cell-131-6"><a href="#annotated-cell-131-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_begin</span>   <span class="op">=</span> <span class="st">'['</span><span class="op">,</span></span>
<span id="annotated-cell-131-7"><a href="#annotated-cell-131-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_end</span>     <span class="op">=</span> <span class="st">']'</span><span class="op">,</span></span>
<span id="annotated-cell-131-8"><a href="#annotated-cell-131-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_begin</span>     <span class="op">=</span> <span class="st">''</span><span class="op">,</span></span>
<span id="annotated-cell-131-9"><a href="#annotated-cell-131-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_end</span>       <span class="op">=</span> <span class="st">' = '</span><span class="op">,</span></span>
<span id="annotated-cell-131-10"><a href="#annotated-cell-131-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span>           <span class="op">=</span> <span class="st">','</span><span class="op">,</span></span>
<span id="annotated-cell-131-11"><a href="#annotated-cell-131-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_spacer</span> <span class="op">=</span> <span class="st">' '</span><span class="op">,</span></span>
<span id="annotated-cell-131-12"><a href="#annotated-cell-131-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">show_indices</span>  <span class="op">=</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="annotated-cell-131-13"><a href="#annotated-cell-131-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">comparator</span>    <span class="op">=</span> <span class="va">compare</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-131" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-131-14" class="code-annotation-target"><a href="#annotated-cell-131-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_size</span>   <span class="op">=</span> <span class="fu">math.huge</span></span>
<span id="annotated-cell-131-15"><a href="#annotated-cell-131-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="annotated-cell-131-16"><a href="#annotated-cell-131-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-131-17"><a href="#annotated-cell-131-17" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">classic</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="annotated-cell-131-18"><a href="#annotated-cell-131-18" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">classic</span><span class="op">.</span><span class="va">array_begin</span>     <span class="op">=</span> <span class="st">'{'</span></span>
<span id="annotated-cell-131-19"><a href="#annotated-cell-131-19" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">classic</span><span class="op">.</span><span class="va">array_end</span>       <span class="op">=</span> <span class="st">'}'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-131" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-131-20" class="code-annotation-target"><a href="#annotated-cell-131-20" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">classic</span><span class="op">.</span><span class="va">inline_size</span>     <span class="op">=</span> <span class="dv">0</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-131" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-131" data-code-lines="14" data-code-annotation="1">A simple table will be inlined if it has no sub-tables and strictly fewer than <code>inline_size</code> elements.</span>
</dd>
<dt data-target-cell="annotated-cell-131" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-131" data-code-lines="20" data-code-annotation="2">In the <code>classic</code> format, we never inline simple tables.</span>
</dd>
</dl>
<p>So, by default, simple tables are always inlined in the <code>pretty</code> format and never in the <code>classic</code> format. If you set <code>inline_size</code> to <code>6</code> in the <code>pretty</code> format, we inline simple tables if they have fewer than six elements.</p>
<p>Given our current setup, it only takes a small tweak to our existing code to accommodate this new feature:</p>
<div class="sourceCode" id="annotated-cell-132"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-132-1"><a href="#annotated-cell-132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-132-2"><a href="#annotated-cell-132-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-132-3"><a href="#annotated-cell-132-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-132" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-132-4" class="code-annotation-target"><a href="#annotated-cell-132-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">md</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-132" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-132-5" class="code-annotation-target"><a href="#annotated-cell-132-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span>   <span class="op">=</span> <span class="va">md</span><span class="op">.</span><span class="va">size</span></span>
<span id="annotated-cell-132-6"><a href="#annotated-cell-132-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">array</span>  <span class="op">=</span> <span class="va">md</span><span class="op">.</span><span class="va">array</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-132" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-132-7" class="code-annotation-target"><a href="#annotated-cell-132-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">simple</span> <span class="op">=</span> <span class="va">md</span><span class="op">.</span><span class="va">subs</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">md</span><span class="op">.</span><span class="va">size</span> <span class="op">&lt;</span>  <span class="va">options</span><span class="op">.</span><span class="va">inline_size</span></span>
<span id="annotated-cell-132-8"><a href="#annotated-cell-132-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-132-9"><a href="#annotated-cell-132-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">size</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">then</span> <span class="cf">return</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-132-10"><a href="#annotated-cell-132-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">show_keys</span> <span class="op">=</span> <span class="kw">not</span> <span class="va">array</span> <span class="kw">and</span> <span class="kw">true</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">show_indices</span></span>
<span id="annotated-cell-132-11"><a href="#annotated-cell-132-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-132-12"><a href="#annotated-cell-132-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tb</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_begin</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span></span>
<span id="annotated-cell-132-13"><a href="#annotated-cell-132-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">te</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_end</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-132-14"><a href="#annotated-cell-132-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<span id="annotated-cell-132-15"><a href="#annotated-cell-132-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-132" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-132-16" class="code-annotation-target"><a href="#annotated-cell-132-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">simple</span> <span class="kw">and</span> <span class="st">''</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-132-17"><a href="#annotated-cell-132-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">nl</span>     <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-132-18"><a href="#annotated-cell-132-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">delims</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">~=</span> <span class="st">''</span></span>
<span id="annotated-cell-132-19"><a href="#annotated-cell-132-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-132-20"><a href="#annotated-cell-132-20" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span> <span class="op">=</span> <span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-132-21"><a href="#annotated-cell-132-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">delims</span> <span class="cf">then</span> <span class="va">tb</span><span class="op">,</span> <span class="va">te</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">nl</span><span class="op">,</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">te</span>  <span class="cf">else</span> <span class="va">indent</span> <span class="op">=</span> <span class="st">''</span> <span class="cf">end</span></span>
<span id="annotated-cell-132-22"><a href="#annotated-cell-132-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-132-23"><a href="#annotated-cell-132-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-132-24"><a href="#annotated-cell-132-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-132-25"><a href="#annotated-cell-132-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">iter</span> <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="fu">ipairs</span> <span class="kw">or</span> ordered_pairs<span class="op">(</span><span class="va">opts</span><span class="op">.</span><span class="va">comparator</span><span class="op">)</span></span>
<span id="annotated-cell-132-26"><a href="#annotated-cell-132-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> iter<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-132-27"><a href="#annotated-cell-132-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-132-28"><a href="#annotated-cell-132-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="annotated-cell-132-29"><a href="#annotated-cell-132-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-132-30"><a href="#annotated-cell-132-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-132-31"><a href="#annotated-cell-132-31" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> table_string<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-132-32"><a href="#annotated-cell-132-32" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> indent_string<span class="op">(</span><span class="va">v_string</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span><span class="op">,</span> <span class="va">delims</span><span class="op">)</span></span>
<span id="annotated-cell-132-33"><a href="#annotated-cell-132-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">delims</span> <span class="op">==</span> <span class="kw">false</span> <span class="kw">and</span> <span class="va">show_keys</span> <span class="cf">then</span> <span class="va">v_string</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">v_string</span> <span class="cf">end</span></span>
<span id="annotated-cell-132-34"><a href="#annotated-cell-132-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="annotated-cell-132-35"><a href="#annotated-cell-132-35" aria-hidden="true" tabindex="-1"></a>            <span class="va">v_string</span> <span class="op">=</span> simple_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-132-36"><a href="#annotated-cell-132-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-132-37"><a href="#annotated-cell-132-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-132-38"><a href="#annotated-cell-132-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-132-39"><a href="#annotated-cell-132-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-132-40"><a href="#annotated-cell-132-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-132-41"><a href="#annotated-cell-132-41" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-132" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-132" data-code-lines="4" data-code-annotation="1"><code>metadata</code> returns a table instead of a couple of values.</span>
</dd>
<dt data-target-cell="annotated-cell-132" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-132" data-code-lines="5" data-code-annotation="2">Extract the <code>size</code> and <code>array</code> values from the <code>md</code> table.</span>
</dd>
<dt data-target-cell="annotated-cell-132" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-132" data-code-lines="7" data-code-annotation="3">If there are no sub-tables <em>and</em> the table is small enough, we consider it simple.</span>
</dd>
<dt data-target-cell="annotated-cell-132" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-132" data-code-lines="16" data-code-annotation="4">This is the only change needed to incorporate that new metadata about <code>tbl</code>.</span>
</dd>
</dl>
<p>Looking at <code>print(pretty(user))</code> we get:</p>
<div class="sourceCode" id="annotated-cell-133"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-133-1"><a href="#annotated-cell-133-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="annotated-cell-133-2"><a href="#annotated-cell-133-2" aria-hidden="true" tabindex="-1"></a>    first = "Minnie",</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-133" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-133-3" class="code-annotation-target"><a href="#annotated-cell-133-3" aria-hidden="true" tabindex="-1"></a>    friends = [ "Mickey", "Goofy" ],</span>
<span id="annotated-cell-133-4"><a href="#annotated-cell-133-4" aria-hidden="true" tabindex="-1"></a>    last = "Mouse"</span>
<span id="annotated-cell-133-5"><a href="#annotated-cell-133-5" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-133" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-133" data-code-lines="3" data-code-annotation="1">Now, the <code>friends</code> array is printed inline as it has no sub-tables.</span>
</dd>
</dl>
<p>A more interesting example is:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">matrix</span> <span class="op">=</span> <span class="op">{</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">},</span> <span class="op">{</span><span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">6</span><span class="op">},</span> <span class="op">{</span><span class="dv">7</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">9</span><span class="op">}</span> <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>print(classic(matrix))</code> gives:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>        1,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>        2,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>        3</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>        4,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>        5,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>        6</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>        7,</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>        8,</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>        9</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With our tweaks <code>print(pretty(matrix))</code> yields a much more readable:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    [ 1, 2, 3 ],</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    [ 4, 5, 6 ],</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    [ 7, 8, 9 ]</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And <code>print(alt(matrix))</code> yields</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>    1, 2, 3,</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    4, 5, 6,</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    7, 8, 9</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="table-metadata" class="level2">
<h2 class="anchored" data-anchor-id="table-metadata">Table Metadata</h2>
<p>Our current scheme computes each table’s metadata on the fly. When we start our process with the root table, or when we recurse into a sub-table, we have the call to compute the metadata for the table that is currently under the microscope:</p>
<div class="sourceCode" id="annotated-cell-138"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-138-1"><a href="#annotated-cell-138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-138-2"><a href="#annotated-cell-138-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-138-3"><a href="#annotated-cell-138-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-138" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-138-4" class="code-annotation-target"><a href="#annotated-cell-138-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">md</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-138-5"><a href="#annotated-cell-138-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span>   <span class="op">=</span> <span class="va">md</span><span class="op">.</span><span class="va">size</span></span>
<span id="annotated-cell-138-6"><a href="#annotated-cell-138-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-138" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-138" data-code-lines="4" data-code-annotation="1">The current table of interest is <code>tbl</code>. <br> <code>md(tbl)</code> returns a metadata table for <code>tbl</code>.</span>
</dd>
</dl>
<p>However, tables can reference other tables and even have references to themselves. For example, we might build a website with Disney characters and have a gallery where visitors can flip from one star to the next and back to the previous one, etc.</p>
<p>A doubly linked list is one data structure to model this type of interaction. In the most dumbed down, minimal version, we might have:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">stars</span> <span class="op">=</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">c1</span> <span class="op">=</span> <span class="op">{</span> <span class="va">first</span> <span class="op">=</span> <span class="st">"Mickey"</span><span class="op">,</span> <span class="va">last</span> <span class="op">=</span> <span class="st">"Mouse"</span> <span class="op">},</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">c2</span> <span class="op">=</span> <span class="op">{</span> <span class="va">first</span> <span class="op">=</span> <span class="st">"Minnie"</span><span class="op">,</span> <span class="va">last</span> <span class="op">=</span> <span class="st">"Mouse"</span> <span class="op">}</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="va">stars</span><span class="op">.</span><span class="va">c1</span><span class="op">.</span><span class="va">next</span> <span class="op">=</span> <span class="va">stars</span><span class="op">.</span><span class="va">c2</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="va">stars</span><span class="op">.</span><span class="va">c2</span><span class="op">.</span><span class="va">prev</span> <span class="op">=</span> <span class="va">stars</span><span class="op">.</span><span class="va">c1</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="va">stars</span><span class="op">.</span><span class="va">home</span> <span class="op">=</span> <span class="va">stars</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here, <code>c1</code>, <code>c2</code>, … are characters. Each has a table of associated data (more realistically, a table of image links and the like).</p>
<p>The characters are connected by their next and previous links. To cap it all, we have a “home” link back to the original table — a self-reference.</p>
<p>If you try <code>print(pretty(stars))</code> with our current implementation, the program will chase its tail and die of pure embarrassment at the rubbish state of <code>table_string</code>.</p>
<p>Before we get to that, we will first alter our <code>metadata</code> function significantly.</p>
<p>Instead of treating each table as it comes along and passing back some associated metadata, we will view the table as a whole entity in one go.</p>
<p>Our current <code>metadata(tbl)</code> returns <code>md</code>, a table with three fields, <code>size</code>, <code>array</code> and <code>simple</code>, that tell you something about <code>tbl</code>.</p>
<p>In our new implementation, <code>metadata(tbl)</code> will return <code>md</code> as a table of tables. If <code>t</code> is <code>tbl</code> itself <em>or</em> any sub-table of <code>tbl</code>, then</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 80%">
</colgroup>
<thead>
<tr class="header">
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>md[t].size</code></td>
<td>The number of top-level elements in <code>t</code>.</td>
</tr>
<tr class="even">
<td><code>md[t].array</code></td>
<td>This will be <code>true</code> if <code>t</code> is a Lua array, otherwise <code>false</code>.</td>
</tr>
<tr class="odd">
<td><code>md[t].subs</code></td>
<td>The number of sub-tables in <code>t</code>.</td>
</tr>
</tbody>
</table>
<p>Here is what our new call-it-once-and-be-done <code>metadata</code> function looks like:</p>
<div class="sourceCode" id="annotated-cell-140"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-140" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-140-1" class="code-annotation-target"><a href="#annotated-cell-140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">md</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-140" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-140-2" class="code-annotation-target"><a href="#annotated-cell-140-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">md</span> <span class="op">=</span> <span class="va">md</span> <span class="kw">or</span> <span class="op">{}</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-140" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-140-3" class="code-annotation-target"><a href="#annotated-cell-140-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">]</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-140-4"><a href="#annotated-cell-140-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span><span class="op">,</span> <span class="va">subs</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="annotated-cell-140-5"><a href="#annotated-cell-140-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-140-6"><a href="#annotated-cell-140-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">size</span> <span class="op">=</span> <span class="va">size</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-140-7"><a href="#annotated-cell-140-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">tbl</span><span class="op">[</span><span class="va">size</span><span class="op">]</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="va">array</span> <span class="op">=</span> <span class="kw">false</span> <span class="cf">end</span></span>
<span id="annotated-cell-140-8"><a href="#annotated-cell-140-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-140-9"><a href="#annotated-cell-140-9" aria-hidden="true" tabindex="-1"></a>            <span class="va">subs</span> <span class="op">=</span> <span class="va">subs</span> <span class="op">+</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-140" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-140-10" class="code-annotation-target"><a href="#annotated-cell-140-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">]</span> <span class="cf">then</span> metadata<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">md</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-140-11"><a href="#annotated-cell-140-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-140-12"><a href="#annotated-cell-140-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-140" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-140-13" class="code-annotation-target"><a href="#annotated-cell-140-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">size</span>  <span class="op">=</span> <span class="va">size</span></span>
<span id="annotated-cell-140-14"><a href="#annotated-cell-140-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">array</span> <span class="op">=</span> <span class="va">array</span></span>
<span id="annotated-cell-140-15"><a href="#annotated-cell-140-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">subs</span>  <span class="op">=</span> <span class="va">subs</span></span>
<span id="annotated-cell-140-16"><a href="#annotated-cell-140-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">md</span></span>
<span id="annotated-cell-140-17"><a href="#annotated-cell-140-17" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-140" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-140" data-code-lines="1" data-code-annotation="1">We’ve added <code>md</code> to the calling signature. It will be missing on the first call.</span>
</dd>
<dt data-target-cell="annotated-cell-140" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-140" data-code-lines="2" data-code-annotation="2">If <code>md</code> is completely missing, we set it up as an empty table.</span>
</dd>
<dt data-target-cell="annotated-cell-140" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-140" data-code-lines="3" data-code-annotation="3">We set up <code>md[tbl]</code> as an empty sub-table of <code>md</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-140" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-140" data-code-lines="10" data-code-annotation="4">As we iterate through <code>tbl</code>, we may come across a new sub-table <code>v</code>, which is handled by recursion.</span>
</dd>
<dt data-target-cell="annotated-cell-140" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-140" data-code-lines="13" data-code-annotation="5">Record the three bits of metadata for <code>tbl</code> in the <code>md[tbl]</code> sub-table.</span>
</dd>
</dl>
<p>To use this new <code>metadata</code> method, we also need to alter <code>table_string</code>. That can be done a couple of different ways. One way to go is to make <code>table_string</code> a little wrapper around a recursive <em>closure</em> that does most of the work:</p>
<div class="sourceCode" id="annotated-cell-141"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-141" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-141-1" class="code-annotation-target"><a href="#annotated-cell-141-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-141-2"><a href="#annotated-cell-141-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-141" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-141-3" class="code-annotation-target"><a href="#annotated-cell-141-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">md</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span></span>
<span id="annotated-cell-141-4"><a href="#annotated-cell-141-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-141" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-141-5" class="code-annotation-target"><a href="#annotated-cell-141-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="kw">function</span> process<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-141" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-141-6" class="code-annotation-target"><a href="#annotated-cell-141-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">size</span>   <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">size</span></span>
<span id="annotated-cell-141-7"><a href="#annotated-cell-141-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">size</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">then</span> <span class="cf">return</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-141-8"><a href="#annotated-cell-141-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-141-9"><a href="#annotated-cell-141-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">array</span>  <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">array</span></span>
<span id="annotated-cell-141-10"><a href="#annotated-cell-141-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">show_keys</span> <span class="op">=</span> <span class="kw">not</span> <span class="va">array</span> <span class="kw">and</span> <span class="kw">true</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">show_indices</span></span>
<span id="annotated-cell-141-11"><a href="#annotated-cell-141-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-141-12"><a href="#annotated-cell-141-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">simple</span> <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">subs</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">size</span> <span class="op">&lt;</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_size</span></span>
<span id="annotated-cell-141-13"><a href="#annotated-cell-141-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">simple</span> <span class="kw">and</span> <span class="st">''</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-141-14"><a href="#annotated-cell-141-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-141-15"><a href="#annotated-cell-141-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">tb</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_begin</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span></span>
<span id="annotated-cell-141-16"><a href="#annotated-cell-141-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">te</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_end</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-141-17"><a href="#annotated-cell-141-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<span id="annotated-cell-141-18"><a href="#annotated-cell-141-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">nl</span>     <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-141-19"><a href="#annotated-cell-141-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-141-20"><a href="#annotated-cell-141-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-141-21"><a href="#annotated-cell-141-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">delims</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">~=</span> <span class="st">''</span></span>
<span id="annotated-cell-141-22"><a href="#annotated-cell-141-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">delims</span> <span class="cf">then</span> <span class="va">tb</span><span class="op">,</span> <span class="va">te</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">nl</span><span class="op">,</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">te</span>  <span class="cf">else</span> <span class="va">indent</span> <span class="op">=</span> <span class="st">''</span> <span class="cf">end</span></span>
<span id="annotated-cell-141-23"><a href="#annotated-cell-141-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-141-24"><a href="#annotated-cell-141-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-141-25"><a href="#annotated-cell-141-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-141-26"><a href="#annotated-cell-141-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">iter</span> <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="fu">ipairs</span> <span class="kw">or</span> ordered_pairs<span class="op">(</span><span class="va">opts</span><span class="op">.</span><span class="va">comparator</span><span class="op">)</span></span>
<span id="annotated-cell-141-27"><a href="#annotated-cell-141-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> iter<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-141-28"><a href="#annotated-cell-141-28" aria-hidden="true" tabindex="-1"></a>            <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-141-29"><a href="#annotated-cell-141-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="annotated-cell-141-30"><a href="#annotated-cell-141-30" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-141-31"><a href="#annotated-cell-141-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-141" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-141-32" class="code-annotation-target"><a href="#annotated-cell-141-32" aria-hidden="true" tabindex="-1"></a>                <span class="va">v_string</span> <span class="op">=</span> process<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-141-33"><a href="#annotated-cell-141-33" aria-hidden="true" tabindex="-1"></a>                <span class="va">v_string</span> <span class="op">=</span> indent_string<span class="op">(</span><span class="va">v_string</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span><span class="op">,</span> <span class="va">delims</span><span class="op">)</span></span>
<span id="annotated-cell-141-34"><a href="#annotated-cell-141-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">delims</span> <span class="op">==</span> <span class="kw">false</span> <span class="kw">and</span> <span class="va">show_keys</span> <span class="cf">then</span> <span class="va">v_string</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">v_string</span> <span class="cf">end</span></span>
<span id="annotated-cell-141-35"><a href="#annotated-cell-141-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="annotated-cell-141-36"><a href="#annotated-cell-141-36" aria-hidden="true" tabindex="-1"></a>                <span class="va">v_string</span> <span class="op">=</span> simple_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-141-37"><a href="#annotated-cell-141-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="annotated-cell-141-38"><a href="#annotated-cell-141-38" aria-hidden="true" tabindex="-1"></a>            <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-141-39"><a href="#annotated-cell-141-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-141-40"><a href="#annotated-cell-141-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-141-41"><a href="#annotated-cell-141-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-141-42"><a href="#annotated-cell-141-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-141-43"><a href="#annotated-cell-141-43" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-141" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-141-44" class="code-annotation-target"><a href="#annotated-cell-141-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">retval</span> <span class="op">=</span> process<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span></span>
<span id="annotated-cell-141-45"><a href="#annotated-cell-141-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-141-46"><a href="#annotated-cell-141-46" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-141" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-141" data-code-lines="1" data-code-annotation="1">Now, <code>table_string</code> is primarily a wrapper around the inner <code>process</code> function. <br> We have changed the first argument to <code>root_tbl</code> to clarify that this is the root table.</span>
</dd>
<dt data-target-cell="annotated-cell-141" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-141" data-code-lines="3" data-code-annotation="2">We compute the root table <code>root_tbl</code> metadata and store it in <code>md</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-141" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-141" data-code-lines="5" data-code-annotation="3">The <code>process</code> function is a <em>closure</em> and can access the <em>enclosed</em> <code>md</code> table.</span>
</dd>
<dt data-target-cell="annotated-cell-141" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-141" data-code-lines="6" data-code-annotation="4"><code>md[tbl]</code> is a sub-table, currently with three fields, <code>size</code>, <code>array</code> and <code>simple</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-141" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-141" data-code-lines="32" data-code-annotation="5">If we hit a sub-table, we recurse using <code>process</code>. The <code>md</code> table does not need recomputing and continues to be available as we process <code>v</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-141" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-141" data-code-lines="44" data-code-annotation="6">Most of the source lines in <code>table_string</code> are in the private <code>process</code> sub-function. We have <code>md</code> and get the ball rolling by running <code>process</code> on <code>root_tbl</code>.</span>
</dd>
</dl>
</section>
<section id="cyclical-references" class="level2">
<h2 class="anchored" data-anchor-id="cyclical-references">Cyclical References</h2>
<p>If we look at a simple linked list example:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">stars</span> <span class="op">=</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">c1</span> <span class="op">=</span> <span class="op">{</span> <span class="va">first</span> <span class="op">=</span> <span class="st">"Mickey"</span><span class="op">,</span> <span class="va">last</span> <span class="op">=</span> <span class="st">"Mouse"</span><span class="op">},</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">c2</span> <span class="op">=</span> <span class="op">{</span> <span class="va">first</span> <span class="op">=</span> <span class="st">"Minnie"</span><span class="op">,</span> <span class="va">last</span> <span class="op">=</span> <span class="st">"Mouse"</span><span class="op">},</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="va">stars</span><span class="op">.</span><span class="va">c1</span><span class="op">.</span><span class="va">next</span> <span class="op">=</span> <span class="va">stars</span><span class="op">.</span><span class="va">c2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then <code>print(pretty(stars))</code> returns:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    c1 =</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>        next = {</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>            first = Minnie,</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>            last = Mouse</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>        first = Mickey,</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>        last = Mouse</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    c2 = {</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>        first = Minnie,</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>        last = Mouse</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We see two definitions of <code>c2</code>! <br> One is in the <code>next</code> field for <code>c1</code> and another when we get to <code>c2</code> by itself. That’s not ideal.</p>
<p>Things get worse if we use a <em>doubly</em> linked list by adding:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="va">stars</span><span class="op">.</span><span class="va">c2</span><span class="op">.</span><span class="va">prev</span> <span class="op">=</span> <span class="va">stars</span><span class="op">.</span><span class="va">c1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, when we try <code>print(pretty(stars))</code> the program will crash with a message like</p>
<div class="sourceCode" id="annotated-cell-145"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-145" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-145-1" class="code-annotation-target"><a href="#annotated-cell-145-1" aria-hidden="true" tabindex="-1"></a>/path/to/script: stack overflow</span>
<span id="annotated-cell-145-2"><a href="#annotated-cell-145-2" aria-hidden="true" tabindex="-1"></a>stack traceback:</span>
<span id="annotated-cell-145-3"><a href="#annotated-cell-145-3" aria-hidden="true" tabindex="-1"></a> /path/to/script:49: in function 'table_size_and_type'</span>
<span id="annotated-cell-145-4"><a href="#annotated-cell-145-4" aria-hidden="true" tabindex="-1"></a> /path/to/script:98: in function 'table_string'</span>
<span id="annotated-cell-145-5"><a href="#annotated-cell-145-5" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-6"><a href="#annotated-cell-145-6" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-7"><a href="#annotated-cell-145-7" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-8"><a href="#annotated-cell-145-8" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-9"><a href="#annotated-cell-145-9" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-10"><a href="#annotated-cell-145-10" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-11"><a href="#annotated-cell-145-11" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-12"><a href="#annotated-cell-145-12" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-145" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-145-13" class="code-annotation-target"><a href="#annotated-cell-145-13" aria-hidden="true" tabindex="-1"></a> ... (skipping 58803 levels)</span>
<span id="annotated-cell-145-14"><a href="#annotated-cell-145-14" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-15"><a href="#annotated-cell-145-15" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-16"><a href="#annotated-cell-145-16" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-17"><a href="#annotated-cell-145-17" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-18"><a href="#annotated-cell-145-18" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-19"><a href="#annotated-cell-145-19" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-20"><a href="#annotated-cell-145-20" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-21"><a href="#annotated-cell-145-21" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<span id="annotated-cell-145-22"><a href="#annotated-cell-145-22" aria-hidden="true" tabindex="-1"></a> /path/to/script: in function 'table_string'</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-145" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-145-23" class="code-annotation-target"><a href="#annotated-cell-145-23" aria-hidden="true" tabindex="-1"></a> (...tail calls...)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-145" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-145" data-code-lines="1" data-code-annotation="1">Lua’s interpreter has run out of room.</span>
</dd>
<dt data-target-cell="annotated-cell-145" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-145" data-code-lines="13" data-code-annotation="2">That’s a lot of skipping!</span>
</dd>
<dt data-target-cell="annotated-cell-145" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-145" data-code-lines="23" data-code-annotation="3">It’s more like tail chasing in this instance!</span>
</dd>
</dl>
<p>It is easy to see what the issue is. When we convert <code>c1</code> to a string, it encounters a sub-table <code>c2</code>. Our function then calls itself with a request to convert <code>c2</code> to a string. That call, in its turn, will encounter <code>c2.prev = c1</code> and see that <code>c1</code> is a table. It handles that by calling itself with a request to convert <code>c1</code> to a string. And round and round we go!</p>
<p>Our current solution doesn’t handle tables with shared references well. Even if it manages to complete, the shared table will be defined multiple times. The situation is even worse if there are cycles to be navigated. Those cause the program to crash with a stack overflow,</p>
<p>Lua makes it very easy to have tables with multiple references and cycles. Under the covers, the assignment <code>c2.prev = c1</code> sets up another <em>pointer</em> to <code>c1</code>. No copying is done; everything is very efficient.</p>
<p>That’s great for many algorithms you might use beyond the most straightforward, plain old data tables. We still need to examine and view those tables without crashes.</p>
<section id="crash-proofing" class="level3">
<h3 class="anchored" data-anchor-id="crash-proofing">Crash Proofing</h3>
<p>The key to handling tables with cycles and shared references is marking those tables we have already put out a full string definition for. If we see those marked tables again, we can do something more sensible than trying to define them again and potentially going around in circles.</p>
<p>Our <code>metadata</code> function returns a metadata table for each table and sub-table it encounters. Currently, there are just three fields in that metadata table: <code>size</code>, <code>array</code>, and <code>simple</code>. We can add a fourth field, <code>processed</code>, that will be <code>true</code> if we have already seen and processed that table. If the <code>processed</code> field is <code>true</code>, we can print a simple reference to the table instead of trying to define it again. If the field is <em>missing</em>, we can define the table as we do now.</p>
<p>Here is what the <code>table_string</code> function looks like with the <code>processed</code> field added:</p>
<div class="sourceCode" id="annotated-cell-146"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-146-1"><a href="#annotated-cell-146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-146-2"><a href="#annotated-cell-146-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-146-3"><a href="#annotated-cell-146-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">md</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-146-4"><a href="#annotated-cell-146-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-146-5"><a href="#annotated-cell-146-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="kw">function</span> process<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-146" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-146-6" class="code-annotation-target"><a href="#annotated-cell-146-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">processed</span> <span class="op">=</span> <span class="kw">true</span></span>
<span id="annotated-cell-146-7"><a href="#annotated-cell-146-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-146-8"><a href="#annotated-cell-146-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> iter<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-146-9"><a href="#annotated-cell-146-9" aria-hidden="true" tabindex="-1"></a>            <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-146-10"><a href="#annotated-cell-146-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="annotated-cell-146-11"><a href="#annotated-cell-146-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-146-12"><a href="#annotated-cell-146-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-146-13"><a href="#annotated-cell-146-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">processed</span> <span class="cf">then</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-146" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-146-14" class="code-annotation-target"><a href="#annotated-cell-146-14" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> simple_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-146-15"><a href="#annotated-cell-146-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-146" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-146-16" class="code-annotation-target"><a href="#annotated-cell-146-16" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> process<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-146-17"><a href="#annotated-cell-146-17" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> indent_string<span class="op">(</span><span class="va">v_string</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span><span class="op">,</span> <span class="va">delims</span><span class="op">)</span></span>
<span id="annotated-cell-146-18"><a href="#annotated-cell-146-18" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">delims</span> <span class="op">==</span> <span class="kw">false</span> <span class="kw">and</span> <span class="va">show_keys</span> <span class="cf">then</span> <span class="va">v_string</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">v_string</span> <span class="cf">end</span></span>
<span id="annotated-cell-146-19"><a href="#annotated-cell-146-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="annotated-cell-146-20"><a href="#annotated-cell-146-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">...</span></span>
<span id="annotated-cell-146-21"><a href="#annotated-cell-146-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-146-22"><a href="#annotated-cell-146-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-146-23"><a href="#annotated-cell-146-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-146-24"><a href="#annotated-cell-146-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-146-25"><a href="#annotated-cell-146-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">retval</span> <span class="op">=</span> process<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span></span>
<span id="annotated-cell-146-26"><a href="#annotated-cell-146-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-146-27"><a href="#annotated-cell-146-27" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-146" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-146" data-code-lines="6" data-code-annotation="1">We are about to process <code>tbl</code>, so we mark it as processed in case it has a self-reference.</span>
</dd>
<dt data-target-cell="annotated-cell-146" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-146" data-code-lines="14" data-code-annotation="2">We have seen <code>v</code> before and can do something else instead of recursing. <br> Here, we print a reference to the table’s address.</span>
</dd>
<dt data-target-cell="annotated-cell-146" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-146" data-code-lines="16" data-code-annotation="3">Recurse into <code>v</code> and build up a complete definition for it.</span>
</dd>
</dl>
<p>Now, if you try <code>print(pretty(stars))</code> on our doubly linked list of stars, you get something like this:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    c1 = {</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>        first = "Mickey",</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>        last = "Mouse",</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>        next = {</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>            first = "Minnie",</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>            last = "Mouse",</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>            prev = 0x600002ec0ec0</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    c2 = 0x600002ec0f00,</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol type="1">
<li>The shared references are just table addresses, which isn’t user-friendly but better than crashing!</li>
</ol>
<p>We can even add a self-reference to the <code>stars</code> table like this:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="va">stars</span><span class="op">.</span><span class="va">home</span> <span class="op">=</span> <span class="va">stars</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then <code>print(pretty(stars))</code> yields:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    c1 = {</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>        first = "Mickey",</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>        last = "Mouse",</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>        next = {</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>            first = "Minnie",</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>            last = "Mouse",</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>            prev = 0x6000012ecec0</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    c2 = 0x6000012ecf00,</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    home = 0x6000012ece80</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="paths" class="level3">
<h3 class="anchored" data-anchor-id="paths">Paths</h3>
<p>That output is not very user-friendly.</p>
<p>How should we see those references? Ideally, we should see an understandable <em>description</em> of the reference.</p>
<p>Every table has a unique address in Lua, which we could use. However, as we saw above, that’s not very user-friendly. We could use the key in the table that points to the shared table. That is better, but still not great. We could use a path to the table from the top-level root table. This is the best option.</p>
<p>Then, in the case where there is no self-reference, we might see:</p>
<div class="sourceCode" id="annotated-cell-150"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-150-1"><a href="#annotated-cell-150-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="annotated-cell-150-2"><a href="#annotated-cell-150-2" aria-hidden="true" tabindex="-1"></a>    c2 = {</span>
<span id="annotated-cell-150-3"><a href="#annotated-cell-150-3" aria-hidden="true" tabindex="-1"></a>        first = Minnie,</span>
<span id="annotated-cell-150-4"><a href="#annotated-cell-150-4" aria-hidden="true" tabindex="-1"></a>        prev = {</span>
<span id="annotated-cell-150-5"><a href="#annotated-cell-150-5" aria-hidden="true" tabindex="-1"></a>            first = Mickey,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-150" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-150-6" class="code-annotation-target"><a href="#annotated-cell-150-6" aria-hidden="true" tabindex="-1"></a>            next = &lt;c1&gt;,</span>
<span id="annotated-cell-150-7"><a href="#annotated-cell-150-7" aria-hidden="true" tabindex="-1"></a>            last = Mouse</span>
<span id="annotated-cell-150-8"><a href="#annotated-cell-150-8" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="annotated-cell-150-9"><a href="#annotated-cell-150-9" aria-hidden="true" tabindex="-1"></a>        last = Mouse</span>
<span id="annotated-cell-150-10"><a href="#annotated-cell-150-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-150" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-150-11" class="code-annotation-target"><a href="#annotated-cell-150-11" aria-hidden="true" tabindex="-1"></a>    c1 = &lt;c2.prev&gt;</span>
<span id="annotated-cell-150-12"><a href="#annotated-cell-150-12" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-150" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-150" data-code-lines="6" data-code-annotation="1">The value of <code>next</code> refers to the table at the path <code>c1</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-150" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-150" data-code-lines="11" data-code-annotation="2">The value of <code>c1</code> refers to the table at the path <code>c2.prev</code>.</span>
</dd>
</dl>
<p>If the root table is <code>tbl</code>, then the path <code>"&lt;foo.bar.baz&gt;"</code> refers to the value <code>tbl.foo.bar.baz</code>. Thus, <code>foo</code> is a sub-table of <code>tbl</code>, <code>bar</code> is a sub-table of <code>foo</code>, and <code>baz</code> is a value in <code>bar</code>.</p>
<p>If there is a self-reference, such as <code>stars.home = stars</code>, we might see:</p>
<div class="sourceCode" id="annotated-cell-151"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-151" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-151-1" class="code-annotation-target"><a href="#annotated-cell-151-1" aria-hidden="true" tabindex="-1"></a>&lt;table&gt; = {</span>
<span id="annotated-cell-151-2"><a href="#annotated-cell-151-2" aria-hidden="true" tabindex="-1"></a>    c2 = {</span>
<span id="annotated-cell-151-3"><a href="#annotated-cell-151-3" aria-hidden="true" tabindex="-1"></a>        first = Minnie,</span>
<span id="annotated-cell-151-4"><a href="#annotated-cell-151-4" aria-hidden="true" tabindex="-1"></a>        prev = {</span>
<span id="annotated-cell-151-5"><a href="#annotated-cell-151-5" aria-hidden="true" tabindex="-1"></a>            first = Mickey,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-151" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-151-6" class="code-annotation-target"><a href="#annotated-cell-151-6" aria-hidden="true" tabindex="-1"></a>            next = &lt;c1&gt;,</span>
<span id="annotated-cell-151-7"><a href="#annotated-cell-151-7" aria-hidden="true" tabindex="-1"></a>            last = Mouse</span>
<span id="annotated-cell-151-8"><a href="#annotated-cell-151-8" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="annotated-cell-151-9"><a href="#annotated-cell-151-9" aria-hidden="true" tabindex="-1"></a>        last = Mouse</span>
<span id="annotated-cell-151-10"><a href="#annotated-cell-151-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="annotated-cell-151-11"><a href="#annotated-cell-151-11" aria-hidden="true" tabindex="-1"></a>    c1 = &lt;c2.prev&gt;,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-151" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-151-12" class="code-annotation-target"><a href="#annotated-cell-151-12" aria-hidden="true" tabindex="-1"></a>    home = &lt;table&gt;</span>
<span id="annotated-cell-151-13"><a href="#annotated-cell-151-13" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-151" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-151" data-code-lines="1" data-code-annotation="1">We only put out the <code>&lt;table&gt; = ...</code> line <strong>if</strong> there is a self-reference.</span>
</dd>
<dt data-target-cell="annotated-cell-151" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-151" data-code-lines="6" data-code-annotation="2">We could use the full path, <code>&lt;table.c1&gt;</code>, here, but that is generally overkill.</span>
</dd>
<dt data-target-cell="annotated-cell-151" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-151" data-code-lines="12" data-code-annotation="3">The value of <code>home</code> refers to the table itself.</span>
</dd>
</dl>
<p>In this representation, there are some obvious user-settable options: - The string used for the root table if there are any top-level self-references. In the example, we use <code>table</code> for that. - The separator to use in the path string to sub-sub-tables etc. In the example, we use<code>"."</code>. - Perhaps the delimiters to use for path strings, which in the example are <code>&lt;</code> and <code>&gt;</code>.</p>
<p>Let’s add those to our <code>options.pretty</code> table:</p>
<div class="sourceCode" id="annotated-cell-152"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-152-1"><a href="#annotated-cell-152-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">options</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-152-2"><a href="#annotated-cell-152-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">pretty</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="annotated-cell-152-3"><a href="#annotated-cell-152-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>        <span class="op">=</span> <span class="st">'    '</span><span class="op">,</span></span>
<span id="annotated-cell-152-4"><a href="#annotated-cell-152-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_begin</span>   <span class="op">=</span> <span class="st">'{'</span><span class="op">,</span></span>
<span id="annotated-cell-152-5"><a href="#annotated-cell-152-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_end</span>     <span class="op">=</span> <span class="st">'}'</span><span class="op">,</span></span>
<span id="annotated-cell-152-6"><a href="#annotated-cell-152-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_begin</span>   <span class="op">=</span> <span class="st">'['</span><span class="op">,</span></span>
<span id="annotated-cell-152-7"><a href="#annotated-cell-152-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_end</span>     <span class="op">=</span> <span class="st">']'</span><span class="op">,</span></span>
<span id="annotated-cell-152-8"><a href="#annotated-cell-152-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_begin</span>     <span class="op">=</span> <span class="st">''</span><span class="op">,</span></span>
<span id="annotated-cell-152-9"><a href="#annotated-cell-152-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_end</span>       <span class="op">=</span> <span class="st">' = '</span><span class="op">,</span></span>
<span id="annotated-cell-152-10"><a href="#annotated-cell-152-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span>           <span class="op">=</span> <span class="st">','</span><span class="op">,</span></span>
<span id="annotated-cell-152-11"><a href="#annotated-cell-152-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_spacer</span> <span class="op">=</span> <span class="st">' '</span><span class="op">,</span></span>
<span id="annotated-cell-152-12"><a href="#annotated-cell-152-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">show_indices</span>  <span class="op">=</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="annotated-cell-152-13"><a href="#annotated-cell-152-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">comparator</span>    <span class="op">=</span> <span class="va">compare</span><span class="op">,</span></span>
<span id="annotated-cell-152-14"><a href="#annotated-cell-152-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_size</span>   <span class="op">=</span> <span class="fu">math.huge</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-152" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-152-15" class="code-annotation-target"><a href="#annotated-cell-152-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_root</span>     <span class="op">=</span> <span class="st">'table'</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-152" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-152-16" class="code-annotation-target"><a href="#annotated-cell-152-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_sep</span>      <span class="op">=</span> <span class="st">'.'</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-152" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-152-17" class="code-annotation-target"><a href="#annotated-cell-152-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_begin</span>    <span class="op">=</span> <span class="st">'&lt;'</span><span class="op">,</span></span>
<span id="annotated-cell-152-18"><a href="#annotated-cell-152-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_end</span>      <span class="op">=</span> <span class="st">'&gt;'</span></span>
<span id="annotated-cell-152-19"><a href="#annotated-cell-152-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-152" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-152" data-code-lines="15" data-code-annotation="1">The string for the root table if there are any top-level self-references.</span>
</dd>
<dt data-target-cell="annotated-cell-152" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-152" data-code-lines="16" data-code-annotation="2">The separator used in the path string to sub-sub-tables, etc.</span>
</dd>
<dt data-target-cell="annotated-cell-152" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-152" data-code-lines="17" data-code-annotation="3">The delimiters used for the path string.</span>
</dd>
</dl>
<p>With that in place, we can modify the <code>table_string</code> function as follows:</p>
<div class="sourceCode" id="annotated-cell-153"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-153-1"><a href="#annotated-cell-153-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-153-2"><a href="#annotated-cell-153-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-153-3"><a href="#annotated-cell-153-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">md</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span></span>
<span id="annotated-cell-153-4"><a href="#annotated-cell-153-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-153" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-153-5" class="code-annotation-target"><a href="#annotated-cell-153-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="kw">function</span> process<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">path</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-153" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-153-6" class="code-annotation-target"><a href="#annotated-cell-153-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">path</span> <span class="op">=</span> <span class="va">path</span></span>
<span id="annotated-cell-153-7"><a href="#annotated-cell-153-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-153-8"><a href="#annotated-cell-153-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">size</span>   <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">size</span></span>
<span id="annotated-cell-153-9"><a href="#annotated-cell-153-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">size</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">then</span> <span class="cf">return</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-153-10"><a href="#annotated-cell-153-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-153-11"><a href="#annotated-cell-153-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">array</span>  <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">array</span></span>
<span id="annotated-cell-153-12"><a href="#annotated-cell-153-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">show_keys</span> <span class="op">=</span> <span class="kw">not</span> <span class="va">array</span> <span class="kw">and</span> <span class="kw">true</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">show_indices</span></span>
<span id="annotated-cell-153-13"><a href="#annotated-cell-153-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-153-14"><a href="#annotated-cell-153-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">simple</span> <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">subs</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">size</span> <span class="op">&lt;</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_size</span></span>
<span id="annotated-cell-153-15"><a href="#annotated-cell-153-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">simple</span> <span class="kw">and</span> <span class="st">''</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-153-16"><a href="#annotated-cell-153-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-153-17"><a href="#annotated-cell-153-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">tb</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_begin</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span></span>
<span id="annotated-cell-153-18"><a href="#annotated-cell-153-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">te</span>     <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_end</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-153-19"><a href="#annotated-cell-153-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-153" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-153-20" class="code-annotation-target"><a href="#annotated-cell-153-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">pb</span><span class="op">,</span> <span class="va">pe</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_end</span></span>
<span id="annotated-cell-153-21"><a href="#annotated-cell-153-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">nl</span>     <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-153-22"><a href="#annotated-cell-153-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">sep</span>    <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-153-23"><a href="#annotated-cell-153-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-153-24"><a href="#annotated-cell-153-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">delims</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">~=</span> <span class="st">''</span></span>
<span id="annotated-cell-153-25"><a href="#annotated-cell-153-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">delims</span> <span class="cf">then</span> <span class="va">tb</span><span class="op">,</span> <span class="va">te</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">nl</span><span class="op">,</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">te</span>  <span class="cf">else</span> <span class="va">indent</span> <span class="op">=</span> <span class="st">''</span> <span class="cf">end</span></span>
<span id="annotated-cell-153-26"><a href="#annotated-cell-153-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-153-27"><a href="#annotated-cell-153-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-153-28"><a href="#annotated-cell-153-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-153-29"><a href="#annotated-cell-153-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">iter</span> <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="fu">ipairs</span> <span class="kw">or</span> ordered_pairs<span class="op">(</span><span class="va">opts</span><span class="op">.</span><span class="va">comparator</span><span class="op">)</span></span>
<span id="annotated-cell-153-30"><a href="#annotated-cell-153-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> iter<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-153-31"><a href="#annotated-cell-153-31" aria-hidden="true" tabindex="-1"></a>            <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-153-32"><a href="#annotated-cell-153-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="annotated-cell-153-33"><a href="#annotated-cell-153-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-153-34"><a href="#annotated-cell-153-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-153-35"><a href="#annotated-cell-153-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">path</span> <span class="cf">then</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-153" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-153-36" class="code-annotation-target"><a href="#annotated-cell-153-36" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> <span class="va">pb</span> <span class="op">..</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">path</span> <span class="op">..</span> <span class="va">pe</span></span>
<span id="annotated-cell-153-37"><a href="#annotated-cell-153-37" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-153" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-153-38" class="code-annotation-target"><a href="#annotated-cell-153-38" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">local</span> <span class="va">v_path</span> <span class="op">=</span> <span class="va">path</span> <span class="op">..</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_sep</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span></span>
<span id="annotated-cell-153-39"><a href="#annotated-cell-153-39" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> process<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">v_path</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-153" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-153-40" class="code-annotation-target"><a href="#annotated-cell-153-40" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> indent_string<span class="op">(</span><span class="va">v_string</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span><span class="op">,</span> <span class="va">delims</span><span class="op">)</span></span>
<span id="annotated-cell-153-41"><a href="#annotated-cell-153-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">delims</span> <span class="op">==</span> <span class="kw">false</span> <span class="kw">and</span> <span class="va">show_keys</span> <span class="cf">then</span> <span class="va">v_string</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">v_string</span> <span class="cf">end</span></span>
<span id="annotated-cell-153-42"><a href="#annotated-cell-153-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="annotated-cell-153-43"><a href="#annotated-cell-153-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="annotated-cell-153-44"><a href="#annotated-cell-153-44" aria-hidden="true" tabindex="-1"></a>                <span class="va">v_string</span> <span class="op">=</span> simple_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-153-45"><a href="#annotated-cell-153-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="annotated-cell-153-46"><a href="#annotated-cell-153-46" aria-hidden="true" tabindex="-1"></a>            <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-153-47"><a href="#annotated-cell-153-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-153-48"><a href="#annotated-cell-153-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-153-49"><a href="#annotated-cell-153-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-153-50"><a href="#annotated-cell-153-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-153-51"><a href="#annotated-cell-153-51" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-153" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-153-52" class="code-annotation-target"><a href="#annotated-cell-153-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">retval</span> <span class="op">=</span> process<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_root</span><span class="op">)</span></span>
<span id="annotated-cell-153-53"><a href="#annotated-cell-153-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-153-54"><a href="#annotated-cell-153-54" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-153" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-153" data-code-lines="5" data-code-annotation="1">We have added an extra <code>path</code> argument.</span>
</dd>
<dt data-target-cell="annotated-cell-153" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-153" data-code-lines="6" data-code-annotation="2">We record the path to this table <code>tbl</code> as the value under the metadata key <code>path</code> in <code>md[tbl]</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-153" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-153" data-code-lines="20" data-code-annotation="3">Localise the path-begin and path-end delimiters.</span>
</dd>
<dt data-target-cell="annotated-cell-153" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-153" data-code-lines="36" data-code-annotation="4">If we have seen <code>v</code> before, we use the path string we stored in <code>md</code> for <code>v</code>, formatted with the delimiters.</span>
</dd>
<dt data-target-cell="annotated-cell-153" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-153" data-code-lines="38" data-code-annotation="5"><code>v</code> is a new table, so we need a path to <code>v</code>, which we get by appending the key <code>k</code> to the current path.</span>
</dd>
<dt data-target-cell="annotated-cell-153" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-153" data-code-lines="40" data-code-annotation="6">We recurse processing the contents of <code>v</code> using that new path string.</span>
</dd>
<dt data-target-cell="annotated-cell-153" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-153" data-code-lines="52" data-code-annotation="7">Kick off the process with the root table and path.</span>
</dd>
</dl>
<p>Now, if you try <code>print(pretty(stars))</code> on our doubly linked list of stars, we get:</p>
<div class="sourceCode" id="annotated-cell-154"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-154-1"><a href="#annotated-cell-154-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="annotated-cell-154-2"><a href="#annotated-cell-154-2" aria-hidden="true" tabindex="-1"></a>    c1 = {</span>
<span id="annotated-cell-154-3"><a href="#annotated-cell-154-3" aria-hidden="true" tabindex="-1"></a>        first = Mickey,</span>
<span id="annotated-cell-154-4"><a href="#annotated-cell-154-4" aria-hidden="true" tabindex="-1"></a>        last = Mouse,</span>
<span id="annotated-cell-154-5"><a href="#annotated-cell-154-5" aria-hidden="true" tabindex="-1"></a>        next = {</span>
<span id="annotated-cell-154-6"><a href="#annotated-cell-154-6" aria-hidden="true" tabindex="-1"></a>            first = Minnie,</span>
<span id="annotated-cell-154-7"><a href="#annotated-cell-154-7" aria-hidden="true" tabindex="-1"></a>            last = Mouse,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-154" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-154-8" class="code-annotation-target"><a href="#annotated-cell-154-8" aria-hidden="true" tabindex="-1"></a>            prev = &lt;table.c1&gt;</span>
<span id="annotated-cell-154-9"><a href="#annotated-cell-154-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="annotated-cell-154-10"><a href="#annotated-cell-154-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="annotated-cell-154-11"><a href="#annotated-cell-154-11" aria-hidden="true" tabindex="-1"></a>    c2 = &lt;table.c1.next&gt;,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-154" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-154-12" class="code-annotation-target"><a href="#annotated-cell-154-12" aria-hidden="true" tabindex="-1"></a>    home = &lt;table&gt;</span>
<span id="annotated-cell-154-13"><a href="#annotated-cell-154-13" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-154" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-154" data-code-lines="8" data-code-annotation="1">The value of <code>prev</code> refers to the path <code>table.c1</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-154" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-154" data-code-lines="12" data-code-annotation="2">The value of <code>home</code> refers to the table itself.</span>
</dd>
</dl>
<p>In a reference like <code>&lt;table.c1.next&gt;</code>, the root path prefix <code>table.</code> isn’t necessary. We will remove it in the next iteration.</p>
<p>Complete self-references like our <code>home = &lt;table&gt;</code> line are uncommon, but we would like to have that <code>&lt;table&gt;</code> defined if it does occur. Something along these lines:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>&lt;table&gt; = {</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a> ...</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, that extra <code>&lt;table&gt; =</code> should only be present if there is a self-reference.</p>
<p>We can alter <code>table_string</code> as follows:</p>
<div class="sourceCode" id="annotated-cell-156"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-156-1"><a href="#annotated-cell-156-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-156-2"><a href="#annotated-cell-156-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-156-3"><a href="#annotated-cell-156-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">md</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span></span>
<span id="annotated-cell-156-4"><a href="#annotated-cell-156-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-156" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-156-5" class="code-annotation-target"><a href="#annotated-cell-156-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">root</span> <span class="op">=</span> <span class="va">root_tbl</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-156" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-156-6" class="code-annotation-target"><a href="#annotated-cell-156-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">root_ref</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="annotated-cell-156-7"><a href="#annotated-cell-156-7" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-156" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-156-8" class="code-annotation-target"><a href="#annotated-cell-156-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">kb</span><span class="op">,</span> <span class="va">ke</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">key_end</span></span>
<span id="annotated-cell-156-9"><a href="#annotated-cell-156-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">pb</span><span class="op">,</span> <span class="va">pe</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_begin</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_end</span></span>
<span id="annotated-cell-156-10"><a href="#annotated-cell-156-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-156-11"><a href="#annotated-cell-156-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="kw">function</span> process<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">path</span><span class="op">)</span></span>
<span id="annotated-cell-156-12"><a href="#annotated-cell-156-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">path</span> <span class="op">=</span> <span class="va">path</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-156" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-156-13" class="code-annotation-target"><a href="#annotated-cell-156-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">path_prefix</span> <span class="op">=</span> <span class="va">path</span> <span class="op">==</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_root</span> <span class="kw">and</span> <span class="st">''</span> <span class="kw">or</span> <span class="va">path</span> <span class="op">..</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_sep</span></span>
<span id="annotated-cell-156-14"><a href="#annotated-cell-156-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-156-15"><a href="#annotated-cell-156-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">size</span> <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">size</span></span>
<span id="annotated-cell-156-16"><a href="#annotated-cell-156-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">size</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">then</span> <span class="cf">return</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-156-17"><a href="#annotated-cell-156-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-156-18"><a href="#annotated-cell-156-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">array</span> <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">array</span></span>
<span id="annotated-cell-156-19"><a href="#annotated-cell-156-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">show_keys</span> <span class="op">=</span> <span class="kw">not</span> <span class="va">array</span> <span class="kw">and</span> <span class="kw">true</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">show_indices</span></span>
<span id="annotated-cell-156-20"><a href="#annotated-cell-156-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-156-21"><a href="#annotated-cell-156-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">simple</span> <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">subs</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">size</span> <span class="op">&lt;</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_size</span></span>
<span id="annotated-cell-156-22"><a href="#annotated-cell-156-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">indent</span> <span class="op">=</span> <span class="va">simple</span> <span class="kw">and</span> <span class="st">''</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span></span>
<span id="annotated-cell-156-23"><a href="#annotated-cell-156-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-156-24"><a href="#annotated-cell-156-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">tb</span> <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_begin</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_begin</span></span>
<span id="annotated-cell-156-25"><a href="#annotated-cell-156-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">te</span> <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">array_end</span> <span class="kw">or</span> <span class="va">opts</span><span class="op">.</span><span class="va">table_end</span></span>
<span id="annotated-cell-156-26"><a href="#annotated-cell-156-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">nl</span> <span class="op">=</span> <span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">opts</span><span class="op">.</span><span class="va">inline_spacer</span> <span class="kw">or</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span></span>
<span id="annotated-cell-156-27"><a href="#annotated-cell-156-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">sep</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">sep</span> <span class="op">..</span> <span class="va">nl</span></span>
<span id="annotated-cell-156-28"><a href="#annotated-cell-156-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-156-29"><a href="#annotated-cell-156-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">delims</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">~=</span> <span class="st">''</span></span>
<span id="annotated-cell-156-30"><a href="#annotated-cell-156-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">delims</span> <span class="cf">then</span> <span class="va">tb</span><span class="op">,</span> <span class="va">te</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">nl</span><span class="op">,</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">te</span> <span class="cf">else</span> <span class="va">indent</span> <span class="op">=</span> <span class="st">''</span> <span class="cf">end</span></span>
<span id="annotated-cell-156-31"><a href="#annotated-cell-156-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-156-32"><a href="#annotated-cell-156-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">content</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-156-33"><a href="#annotated-cell-156-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-156-34"><a href="#annotated-cell-156-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">iter</span> <span class="op">=</span> <span class="va">array</span> <span class="kw">and</span> <span class="fu">ipairs</span> <span class="kw">or</span> ordered_pairs<span class="op">(</span><span class="va">opts</span><span class="op">.</span><span class="va">comparator</span><span class="op">)</span></span>
<span id="annotated-cell-156-35"><a href="#annotated-cell-156-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> iter<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-156-36"><a href="#annotated-cell-156-36" aria-hidden="true" tabindex="-1"></a>            <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-156-37"><a href="#annotated-cell-156-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="annotated-cell-156-38"><a href="#annotated-cell-156-38" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-156-39"><a href="#annotated-cell-156-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-156-40"><a href="#annotated-cell-156-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">path</span> <span class="cf">then</span></span>
<span id="annotated-cell-156-41"><a href="#annotated-cell-156-41" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> <span class="va">pb</span> <span class="op">..</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">path</span> <span class="op">..</span> <span class="va">pe</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-156" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-156-42" class="code-annotation-target"><a href="#annotated-cell-156-42" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">v</span> <span class="op">==</span> <span class="va">root</span> <span class="cf">then</span> <span class="va">root_ref</span> <span class="op">=</span> <span class="kw">true</span> <span class="cf">end</span></span>
<span id="annotated-cell-156-43"><a href="#annotated-cell-156-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-156" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-156-44" class="code-annotation-target"><a href="#annotated-cell-156-44" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">local</span> <span class="va">v_path</span> <span class="op">=</span> <span class="va">path_prefix</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span></span>
<span id="annotated-cell-156-45"><a href="#annotated-cell-156-45" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> process<span class="op">(</span><span class="va">v</span><span class="op">,</span> <span class="va">v_path</span><span class="op">)</span></span>
<span id="annotated-cell-156-46"><a href="#annotated-cell-156-46" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> indent_string<span class="op">(</span><span class="va">v_string</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span><span class="op">,</span> <span class="va">delims</span><span class="op">)</span></span>
<span id="annotated-cell-156-47"><a href="#annotated-cell-156-47" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">delims</span> <span class="op">==</span> <span class="kw">false</span> <span class="kw">and</span> <span class="va">show_keys</span> <span class="cf">then</span> <span class="va">v_string</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">v_string</span> <span class="cf">end</span></span>
<span id="annotated-cell-156-48"><a href="#annotated-cell-156-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="annotated-cell-156-49"><a href="#annotated-cell-156-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="annotated-cell-156-50"><a href="#annotated-cell-156-50" aria-hidden="true" tabindex="-1"></a>                <span class="va">v_string</span> <span class="op">=</span> simple_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-156-51"><a href="#annotated-cell-156-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="annotated-cell-156-52"><a href="#annotated-cell-156-52" aria-hidden="true" tabindex="-1"></a>            <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-156-53"><a href="#annotated-cell-156-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-156-54"><a href="#annotated-cell-156-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-156-55"><a href="#annotated-cell-156-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-156-56"><a href="#annotated-cell-156-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-156-57"><a href="#annotated-cell-156-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-156-58"><a href="#annotated-cell-156-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">retval</span> <span class="op">=</span> process<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_root</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-156" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-156-59" class="code-annotation-target"><a href="#annotated-cell-156-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">root_ref</span> <span class="cf">then</span></span>
<span id="annotated-cell-156-60"><a href="#annotated-cell-156-60" aria-hidden="true" tabindex="-1"></a>        <span class="va">retval</span> <span class="op">=</span> <span class="va">pb</span> <span class="op">..</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_root</span> <span class="op">..</span> <span class="va">pe</span> <span class="op">..</span> <span class="st">' = '</span> <span class="op">..</span> <span class="va">retval</span></span>
<span id="annotated-cell-156-61"><a href="#annotated-cell-156-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-156-62"><a href="#annotated-cell-156-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-156-63"><a href="#annotated-cell-156-63" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-156" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-156" data-code-lines="5" data-code-annotation="1">We capture the root table in <code>root</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-156" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-156" data-code-lines="6" data-code-annotation="2">We capture whether there is a self-reference to the root table in <code>root_ref</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-156" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-156" data-code-lines="8" data-code-annotation="3">Localise some delimiters that never vary by context (hoist these constant lines from the <code>process</code> function).</span>
</dd>
<dt data-target-cell="annotated-cell-156" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-156" data-code-lines="13" data-code-annotation="4">If this is not the root table, we will prepend any new path with a path prefix.</span>
</dd>
<dt data-target-cell="annotated-cell-156" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-156" data-code-lines="42" data-code-annotation="5">We record the self-reference to the root table if <code>v</code> is the root table.</span>
</dd>
<dt data-target-cell="annotated-cell-156" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-156" data-code-lines="44" data-code-annotation="6">We prepend the path with the path prefix if <code>tbl</code> is not the root table.</span>
</dd>
<dt data-target-cell="annotated-cell-156" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-156" data-code-lines="59" data-code-annotation="7">If there is a self-reference to the root table, we prepend the return string with <code>&lt;table&gt; =</code>.</span>
</dd>
</dl>
<p>Here’s the output from the latest version of <code>print(pretty(stars))</code>:</p>
<div class="sourceCode" id="annotated-cell-157"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-157" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-157-1" class="code-annotation-target"><a href="#annotated-cell-157-1" aria-hidden="true" tabindex="-1"></a>&lt;table&gt; = {</span>
<span id="annotated-cell-157-2"><a href="#annotated-cell-157-2" aria-hidden="true" tabindex="-1"></a>    c1 = {</span>
<span id="annotated-cell-157-3"><a href="#annotated-cell-157-3" aria-hidden="true" tabindex="-1"></a>        first = Mickey,</span>
<span id="annotated-cell-157-4"><a href="#annotated-cell-157-4" aria-hidden="true" tabindex="-1"></a>        last = Mouse,</span>
<span id="annotated-cell-157-5"><a href="#annotated-cell-157-5" aria-hidden="true" tabindex="-1"></a>        next = {</span>
<span id="annotated-cell-157-6"><a href="#annotated-cell-157-6" aria-hidden="true" tabindex="-1"></a>            first = Minnie,</span>
<span id="annotated-cell-157-7"><a href="#annotated-cell-157-7" aria-hidden="true" tabindex="-1"></a>            last = Mouse,</span>
<span id="annotated-cell-157-8"><a href="#annotated-cell-157-8" aria-hidden="true" tabindex="-1"></a>            prev = &lt;c1&gt;</span>
<span id="annotated-cell-157-9"><a href="#annotated-cell-157-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="annotated-cell-157-10"><a href="#annotated-cell-157-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-157" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-157-11" class="code-annotation-target"><a href="#annotated-cell-157-11" aria-hidden="true" tabindex="-1"></a>    c2 = &lt;c1.next&gt;,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-157" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-157-12" class="code-annotation-target"><a href="#annotated-cell-157-12" aria-hidden="true" tabindex="-1"></a>    home = &lt;table&gt;</span>
<span id="annotated-cell-157-13"><a href="#annotated-cell-157-13" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-157" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-157" data-code-lines="1" data-code-annotation="1">There is a self-reference to the <code>stars</code> parent table, so we have prepended the string with <code>&lt;table&gt; =</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-157" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-157" data-code-lines="11" data-code-annotation="2">This looks better than <code>&lt;table.c1.next&gt;</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-157" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-157" data-code-lines="12" data-code-annotation="3">Here is the self-reference to the root table, which reads quite naturally.</span>
</dd>
</dl>
<p>If we remove the <code>stars.home = stars</code> assignment then <code>print(pretty(stars))</code> returns:</p>
<div class="sourceCode" id="annotated-cell-158"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-158" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-158-1" class="code-annotation-target"><a href="#annotated-cell-158-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="annotated-cell-158-2"><a href="#annotated-cell-158-2" aria-hidden="true" tabindex="-1"></a>    c1 = {</span>
<span id="annotated-cell-158-3"><a href="#annotated-cell-158-3" aria-hidden="true" tabindex="-1"></a>        next = {</span>
<span id="annotated-cell-158-4"><a href="#annotated-cell-158-4" aria-hidden="true" tabindex="-1"></a>            first = Minnie,</span>
<span id="annotated-cell-158-5"><a href="#annotated-cell-158-5" aria-hidden="true" tabindex="-1"></a>            prev = &lt;c1&gt;,</span>
<span id="annotated-cell-158-6"><a href="#annotated-cell-158-6" aria-hidden="true" tabindex="-1"></a>            last = Mouse</span>
<span id="annotated-cell-158-7"><a href="#annotated-cell-158-7" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="annotated-cell-158-8"><a href="#annotated-cell-158-8" aria-hidden="true" tabindex="-1"></a>        first = Mickey,</span>
<span id="annotated-cell-158-9"><a href="#annotated-cell-158-9" aria-hidden="true" tabindex="-1"></a>        last = Mouse</span>
<span id="annotated-cell-158-10"><a href="#annotated-cell-158-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="annotated-cell-158-11"><a href="#annotated-cell-158-11" aria-hidden="true" tabindex="-1"></a>    c2 = &lt;c1.next&gt;</span>
<span id="annotated-cell-158-12"><a href="#annotated-cell-158-12" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-158" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-158" data-code-lines="1" data-code-annotation="1">There is no self-reference, so we do not need that <code>&lt;table&gt; =</code> we saw earlier.</span>
</dd>
</dl>
</section>
</section>
<section id="breadth-first-traversal" class="level2">
<h2 class="anchored" data-anchor-id="breadth-first-traversal">Breadth First Traversal</h2>
<p>While that last output is undoubtedly valid, it fails the readability test.</p>
<p>That <code>c2 = &lt;c1.next&gt;</code> is perfectly correct, but you have to go back and find the definition of <code>c1</code> to understand what <code>c1.next</code> actually is. It would be much better to see the definition of <code>c2</code> right there, not nested inside <code>c1</code>. We are after something that looks like this:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a> c1 =</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a> {</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a> first = Minnie,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a> last = Mouse,</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a> next = &lt;c2&gt;</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a> },</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a> c2 =</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a> {</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a> first = Mickey,</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a> last = Mouse,</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a> prev = &lt;c1&gt;</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a> },</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a> home = &lt;table&gt;</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="border mb-3 pt-3 shadow border-2 border-primary rounded bg-light text-center fst-italic fs-4">
<p>We would like to see the full definition of tables at the shallowest possible depth.</p>
</div>
<p>The root problem is that we are traversing tables <em>depth-first</em>.</p>
<p>We process all the elements in <code>c1</code> before getting to <code>c2</code>. So when we see <code>c1.next</code>, we print the full definition of what <code>c2</code> really is. Then, later, when we get to <code>c2</code>, we see that we have already processed it and output it as a reference to <code>&lt;c1.next&gt;</code>. That is ass-backwards and <code>c1.next</code> should be the reference to <code>&lt;c2&gt;</code>, and the definition of <code>c2</code> should be deferred to later.</p>
<div class="admonition caution">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-caution" title="Caution"></i></td>
    <td class="content">
    
All the table-to-string implementations that are available on the web seem to have this problem, The depth-first traversal is a natural choice, but it doesn’t provide the most readable output.
</td></tr></tbody></table></div>
<p>We need to change the table traversal to be <em>breadth-first</em>. Then, we process the elements of <code>tbl</code> in the order they appear at the top level. If we encounter a sub-table, we will defer turning it to a string until after processing all the top-level elements.</p>
<p>To demonstrate, let’s see how breadth first traversal works for the simpler <code>metadata</code> method:</p>
<div class="sourceCode" id="annotated-cell-160"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-160-1"><a href="#annotated-cell-160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> metadata<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">md</span><span class="op">)</span></span>
<span id="annotated-cell-160-2"><a href="#annotated-cell-160-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">md</span> <span class="op">=</span> <span class="va">md</span> <span class="kw">or</span> <span class="op">{}</span></span>
<span id="annotated-cell-160-3"><a href="#annotated-cell-160-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">]</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-160-4"><a href="#annotated-cell-160-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span><span class="op">,</span> <span class="va">subs</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="dv">0</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-160" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-160-5" class="code-annotation-target"><a href="#annotated-cell-160-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">children</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-160-6"><a href="#annotated-cell-160-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-160-7"><a href="#annotated-cell-160-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">size</span> <span class="op">=</span> <span class="va">size</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-160-8"><a href="#annotated-cell-160-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">tbl</span><span class="op">[</span><span class="va">size</span><span class="op">]</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="va">array</span> <span class="op">=</span> <span class="kw">false</span> <span class="cf">end</span></span>
<span id="annotated-cell-160-9"><a href="#annotated-cell-160-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-160-10"><a href="#annotated-cell-160-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">subs</span> <span class="op">=</span> <span class="va">subs</span> <span class="op">+</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-160" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-160-11" class="code-annotation-target"><a href="#annotated-cell-160-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">]</span> <span class="cf">then</span> <span class="fu">table.insert</span><span class="op">(</span><span class="va">children</span><span class="op">,</span> <span class="va">v</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-160-12"><a href="#annotated-cell-160-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-160-13"><a href="#annotated-cell-160-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-160-14"><a href="#annotated-cell-160-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">size</span><span class="op">,</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">array</span><span class="op">,</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">subs</span> <span class="op">=</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span><span class="op">,</span> <span class="va">subs</span></span>
<span id="annotated-cell-160-15"><a href="#annotated-cell-160-15" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-160" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-160-16" class="code-annotation-target"><a href="#annotated-cell-160-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span> <span class="va">child</span> <span class="kw">in</span> <span class="fu">ipairs</span><span class="op">(</span><span class="va">children</span><span class="op">)</span> <span class="cf">do</span> metadata<span class="op">(</span><span class="va">child</span><span class="op">,</span> <span class="va">md</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-160-17"><a href="#annotated-cell-160-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">md</span></span>
<span id="annotated-cell-160-18"><a href="#annotated-cell-160-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-160" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-160" data-code-lines="5" data-code-annotation="1">We keep a list of the sub-tables we encounter.</span>
</dd>
<dt data-target-cell="annotated-cell-160" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-160" data-code-lines="11" data-code-annotation="2">If we encounter a sub-table, we add it to the list of children and defer immediate processing.</span>
</dd>
<dt data-target-cell="annotated-cell-160" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-160" data-code-lines="16" data-code-annotation="3">After processing all the top-level elements, we <em>then</em> process the children.</span>
</dd>
</dl>
<p>Changing the processing order in <code>metadata</code> doesn’t change the output. <code>print(pretty(metadata(stars)))</code> still gives:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>&lt;table&gt; = {</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a> c1 = {</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a> first = "Mickey",</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a> last = "Mouse",</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a> next = {</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a> first = "Minnie",</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a> last = "Mouse",</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a> prev = &lt;c1&gt;</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a> },</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a> c2 = &lt;c1.next&gt;,</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a> home = &lt;table&gt;</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We need to apply similar changes to the more complex <code>table_string</code> function:</p>
<div class="sourceCode" id="annotated-cell-162"><pre class="sourceCode lua code-annotation-code code-with-copy"><code class="sourceCode lua"><span id="annotated-cell-162-1"><a href="#annotated-cell-162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-162-2"><a href="#annotated-cell-162-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-162-3"><a href="#annotated-cell-162-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="kw">function</span> process<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">path</span><span class="op">)</span></span>
<span id="annotated-cell-162-4"><a href="#annotated-cell-162-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-162-5"><a href="#annotated-cell-162-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">children</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-162-6"><a href="#annotated-cell-162-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-162-7"><a href="#annotated-cell-162-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> iter<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-162-8"><a href="#annotated-cell-162-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">...</span></span>
<span id="annotated-cell-162-9"><a href="#annotated-cell-162-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-162-10"><a href="#annotated-cell-162-10" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">path</span> <span class="cf">then</span></span>
<span id="annotated-cell-162-11"><a href="#annotated-cell-162-11" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> <span class="va">pb</span> <span class="op">..</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">path</span> <span class="op">..</span> <span class="va">pe</span></span>
<span id="annotated-cell-162-12"><a href="#annotated-cell-162-12" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">v</span> <span class="op">==</span> <span class="va">root</span> <span class="cf">then</span> <span class="va">root_ref</span> <span class="op">=</span> <span class="kw">true</span> <span class="cf">end</span></span>
<span id="annotated-cell-162-13"><a href="#annotated-cell-162-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span></span>
<span id="annotated-cell-162-14"><a href="#annotated-cell-162-14" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">local</span> <span class="va">v_path</span> <span class="op">=</span> <span class="va">path_prefix</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span></span>
<span id="annotated-cell-162-15"><a href="#annotated-cell-162-15" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> simple_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-162-16"><a href="#annotated-cell-162-16" aria-hidden="true" tabindex="-1"></a>                    <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">path</span> <span class="op">=</span> <span class="va">v_path</span></span>
<span id="annotated-cell-162-17"><a href="#annotated-cell-162-17" aria-hidden="true" tabindex="-1"></a>                    <span class="va">children</span><span class="op">[</span><span class="va">v</span><span class="op">]</span> <span class="op">=</span> <span class="va">v_path</span></span>
<span id="annotated-cell-162-18"><a href="#annotated-cell-162-18" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">delims</span> <span class="op">==</span> <span class="kw">false</span> <span class="kw">and</span> <span class="va">show_keys</span> <span class="cf">then</span> <span class="va">v_string</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">v_string</span> <span class="cf">end</span></span>
<span id="annotated-cell-162-19"><a href="#annotated-cell-162-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="annotated-cell-162-20"><a href="#annotated-cell-162-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="annotated-cell-162-21"><a href="#annotated-cell-162-21" aria-hidden="true" tabindex="-1"></a>                <span class="va">v_string</span> <span class="op">=</span> <span class="va">v_string</span> <span class="op">..</span> simple_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-162-22"><a href="#annotated-cell-162-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="annotated-cell-162-23"><a href="#annotated-cell-162-23" aria-hidden="true" tabindex="-1"></a>            <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-162-24"><a href="#annotated-cell-162-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-162-25"><a href="#annotated-cell-162-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-162-26"><a href="#annotated-cell-162-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">retval</span> <span class="op">=</span> <span class="va">tb</span> <span class="op">..</span> <span class="va">content</span> <span class="op">..</span> <span class="va">te</span></span>
<span id="annotated-cell-162-27"><a href="#annotated-cell-162-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-162-28"><a href="#annotated-cell-162-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="va">child_table</span><span class="op">,</span> <span class="va">child_path</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">children</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-162-29"><a href="#annotated-cell-162-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">child_string</span> <span class="op">=</span> process<span class="op">(</span><span class="va">child_table</span><span class="op">,</span> <span class="va">child_path</span><span class="op">)</span></span>
<span id="annotated-cell-162-30"><a href="#annotated-cell-162-30" aria-hidden="true" tabindex="-1"></a>            <span class="va">child_string</span> <span class="op">=</span> indent_string<span class="op">(</span><span class="va">child_string</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span><span class="op">,</span> <span class="va">delims</span><span class="op">)</span></span>
<span id="annotated-cell-162-31"><a href="#annotated-cell-162-31" aria-hidden="true" tabindex="-1"></a>            <span class="va">retval</span> <span class="op">=</span> <span class="va">retval</span><span class="op">:</span><span class="fu">gsub</span><span class="op">(</span>simple_string<span class="op">(</span><span class="va">child_table</span><span class="op">),</span> <span class="va">child_string</span><span class="op">)</span></span>
<span id="annotated-cell-162-32"><a href="#annotated-cell-162-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-162-33"><a href="#annotated-cell-162-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-162-34"><a href="#annotated-cell-162-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-162-35"><a href="#annotated-cell-162-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-162-36"><a href="#annotated-cell-162-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">retval</span> <span class="op">=</span> process<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_root</span><span class="op">)</span></span>
<span id="annotated-cell-162-37"><a href="#annotated-cell-162-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">root_ref</span> <span class="cf">then</span> <span class="va">retval</span> <span class="op">=</span> <span class="va">pb</span> <span class="op">..</span> <span class="va">opts</span><span class="op">.</span><span class="va">path_root</span> <span class="op">..</span> <span class="va">pe</span> <span class="op">..</span> <span class="st">' = '</span> <span class="op">..</span> <span class="va">retval</span> <span class="cf">end</span></span>
<span id="annotated-cell-162-38"><a href="#annotated-cell-162-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">retval</span></span>
<span id="annotated-cell-162-39"><a href="#annotated-cell-162-39" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With that change, <code>print(pretty(stars))</code> now gives:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>&lt;table&gt; = {</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a> c1 = {</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a> first = "Mickey",</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a> last = "Mouse",</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a> next = &lt;c2&gt;</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a> },</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a> c2 = {</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a> first = "Minnie",</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a> last = "Mouse",</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a> prev = &lt;c1&gt;</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a> },</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a> home = &lt;table&gt;</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="arrays" class="level3">
<h3 class="anchored" data-anchor-id="arrays">Arrays</h3>
<p>That last table is very readable. Every shared reference like <code>c1.next = &lt;c2&gt;</code> has an easily identifiable right-hand side value, the value associated with the <em>key</em> <code>c2</code> in this case.</p>
<p>However, we have gone to some lengths to suppress showing explicit keys for Lua tables that happen to be arrays. If we have an array of arrays with shared references, the paths will lack clarity.</p>
<p>For example, perhaps you are coding a Cludeo-type murder mystery game set in a big house with many rooms stored as an array. Each room might have a potential murder weapon in it:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">rooms</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="va">name</span> <span class="op">=</span> <span class="st">"Library"</span><span class="op">,</span> <span class="va">weapon</span> <span class="op">=</span> <span class="st">"Lead Pipe"</span> <span class="op">},</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="va">name</span> <span class="op">=</span> <span class="st">"Kitchen"</span><span class="op">,</span> <span class="va">weapon</span> <span class="op">=</span> <span class="st">"Knife"</span>     <span class="op">},</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="va">name</span> <span class="op">=</span> <span class="st">"Lounge"</span><span class="op">,</span>  <span class="va">weapon</span> <span class="op">=</span> <span class="st">"Poison"</span>    <span class="op">},</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="va">name</span> <span class="op">=</span> <span class="st">"Bedroom"</span><span class="op">,</span> <span class="va">weapon</span> <span class="op">=</span> <span class="st">"Garrotte"</span>  <span class="op">}</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The user will move from room to room in a fashion that might be randomly generated or set by the game’s storyline. To keep it simple, we add <code>next</code> and <code>prev</code> fields to each room as follows:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="va">rooms</span><span class="op">[</span><span class="dv">1</span><span class="op">].</span><span class="va">next</span><span class="op">,</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">2</span><span class="op">].</span><span class="va">next</span><span class="op">,</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">3</span><span class="op">].</span><span class="va">next</span><span class="op">,</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">4</span><span class="op">].</span><span class="va">next</span> <span class="op">=</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">2</span><span class="op">],</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">3</span><span class="op">],</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">4</span><span class="op">],</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="va">rooms</span><span class="op">[</span><span class="dv">1</span><span class="op">].</span><span class="va">prev</span><span class="op">,</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">2</span><span class="op">].</span><span class="va">prev</span><span class="op">,</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">3</span><span class="op">].</span><span class="va">prev</span><span class="op">,</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">4</span><span class="op">].</span><span class="va">prev</span> <span class="op">=</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">4</span><span class="op">],</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">2</span><span class="op">],</span> <span class="va">rooms</span><span class="op">[</span><span class="dv">3</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now if we <code>print(pretty(rooms))</code> we get:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>        name = "Library",</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>        next = &lt;2&gt;,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>        prev = &lt;4&gt;,</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>        weapon = "Lead Pipe"</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>        name = "Kitchen",</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>        next = &lt;3&gt;,</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>        prev = &lt;1&gt;,</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>        weapon = "Knife"</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>        name = "Lounge",</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>        next = &lt;4&gt;,</span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>        prev = &lt;2&gt;,</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>        weapon = "Poison"</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>        name = "Bedroom",</span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>        next = &lt;1&gt;,</span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>        prev = &lt;3&gt;,</span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>        weapon = "Garrotte"</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>rooms</code> is an array printed without showing the indices. The problem is that path references like <code>next = &lt;1&gt;</code> don’t make much sense.</p>
<div class="border mb-3 pt-3 shadow border-2 border-primary rounded bg-light text-center fst-italic fs-4">
<p>If the value associated with an <em>index</em> is shared, we want to see that index explicitly.</p>
</div>
<p>The current implementation makes this difficult. The main loop in <code>table_string</code> looks like this:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> iter<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>            <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_keys</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We are creating the key string <code>k_string</code> before we know whether the associate value <code>v</code> is a table, let alone a <em>shared</em> table. We also put out the key-value pair at one depth, but any shared reference may be at a different depth.</p>
<p>The solution is two-fold. First, add a new metadata field, <code>refs</code>, for each table and sub-table. <code>md[t].refs</code> will be the number of references seen for the table <code>t</code>. If <code>md[t].refs</code> is greater than <code>1</code>, then <code>t</code> is a shared table.</p>
<p>We can compute the reference count field using the <code>metadata</code> method. We also switch the style of the function to having an inner hidden <code>process</code> closure that does all the work. Tables are still getting traversed depth-first.</p>
<div class="sourceCode" id="annotated-cell-168"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-168-1"><a href="#annotated-cell-168-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> metadata<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-168" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-168-2" class="code-annotation-target"><a href="#annotated-cell-168-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">md</span> <span class="op">=</span> <span class="op">{}</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-168" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-168-3" class="code-annotation-target"><a href="#annotated-cell-168-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">md</span><span class="op">[</span><span class="va">root_tbl</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span> <span class="va">refs</span> <span class="op">=</span> <span class="dv">1</span> <span class="op">}</span></span>
<span id="annotated-cell-168-4"><a href="#annotated-cell-168-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-168" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-168-5" class="code-annotation-target"><a href="#annotated-cell-168-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="kw">function</span> process<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-168-6"><a href="#annotated-cell-168-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span><span class="op">,</span> <span class="va">subs</span>  <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="dv">0</span></span>
<span id="annotated-cell-168-7"><a href="#annotated-cell-168-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">children</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-168-8"><a href="#annotated-cell-168-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-168-9"><a href="#annotated-cell-168-9" aria-hidden="true" tabindex="-1"></a>            <span class="va">size</span> <span class="op">=</span> <span class="va">size</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-168-10"><a href="#annotated-cell-168-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">array</span> <span class="kw">and</span> <span class="va">tbl</span><span class="op">[</span><span class="va">size</span><span class="op">]</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="va">array</span> <span class="op">=</span> <span class="kw">false</span> <span class="cf">end</span></span>
<span id="annotated-cell-168-11"><a href="#annotated-cell-168-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-168-12"><a href="#annotated-cell-168-12" aria-hidden="true" tabindex="-1"></a>                <span class="va">subs</span> <span class="op">=</span> <span class="va">subs</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-168-13"><a href="#annotated-cell-168-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">]</span> <span class="cf">then</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-168" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-168-14" class="code-annotation-target"><a href="#annotated-cell-168-14" aria-hidden="true" tabindex="-1"></a>                    <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">refs</span> <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">refs</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-168-15"><a href="#annotated-cell-168-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-168" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-168-16" class="code-annotation-target"><a href="#annotated-cell-168-16" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">table.insert</span><span class="op">(</span><span class="va">children</span><span class="op">,</span> <span class="va">v</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-168" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-168-17" class="code-annotation-target"><a href="#annotated-cell-168-17" aria-hidden="true" tabindex="-1"></a>                    <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span> <span class="va">refs</span> <span class="op">=</span> <span class="dv">1</span> <span class="op">}</span></span>
<span id="annotated-cell-168-18"><a href="#annotated-cell-168-18" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="annotated-cell-168-19"><a href="#annotated-cell-168-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="annotated-cell-168-20"><a href="#annotated-cell-168-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-168-21"><a href="#annotated-cell-168-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">size</span><span class="op">,</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">array</span><span class="op">,</span> <span class="va">md</span><span class="op">[</span><span class="va">tbl</span><span class="op">].</span><span class="va">subs</span> <span class="op">=</span> <span class="va">size</span><span class="op">,</span> <span class="va">array</span><span class="op">,</span> <span class="va">subs</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-168" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-168-22" class="code-annotation-target"><a href="#annotated-cell-168-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span> <span class="va">child</span> <span class="kw">in</span> <span class="fu">ipairs</span><span class="op">(</span><span class="va">children</span><span class="op">)</span> <span class="cf">do</span> process<span class="op">(</span><span class="va">child</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-168-23"><a href="#annotated-cell-168-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-168-24"><a href="#annotated-cell-168-24" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-168" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-168-25" class="code-annotation-target"><a href="#annotated-cell-168-25" aria-hidden="true" tabindex="-1"></a>    process<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span></span>
<span id="annotated-cell-168-26"><a href="#annotated-cell-168-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">md</span></span>
<span id="annotated-cell-168-27"><a href="#annotated-cell-168-27" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-168" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-168" data-code-lines="2" data-code-annotation="1">We set up the metadata table that will be accessible inside the <code>process</code> closure.</span>
</dd>
<dt data-target-cell="annotated-cell-168" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-168" data-code-lines="3" data-code-annotation="2">We immediately add an entry for the root table as it might be referenced by its immediate children</span>
</dd>
<dt data-target-cell="annotated-cell-168" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-168" data-code-lines="5" data-code-annotation="3"><code>process</code> is the recursive function that does all the heavy lifting.</span>
</dd>
<dt data-target-cell="annotated-cell-168" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-168" data-code-lines="14" data-code-annotation="4">If we’ve seen <code>v</code> before, we increment its reference count.</span>
</dd>
<dt data-target-cell="annotated-cell-168" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-168" data-code-lines="16" data-code-annotation="5">Otherwise we add <code>v</code> to the list of sub-tables to process later.</span>
</dd>
<dt data-target-cell="annotated-cell-168" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-168" data-code-lines="17" data-code-annotation="6">We add a metadata entry for <code>v</code> here in case it is referenced by an immediate sibling.</span>
</dd>
<dt data-target-cell="annotated-cell-168" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-168" data-code-lines="22" data-code-annotation="7">Go ahead and process the granchildren etc.</span>
</dd>
<dt data-target-cell="annotated-cell-168" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-168" data-code-lines="25" data-code-annotation="8">We kick things off by processing the root table.</span>
</dd>
</dl>
<p>Of course, we must tweak our <code>table_string</code> method:</p>
<div class="sourceCode" id="annotated-cell-169"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-169-1"><a href="#annotated-cell-169-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-169-2"><a href="#annotated-cell-169-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-169-3"><a href="#annotated-cell-169-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="kw">function</span> process<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">path</span><span class="op">)</span></span>
<span id="annotated-cell-169-4"><a href="#annotated-cell-169-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-169-5"><a href="#annotated-cell-169-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> iter<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-169-6"><a href="#annotated-cell-169-6" aria-hidden="true" tabindex="-1"></a>            <span class="va">i</span> <span class="op">=</span> <span class="va">i</span> <span class="op">+</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-169" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-169-7" class="code-annotation-target"><a href="#annotated-cell-169-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">show_key</span> <span class="op">=</span> <span class="va">show_keys</span></span>
<span id="annotated-cell-169-8"><a href="#annotated-cell-169-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">v_string</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="annotated-cell-169-9"><a href="#annotated-cell-169-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<span id="annotated-cell-169-10"><a href="#annotated-cell-169-10" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">path</span> <span class="cf">then</span></span>
<span id="annotated-cell-169-11"><a href="#annotated-cell-169-11" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> <span class="va">pb</span> <span class="op">..</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">path</span> <span class="op">..</span> <span class="va">pe</span></span>
<span id="annotated-cell-169-12"><a href="#annotated-cell-169-12" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">v</span> <span class="op">==</span> <span class="va">root</span> <span class="cf">then</span> <span class="va">root_ref</span> <span class="op">=</span> <span class="kw">true</span> <span class="cf">end</span></span>
<span id="annotated-cell-169-13"><a href="#annotated-cell-169-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-169" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-169-14" class="code-annotation-target"><a href="#annotated-cell-169-14" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">refs</span> <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">then</span> <span class="va">show_key</span> <span class="op">=</span> <span class="kw">true</span> <span class="cf">end</span></span>
<span id="annotated-cell-169-15"><a href="#annotated-cell-169-15" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">local</span> <span class="va">v_path</span> <span class="op">=</span> <span class="va">path_prefix</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span></span>
<span id="annotated-cell-169-16"><a href="#annotated-cell-169-16" aria-hidden="true" tabindex="-1"></a>                    <span class="va">v_string</span> <span class="op">=</span> simple_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-169-17"><a href="#annotated-cell-169-17" aria-hidden="true" tabindex="-1"></a>                    <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">path</span> <span class="op">=</span> <span class="va">v_path</span></span>
<span id="annotated-cell-169-18"><a href="#annotated-cell-169-18" aria-hidden="true" tabindex="-1"></a>                    <span class="va">children</span><span class="op">[</span><span class="va">v</span><span class="op">]</span> <span class="op">=</span> <span class="va">v_path</span></span>
<span id="annotated-cell-169-19"><a href="#annotated-cell-169-19" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">delims</span> <span class="op">==</span> <span class="kw">false</span> <span class="kw">and</span> <span class="va">show_key</span> <span class="cf">then</span> <span class="va">v_string</span> <span class="op">=</span> <span class="va">nl</span> <span class="op">..</span> <span class="va">v_string</span> <span class="cf">end</span></span>
<span id="annotated-cell-169-20"><a href="#annotated-cell-169-20" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="annotated-cell-169-21"><a href="#annotated-cell-169-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="annotated-cell-169-22"><a href="#annotated-cell-169-22" aria-hidden="true" tabindex="-1"></a>                <span class="va">v_string</span> <span class="op">=</span> <span class="va">v_string</span> <span class="op">..</span> simple_string<span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-169-23"><a href="#annotated-cell-169-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-169" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-169-24" class="code-annotation-target"><a href="#annotated-cell-169-24" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">k_string</span> <span class="op">=</span> <span class="va">show_key</span> <span class="kw">and</span> <span class="va">kb</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">..</span> <span class="va">ke</span> <span class="kw">or</span> <span class="st">''</span></span>
<span id="annotated-cell-169-25"><a href="#annotated-cell-169-25" aria-hidden="true" tabindex="-1"></a>            <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">indent</span> <span class="op">..</span> <span class="va">k_string</span> <span class="op">..</span> <span class="va">v_string</span></span>
<span id="annotated-cell-169-26"><a href="#annotated-cell-169-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">i</span> <span class="op">&lt;</span> <span class="va">size</span> <span class="cf">then</span> <span class="va">content</span> <span class="op">=</span> <span class="va">content</span> <span class="op">..</span> <span class="va">sep</span> <span class="cf">end</span></span>
<span id="annotated-cell-169-27"><a href="#annotated-cell-169-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-169-28"><a href="#annotated-cell-169-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-169-29"><a href="#annotated-cell-169-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-169-30"><a href="#annotated-cell-169-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-169-31"><a href="#annotated-cell-169-31" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-169" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-169" data-code-lines="7" data-code-annotation="1">By default we show <em>this</em> key based on the value of <code>show_keys</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-169" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-169" data-code-lines="14" data-code-annotation="2">If <code>v</code> is new and has a reference count greater than <code>1</code>, we will show the corresponding key whether or not <code>show_keys</code> is <code>false</code>. We must do that so that any path references to <code>v</code> make sense.</span>
</dd>
<dt data-target-cell="annotated-cell-169" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-169" data-code-lines="24" data-code-annotation="3">Now that we know the state of play, we can finally set the string for this key.</span>
</dd>
</dl>
<p>With this change, <code>print(pretty(rooms))</code> gives:</p>
<div class="sourceCode" id="annotated-cell-170"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-170-1"><a href="#annotated-cell-170-1" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="annotated-cell-170-2"><a href="#annotated-cell-170-2" aria-hidden="true" tabindex="-1"></a>    1 = {</span>
<span id="annotated-cell-170-3"><a href="#annotated-cell-170-3" aria-hidden="true" tabindex="-1"></a>        name = "Library",</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-170" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-170-4" class="code-annotation-target"><a href="#annotated-cell-170-4" aria-hidden="true" tabindex="-1"></a>        next = &lt;2&gt;,</span>
<span id="annotated-cell-170-5"><a href="#annotated-cell-170-5" aria-hidden="true" tabindex="-1"></a>        prev = &lt;4&gt;,</span>
<span id="annotated-cell-170-6"><a href="#annotated-cell-170-6" aria-hidden="true" tabindex="-1"></a>        weapon = "Lead Pipe"</span>
<span id="annotated-cell-170-7"><a href="#annotated-cell-170-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="annotated-cell-170-8"><a href="#annotated-cell-170-8" aria-hidden="true" tabindex="-1"></a>    2 = {</span>
<span id="annotated-cell-170-9"><a href="#annotated-cell-170-9" aria-hidden="true" tabindex="-1"></a>        name = "Kitchen",</span>
<span id="annotated-cell-170-10"><a href="#annotated-cell-170-10" aria-hidden="true" tabindex="-1"></a>        next = &lt;3&gt;,</span>
<span id="annotated-cell-170-11"><a href="#annotated-cell-170-11" aria-hidden="true" tabindex="-1"></a>        prev = &lt;1&gt;,</span>
<span id="annotated-cell-170-12"><a href="#annotated-cell-170-12" aria-hidden="true" tabindex="-1"></a>        weapon = "Knife"</span>
<span id="annotated-cell-170-13"><a href="#annotated-cell-170-13" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="annotated-cell-170-14"><a href="#annotated-cell-170-14" aria-hidden="true" tabindex="-1"></a>    3 = {</span>
<span id="annotated-cell-170-15"><a href="#annotated-cell-170-15" aria-hidden="true" tabindex="-1"></a>        name = "Lounge",</span>
<span id="annotated-cell-170-16"><a href="#annotated-cell-170-16" aria-hidden="true" tabindex="-1"></a>        next = &lt;4&gt;,</span>
<span id="annotated-cell-170-17"><a href="#annotated-cell-170-17" aria-hidden="true" tabindex="-1"></a>        prev = &lt;2&gt;,</span>
<span id="annotated-cell-170-18"><a href="#annotated-cell-170-18" aria-hidden="true" tabindex="-1"></a>        weapon = "Poison"</span>
<span id="annotated-cell-170-19"><a href="#annotated-cell-170-19" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="annotated-cell-170-20"><a href="#annotated-cell-170-20" aria-hidden="true" tabindex="-1"></a>    4 = {</span>
<span id="annotated-cell-170-21"><a href="#annotated-cell-170-21" aria-hidden="true" tabindex="-1"></a>        name = "Bedroom",</span>
<span id="annotated-cell-170-22"><a href="#annotated-cell-170-22" aria-hidden="true" tabindex="-1"></a>        next = &lt;1&gt;,</span>
<span id="annotated-cell-170-23"><a href="#annotated-cell-170-23" aria-hidden="true" tabindex="-1"></a>        prev = &lt;3&gt;,</span>
<span id="annotated-cell-170-24"><a href="#annotated-cell-170-24" aria-hidden="true" tabindex="-1"></a>        weapon = "Garrotte"</span>
<span id="annotated-cell-170-25"><a href="#annotated-cell-170-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="annotated-cell-170-26"><a href="#annotated-cell-170-26" aria-hidden="true" tabindex="-1"></a>]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-170" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-170" data-code-lines="4" data-code-annotation="1">The path reference <code>&lt;2&gt;</code> now makes perfect sense.</span>
</dd>
</dl>
<p>Here’s what we get for <code>print(alt(rooms))</code>:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>1:</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    name: "Library",</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    next: &lt;2&gt;,</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    prev: &lt;4&gt;,</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    weapon: "Lead Pipe",</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>2:</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    name: "Kitchen",</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    next: &lt;3&gt;,</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    prev: &lt;1&gt;,</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    weapon: "Knife",</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>3:</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    name: "Lounge",</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    next: &lt;4&gt;,</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    prev: &lt;2&gt;,</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    weapon: "Poison",</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>4:</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>    name: "Bedroom",</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>    next: &lt;1&gt;,</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    prev: &lt;3&gt;,</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>    weapon: "Garrotte"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This output is also very readable.</p>
</section>
<section id="one-small-tweak" class="level3">
<h3 class="anchored" data-anchor-id="one-small-tweak">One Small Tweak</h3>
<p>Our current definition of a “simple” table is one that has no sub-tables. But what is a sub-table?</p>
<p>We can very slightly alter our metadata function to not count path references as distinct sub-tables.</p>
<div class="sourceCode" id="annotated-cell-172"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-172-1"><a href="#annotated-cell-172-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> metadata<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span></span>
<span id="annotated-cell-172-2"><a href="#annotated-cell-172-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-172-3"><a href="#annotated-cell-172-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="kw">function</span> process<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-172-4"><a href="#annotated-cell-172-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-172-5"><a href="#annotated-cell-172-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="cn">_</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-172-6"><a href="#annotated-cell-172-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">...</span></span>
<span id="annotated-cell-172-7"><a href="#annotated-cell-172-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">==</span> <span class="st">'table'</span> <span class="cf">then</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-172" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-172-8" class="code-annotation-target"><a href="#annotated-cell-172-8" aria-hidden="true" tabindex="-1"></a>                <span class="co">-- subs = subs + 1</span></span>
<span id="annotated-cell-172-9"><a href="#annotated-cell-172-9" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">]</span> <span class="cf">then</span></span>
<span id="annotated-cell-172-10"><a href="#annotated-cell-172-10" aria-hidden="true" tabindex="-1"></a>                    <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">refs</span> <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">].</span><span class="va">refs</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-172-11"><a href="#annotated-cell-172-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-172" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-172-12" class="code-annotation-target"><a href="#annotated-cell-172-12" aria-hidden="true" tabindex="-1"></a>                    <span class="va">subs</span> <span class="op">=</span> <span class="va">subs</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-172-13"><a href="#annotated-cell-172-13" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">table.insert</span><span class="op">(</span><span class="va">children</span><span class="op">,</span> <span class="va">v</span><span class="op">)</span></span>
<span id="annotated-cell-172-14"><a href="#annotated-cell-172-14" aria-hidden="true" tabindex="-1"></a>                    <span class="va">md</span><span class="op">[</span><span class="va">v</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span> <span class="va">refs</span> <span class="op">=</span> <span class="dv">1</span> <span class="op">}</span></span>
<span id="annotated-cell-172-15"><a href="#annotated-cell-172-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">end</span></span>
<span id="annotated-cell-172-16"><a href="#annotated-cell-172-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="annotated-cell-172-17"><a href="#annotated-cell-172-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-172-18"><a href="#annotated-cell-172-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span>
<span id="annotated-cell-172-19"><a href="#annotated-cell-172-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span></span>
<span id="annotated-cell-172-20"><a href="#annotated-cell-172-20" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-172" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-172" data-code-lines="8" data-code-annotation="1">We move this line</span>
</dd>
<dt data-target-cell="annotated-cell-172" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-172" data-code-lines="12" data-code-annotation="2">to here.</span>
</dd>
</dl>
<p>With that change only “real” sub-tables count towards the <code>sub</code> total.</p>
<p><code>print(pretty(rooms))</code> now gives the more compact but still readable:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    1 = { name = "Library", next = &lt;2&gt;, prev = &lt;4&gt;, weapon = "Lead Pipe" },</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    2 = { name = "Kitchen", next = &lt;3&gt;, prev = &lt;1&gt;, weapon = "Knife" },</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    3 = { name = "Lounge", next = &lt;4&gt;, prev = &lt;2&gt;, weapon = "Poison" },</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    4 = { name = "Bedroom", next = &lt;1&gt;, prev = &lt;3&gt;, weapon = "Garrotte" }</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="scribe-facade" class="level2">
<h2 class="anchored" data-anchor-id="scribe-facade">Scribe Facade</h2>
<section id="introduction-1" class="level3">
<h3 class="anchored" data-anchor-id="introduction-1">Introduction</h3>
<p>After the first attempt at <code>table_string(tbl)</code>, we commented that, while the method name was descriptive, we needed to check that the <code>tbl</code> argument is an actual table.</p>
<p>Instead of doing that, we will create another “facade” function <code>scribe</code> that will return a string for <em>any</em> Lua object. The user will call this function, and we will make <code>table_string</code> a private function only called by <code>scribe</code> when the object is a table. Currently, our <code>table_string</code> function starts as follows:</p>
<div class="sourceCode" id="annotated-cell-174"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-174" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-174-1" class="code-annotation-target"><a href="#annotated-cell-174-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> table_string<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-174" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-174-2" class="code-annotation-target"><a href="#annotated-cell-174-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-174-3"><a href="#annotated-cell-174-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">md</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span></span>
<span id="annotated-cell-174-4"><a href="#annotated-cell-174-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-174-5"><a href="#annotated-cell-174-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-174" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-174" data-code-lines="1" data-code-annotation="1"><code>table_string</code> is a <em>global</em> function that is available to the user.</span>
</dd>
<dt data-target-cell="annotated-cell-174" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-174" data-code-lines="2" data-code-annotation="2">It has to check if <code>opts</code> is provided; if not, set it to the default <code>options.pretty</code>.</span>
</dd>
</dl>
<p>We will change this to:</p>
<div class="sourceCode" id="annotated-cell-175"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-175" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-175-1" class="code-annotation-target"><a href="#annotated-cell-175-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> table_string<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-175" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-175-2" class="code-annotation-target"><a href="#annotated-cell-175-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">md</span> <span class="op">=</span> metadata<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span></span>
<span id="annotated-cell-175-3"><a href="#annotated-cell-175-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-175-4"><a href="#annotated-cell-175-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-175" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-175" data-code-lines="1" data-code-annotation="1">We make <code>table_string</code> a <em>local</em> function.</span>
</dd>
<dt data-target-cell="annotated-cell-175" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-175" data-code-lines="2" data-code-annotation="2">We remove the <code>opts</code> check as we know that <code>scribe</code> will always provide it.</span>
</dd>
</dl>
<div class="admonition note">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-note" title="Note"></i></td>
    <td class="content">
    
In a later chapter, we will discuss the difference between <em>global</em> and <em>local</em> functions.
</td></tr></tbody></table></div>
<p>In the meantime, we introduce <code>scribe</code> as follows:</p>
<div class="sourceCode" id="annotated-cell-176"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-176" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-176-1" class="code-annotation-target"><a href="#annotated-cell-176-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> scribe<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-176" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-176-2" class="code-annotation-target"><a href="#annotated-cell-176-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="cf">then</span> <span class="cf">return</span> simple_string<span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-176" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-176-3" class="code-annotation-target"><a href="#annotated-cell-176-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-176" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-176-4" class="code-annotation-target"><a href="#annotated-cell-176-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_string<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-176-5"><a href="#annotated-cell-176-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-176" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-176" data-code-lines="1" data-code-annotation="1"><code>obj</code> can be <em>any</em> Lua object and <code>opts</code> is an <em>optional</em> table of opts.</span>
</dd>
<dt data-target-cell="annotated-cell-176" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-176" data-code-lines="2" data-code-annotation="2">We handle non-table objects up-front by calling <code>simple_string</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-176" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-176" data-code-lines="3" data-code-annotation="3">We set the <code>opts</code> to the default <code>options.pretty</code> if it is not provided.</span>
</dd>
<dt data-target-cell="annotated-cell-176" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-176" data-code-lines="4" data-code-annotation="4">If we get here, we know that <code>obj</code> is a table, so we call the private <code>table_string</code> method to convert it to a string.</span>
</dd>
</dl>
<p>Of course, our other public facade functions will also call <code>scribe</code> instead of <code>table_string</code> directly. For example, <code>pretty_string</code> will now look like this:</p>
<div class="sourceCode" id="annotated-cell-177"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-177-1"><a href="#annotated-cell-177-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> pretty_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-177" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-177-2" class="code-annotation-target"><a href="#annotated-cell-177-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> scribe<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="annotated-cell-177-3"><a href="#annotated-cell-177-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-177" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-177" data-code-lines="2" data-code-annotation="1">We call <code>scribe</code> with the <code>options.pretty</code> table.</span>
</dd>
</dl>
</section>
<section id="health-and-safety" class="level3">
<h3 class="anchored" data-anchor-id="health-and-safety">Health and Safety</h3>
<p>We have now added a layer of protection to our <code>table_string</code> function by ensuring that it is only called by <code>scribe</code> when the object is a table.</p>
<p>However, we still need to check that the <code>opts</code> table is <em>complete</em>. Each of those many fields in the options table must be present, or <code>table_string</code> will fail.</p>
<p>Of course, we are sure that the standard options tables we provide are complete, but what if the user provides their own options table?</p>
<p>We start by adding a “marker” to our own options tables to indicate that they are complete:</p>
<div class="sourceCode" id="annotated-cell-178"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-178-1"><a href="#annotated-cell-178-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">options</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-178-2"><a href="#annotated-cell-178-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">pretty</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="annotated-cell-178-3"><a href="#annotated-cell-178-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>        <span class="op">=</span> <span class="st">'    '</span><span class="op">,</span></span>
<span id="annotated-cell-178-4"><a href="#annotated-cell-178-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_begin</span>   <span class="op">=</span> <span class="st">'{'</span><span class="op">,</span></span>
<span id="annotated-cell-178-5"><a href="#annotated-cell-178-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_end</span>     <span class="op">=</span> <span class="st">'}'</span><span class="op">,</span></span>
<span id="annotated-cell-178-6"><a href="#annotated-cell-178-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_begin</span>   <span class="op">=</span> <span class="st">'['</span><span class="op">,</span></span>
<span id="annotated-cell-178-7"><a href="#annotated-cell-178-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_end</span>     <span class="op">=</span> <span class="st">']'</span><span class="op">,</span></span>
<span id="annotated-cell-178-8"><a href="#annotated-cell-178-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_begin</span>     <span class="op">=</span> <span class="st">''</span><span class="op">,</span></span>
<span id="annotated-cell-178-9"><a href="#annotated-cell-178-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_end</span>       <span class="op">=</span> <span class="st">' = '</span><span class="op">,</span></span>
<span id="annotated-cell-178-10"><a href="#annotated-cell-178-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span>           <span class="op">=</span> <span class="st">','</span><span class="op">,</span></span>
<span id="annotated-cell-178-11"><a href="#annotated-cell-178-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_spacer</span> <span class="op">=</span> <span class="st">' '</span><span class="op">,</span></span>
<span id="annotated-cell-178-12"><a href="#annotated-cell-178-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">show_indices</span>  <span class="op">=</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="annotated-cell-178-13"><a href="#annotated-cell-178-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">comparator</span>    <span class="op">=</span> <span class="va">compare</span><span class="op">,</span></span>
<span id="annotated-cell-178-14"><a href="#annotated-cell-178-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_size</span>   <span class="op">=</span> <span class="fu">math.huge</span><span class="op">,</span></span>
<span id="annotated-cell-178-15"><a href="#annotated-cell-178-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_root</span>     <span class="op">=</span> <span class="st">'table'</span><span class="op">,</span></span>
<span id="annotated-cell-178-16"><a href="#annotated-cell-178-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_sep</span>      <span class="op">=</span> <span class="st">'.'</span><span class="op">,</span></span>
<span id="annotated-cell-178-17"><a href="#annotated-cell-178-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_begin</span>    <span class="op">=</span> <span class="st">'&lt;'</span><span class="op">,</span></span>
<span id="annotated-cell-178-18"><a href="#annotated-cell-178-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_end</span>      <span class="op">=</span> <span class="st">'&gt;'</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-178" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-178-19" class="code-annotation-target"><a href="#annotated-cell-178-19" aria-hidden="true" tabindex="-1"></a>    <span class="cn">COMPLETE</span>      <span class="op">=</span> <span class="kw">true</span></span>
<span id="annotated-cell-178-20"><a href="#annotated-cell-178-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-178" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-178" data-code-lines="19" data-code-annotation="1">If the user provides their own options table, we will check for the presence of this field to determine if it is complete.</span>
</dd>
</dl>
<p>We also add a function that adds missing fields to an options table:</p>
<div class="sourceCode" id="annotated-cell-179"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-179" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-179-1" class="code-annotation-target"><a href="#annotated-cell-179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> complete_options_table<span class="op">(</span><span class="va">options</span><span class="op">,</span> <span class="va">from</span><span class="op">)</span></span>
<span id="annotated-cell-179-2"><a href="#annotated-cell-179-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">pairs</span><span class="op">(</span><span class="va">from</span><span class="op">)</span> <span class="cf">do</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-179" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-179-3" class="code-annotation-target"><a href="#annotated-cell-179-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">options</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="va">options</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span> <span class="va">v</span> <span class="cf">end</span></span>
<span id="annotated-cell-179-4"><a href="#annotated-cell-179-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-179-5"><a href="#annotated-cell-179-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-179" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-179" data-code-lines="1" data-code-annotation="1">This function takes two arguments: the <code>opts</code> table to complete and the <code>from</code> table to use as a template.</span>
</dd>
<dt data-target-cell="annotated-cell-179" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-179" data-code-lines="3" data-code-annotation="2">We add missing fields from the <code>from</code> table to the <code>opts</code> table.</span>
</dd>
</dl>
<p><code>complete_options_table</code> is a private function that is only called by <code>scribe</code>, so we are sure that edge cases are handled correctly. For example, we can be confident that there will be two arguments and that the second argument will be a complete options table.</p>
<p>We call this function <code>scribe</code>:</p>
<div class="sourceCode" id="annotated-cell-180"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-180-1"><a href="#annotated-cell-180-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> scribe<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-180-2"><a href="#annotated-cell-180-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="cf">then</span> <span class="cf">return</span> simple_string<span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-180" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-180-3" class="code-annotation-target"><a href="#annotated-cell-180-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">opts</span> <span class="op">=</span> <span class="va">opts</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-180" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-180-4" class="code-annotation-target"><a href="#annotated-cell-180-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">opts</span><span class="op">.</span><span class="cn">COMPLETE</span> <span class="cf">then</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-180" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-180-5" class="code-annotation-target"><a href="#annotated-cell-180-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">from</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">options</span><span class="op">.</span><span class="va">inline</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-180" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-180-6" class="code-annotation-target"><a href="#annotated-cell-180-6" aria-hidden="true" tabindex="-1"></a>        complete_options_table<span class="op">(</span><span class="va">options</span><span class="op">,</span> <span class="va">from</span><span class="op">)</span></span>
<span id="annotated-cell-180-7"><a href="#annotated-cell-180-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-180" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-180-8" class="code-annotation-target"><a href="#annotated-cell-180-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_string<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-180-9"><a href="#annotated-cell-180-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-180" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-180" data-code-lines="3" data-code-annotation="1">If the user does not provide any options table, we use the <code>options.pretty</code> table.</span>
</dd>
<dt data-target-cell="annotated-cell-180" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-180" data-code-lines="4" data-code-annotation="2">If the user provides a custom options table, we ensure it’s complete before calling <code>table_string</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-180" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-180" data-code-lines="5" data-code-annotation="3">We use the <code>options.inline</code> table if the <code>indent</code> field is empty. Otherwise, we use the <code>options.pretty</code> table.</span>
</dd>
<dt data-target-cell="annotated-cell-180" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-180" data-code-lines="6" data-code-annotation="4">We call the <code>complete_options_table</code> function to add any missing fields to the <code>opts</code> table.</span>
</dd>
<dt data-target-cell="annotated-cell-180" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-180" data-code-lines="8" data-code-annotation="5">We can safely call <code>table_string</code> with the complete <code>opts</code> table.</span>
</dd>
</dl>
<p>Adding that <code>COMPLETE</code> field to our options tables can avoid most performance issues and ensure that our code is robust.</p>
<div class="admonition warning">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-warning" title="Warning"></i></td>
    <td class="content">
    
There is a caveat to this approach. If the user provides their own incomplete options table, then the first time we see it, we <em>alter</em> it. Generally, changing things under-the-covers is a bad idea, but in this case, the user will only see the performance hit once. All in all, it is a reasonable trade-off.
</td></tr></tbody></table></div>
<p>Here is an example of how the user can provide their own minimal options table that sets the indent to two spaces:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">my_options</span> <span class="op">=</span> <span class="op">{</span> <span class="va">indent</span> <span class="op">=</span> <span class="st">'  '</span> <span class="op">}</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">user</span> <span class="op">=</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">first</span> <span class="op">=</span> <span class="st">"Minnie"</span><span class="op">,</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">last</span> <span class="op">=</span> <span class="st">"Mouse"</span><span class="op">,</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">friends</span> <span class="op">=</span> <span class="op">{</span> <span class="st">"Mickey"</span><span class="op">,</span> <span class="st">"Goofy"</span> <span class="op">}</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span>scribe<span class="op">(</span><span class="va">user</span><span class="op">,</span> <span class="va">my_options</span><span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will output:</p>
<pre><code>{
 first = "Minnie",
 last = "Mouse",
 friends = { "Mickey", "Goofy" }
}</code></pre>
<p>The <code>my_options</code> table is complete as far as <code>table_string</code> is concerned. We can inspect it by a call to <code>print(classic(my_options))</code> which will output:</p>
<div class="sourceCode" id="annotated-cell-183"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-183-1"><a href="#annotated-cell-183-1" aria-hidden="true" tabindex="-1"></a>{</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-183" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-183-2" class="code-annotation-target"><a href="#annotated-cell-183-2" aria-hidden="true" tabindex="-1"></a>    COMPLETE = true,</span>
<span id="annotated-cell-183-3"><a href="#annotated-cell-183-3" aria-hidden="true" tabindex="-1"></a>    array_begin = "[",</span>
<span id="annotated-cell-183-4"><a href="#annotated-cell-183-4" aria-hidden="true" tabindex="-1"></a>    array_end = "]",</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-183" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-183-5" class="code-annotation-target"><a href="#annotated-cell-183-5" aria-hidden="true" tabindex="-1"></a>    comparator = &lt;function&gt;,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-183" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-183-6" class="code-annotation-target"><a href="#annotated-cell-183-6" aria-hidden="true" tabindex="-1"></a>    indent = "  ",</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-183" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-183-7" class="code-annotation-target"><a href="#annotated-cell-183-7" aria-hidden="true" tabindex="-1"></a>    inline_size = inf,</span>
<span id="annotated-cell-183-8"><a href="#annotated-cell-183-8" aria-hidden="true" tabindex="-1"></a>    inline_spacer = " ",</span>
<span id="annotated-cell-183-9"><a href="#annotated-cell-183-9" aria-hidden="true" tabindex="-1"></a>    key_begin = "",</span>
<span id="annotated-cell-183-10"><a href="#annotated-cell-183-10" aria-hidden="true" tabindex="-1"></a>    key_end = " = ",</span>
<span id="annotated-cell-183-11"><a href="#annotated-cell-183-11" aria-hidden="true" tabindex="-1"></a>    path_begin = "&lt;",</span>
<span id="annotated-cell-183-12"><a href="#annotated-cell-183-12" aria-hidden="true" tabindex="-1"></a>    path_end = "&gt;",</span>
<span id="annotated-cell-183-13"><a href="#annotated-cell-183-13" aria-hidden="true" tabindex="-1"></a>    path_root = "table",</span>
<span id="annotated-cell-183-14"><a href="#annotated-cell-183-14" aria-hidden="true" tabindex="-1"></a>    path_sep = ".",</span>
<span id="annotated-cell-183-15"><a href="#annotated-cell-183-15" aria-hidden="true" tabindex="-1"></a>    sep = ",",</span>
<span id="annotated-cell-183-16"><a href="#annotated-cell-183-16" aria-hidden="true" tabindex="-1"></a>    show_indices = false,</span>
<span id="annotated-cell-183-17"><a href="#annotated-cell-183-17" aria-hidden="true" tabindex="-1"></a>    table_begin = "{",</span>
<span id="annotated-cell-183-18"><a href="#annotated-cell-183-18" aria-hidden="true" tabindex="-1"></a>    table_end = "}"</span>
<span id="annotated-cell-183-19"><a href="#annotated-cell-183-19" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-183" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-183" data-code-lines="2" data-code-annotation="1">The <code>COMPLETE</code> field is present and set to <code>true</code>,; all the other fields are present and mostly set to the default values from the <code>options.pretty</code> table.</span>
</dd>
<dt data-target-cell="annotated-cell-183" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-183" data-code-lines="5" data-code-annotation="2">The <code>comparator</code> field is shown as <code>&lt;function&gt;</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-183" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-183" data-code-lines="6" data-code-annotation="3">The <code>indent</code> field is set to two spaces as provided by the user.</span>
</dd>
<dt data-target-cell="annotated-cell-183" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-183" data-code-lines="7" data-code-annotation="4"><code>inf</code> means infinity, accessible in Lua as <code>math.huge</code>.</span>
</dd>
</dl>
<p>The next time we call <code>scribe</code> with the <code>my_options</code> table, it will be complete and we will not have to call <code>complete_options_table</code> again.</p>
</section>
<section id="overrides" class="level3">
<h3 class="anchored" data-anchor-id="overrides">Overrides</h3>
<p>We also want to allow the user to override one or more options in <em>any</em> of the pre-canned options tables.</p>
<p>The signature of your main <code>scribe</code> function will now look like this:</p>
<div class="sourceCode" id="annotated-cell-184"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-184" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-184-1" class="code-annotation-target"><a href="#annotated-cell-184-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> scribe<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">options</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span></span>
<span id="annotated-cell-184-2"><a href="#annotated-cell-184-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-184-3"><a href="#annotated-cell-184-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-184" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-184" data-code-lines="1" data-code-annotation="1">We add a third argument, <code>overrides</code>, which is an <em>optional</em> table of options to override.</span>
</dd>
</dl>
<p>Now, <em>both</em> the second <code>opts</code> argument <em>and</em> the third <code>overrides</code> argument are optional. A moment’s thought will convince you that if the <code>opts</code> argument is missing, the <code>overrides</code> argument is also.</p>
<p>Here is the full <code>scribe</code> function:</p>
<div class="sourceCode" id="annotated-cell-185"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-185-1"><a href="#annotated-cell-185-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> scribe<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">options</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-185" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-185-2" class="code-annotation-target"><a href="#annotated-cell-185-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="cf">then</span> <span class="cf">return</span> simple_string<span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-185-3"><a href="#annotated-cell-185-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-185" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-185-4" class="code-annotation-target"><a href="#annotated-cell-185-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">options</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="cf">return</span> table_string<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-185-5"><a href="#annotated-cell-185-5" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-185" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-185-6" class="code-annotation-target"><a href="#annotated-cell-185-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">opts</span><span class="op">.</span><span class="cn">COMPLETE</span> <span class="cf">then</span></span>
<span id="annotated-cell-185-7"><a href="#annotated-cell-185-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">from</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="va">options</span><span class="op">.</span><span class="va">inline</span> <span class="kw">or</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-185-8"><a href="#annotated-cell-185-8" aria-hidden="true" tabindex="-1"></a>        complete_options_table<span class="op">(</span><span class="va">options</span><span class="op">,</span> <span class="va">from</span><span class="op">)</span></span>
<span id="annotated-cell-185-9"><a href="#annotated-cell-185-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-185" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-185-10" class="code-annotation-target"><a href="#annotated-cell-185-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">overrides</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="cf">return</span> table_string<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-185-11"><a href="#annotated-cell-185-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-185-12"><a href="#annotated-cell-185-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">overrides</span><span class="op">.</span><span class="cn">COMPLETE</span> <span class="cf">then</span> complete_options_table<span class="op">(</span><span class="va">overrides</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-185" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-185-13" class="code-annotation-target"><a href="#annotated-cell-185-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_string<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span></span>
<span id="annotated-cell-185-14"><a href="#annotated-cell-185-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-185" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-185" data-code-lines="2" data-code-annotation="1">As usual, we handle non-table objects up-front.</span>
</dd>
<dt data-target-cell="annotated-cell-185" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-185" data-code-lines="4" data-code-annotation="2">If the user does not provide an <code>opts</code> table, we use the <code>options.pretty</code> table and are done.</span>
</dd>
<dt data-target-cell="annotated-cell-185" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-185" data-code-lines="6" data-code-annotation="3">We complete an incomplete <code>opts</code> table if the user provides it.</span>
</dd>
<dt data-target-cell="annotated-cell-185" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-185" data-code-lines="10" data-code-annotation="4">If the user does not provide an <code>overrides</code> table, we use the <code>opts</code> table and are done.</span>
</dd>
<dt data-target-cell="annotated-cell-185" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-185" data-code-lines="13" data-code-annotation="5">If the user provides an <code>overrides</code> table, we complete it from the <code>opts</code> table and use it. <br> By the time we get here, we can be sure that the <code>opts</code> table is complete.</span>
</dd>
</dl>
<p>We also alter the facade functions to permit an <code>overrides</code> table. For example:</p>
<div class="sourceCode" id="annotated-cell-186"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-186-1"><a href="#annotated-cell-186-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> pretty_string<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-186" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-186-2" class="code-annotation-target"><a href="#annotated-cell-186-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> scribe<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span></span>
<span id="annotated-cell-186-3"><a href="#annotated-cell-186-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-186" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-186" data-code-lines="2" data-code-annotation="1">The main options table is <code>options.pretty</code>, and we also pass along any user-provided <code>overrides</code> table.</span>
</dd>
</dl>
<p>Here is an example of how the user can provide their own options table and override the <code>indent</code> field:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">user</span> <span class="op">=</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">first</span> <span class="op">=</span> <span class="st">"Minnie"</span><span class="op">,</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">last</span> <span class="op">=</span> <span class="st">"Mouse"</span><span class="op">,</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">friends</span> <span class="op">=</span> <span class="op">{</span> <span class="st">"Mickey"</span><span class="op">,</span> <span class="st">"Goofy"</span> <span class="op">}</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span>classic<span class="op">(</span><span class="va">user</span><span class="op">,</span> <span class="op">{</span> <span class="va">indent</span> <span class="op">=</span> <span class="st">'        '</span> <span class="op">}))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Output:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    first = "Minnie",</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    last = "Mouse",</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    friends = { "Mickey", "Goofy" }</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="metamethods" class="level2">
<h2 class="anchored" data-anchor-id="metamethods">Metamethods</h2>
<p>We mentioned that any Lua table can have an associated <em>metatable</em></p>
<p>The metatable is a regular table with arbitrary data and methods like any other table. However, if a table <code>tbl</code> has a metatable <code>mt</code>, Lua will check for specially named methods, <em>metamethods</em>, in <code>mt</code> and use those in place of its built-in default operations.</p>
<p>Metamethods, particularly the <code>__index</code> metamethod, are the keys to understanding how to use prototype and object-oriented methodologies in Lua. However, that isn’t the topic for today.</p>
<p>The one metamethod that interests us here is the <code>__tostring</code> function. (All Lua’s metamethods start with double underscores).</p>
<p>Here’s an example where we create a metatable with a <code>__tostring</code> method inside it:</p>
<div class="sourceCode" id="annotated-cell-189"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-189" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-189-1" class="code-annotation-target"><a href="#annotated-cell-189-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">count</span> <span class="op">=</span> <span class="dv">0</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-189" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-189-2" class="code-annotation-target"><a href="#annotated-cell-189-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">mt</span> <span class="op">=</span> <span class="op">{}</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-189" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-189-3" class="code-annotation-target"><a href="#annotated-cell-189-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">mt</span><span class="op">.</span>__tostring<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-189-4"><a href="#annotated-cell-189-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">count</span> <span class="op">=</span> <span class="va">count</span> <span class="op">+</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-189" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-189-5" class="code-annotation-target"><a href="#annotated-cell-189-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'This is print number: '</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">count</span><span class="op">)</span> <span class="op">..</span> <span class="st">' for an array of size: '</span> <span class="op">..</span> <span class="op">#</span><span class="va">tbl</span></span>
<span id="annotated-cell-189-6"><a href="#annotated-cell-189-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-189" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-189" data-code-lines="1" data-code-annotation="1"><code>count</code> will get incremented every time the <code>__tostring</code> metamethod is called.</span>
</dd>
<dt data-target-cell="annotated-cell-189" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-189" data-code-lines="2" data-code-annotation="2"><code>mt</code> is just a regular empty Lua table.</span>
</dd>
<dt data-target-cell="annotated-cell-189" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-189" data-code-lines="3" data-code-annotation="3">We add a function <code>__tostring</code> to <code>mt</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-189" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-189" data-code-lines="5" data-code-annotation="4">Every time <code>mt.__tostring</code> is called, we increment <code>count</code> and return a string with the latest count.</span>
</dd>
</dl>
<p>You will frequently see the equivalent definition:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="va">mt</span><span class="op">.</span><span class="va">__tostring</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">count</span> <span class="op">=</span> <span class="va">count</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'This is print number: '</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">count</span><span class="op">)</span> <span class="op">..</span> <span class="st">' for an array of size: '</span> <span class="op">..</span> <span class="op">#</span><span class="va">tbl</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The former style is more in keeping with most other programming languages. If you plan on expanding your horizons beyond Lua, stick with that look. However, both styles are perfectly acceptable and produce identical byte code.</p>
<p>For this metamethod to have any effect, we must attach its containing <em>metatable</em> to a Lua table using the <code>setmetatable</code> method:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">arr</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span> <span class="op">}</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setmetatable</span><span class="op">(</span><span class="va">arr</span><span class="op">,</span> <span class="va">mt</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="admonition tip">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-tip" title="Tip"></i></td>
    <td class="content">
    
If you just give <code>arr</code> a <code>__tostring</code> method directly, Lua will not make any redirection calls to it. For Lua to see a metamethod, you <strong>must</strong> put it in a metatable and attach the <em>metatable</em> to the parent object. The <code>setmetatable</code> call endows <code>tbl</code> with a hidden metatable. The existence of that metatable is what triggers Lua to redirect some of its operations to your custom definitions. Just adding metamethods directly to a table does nothing.
</td></tr></tbody></table></div>
<p>Let’s exercise that metamethod:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>print(tostring(arr))</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>print(tostring(arr))</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>print(tostring(arr))</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>print(tostring(arr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This yields:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>This is print number: 1 for an array of size 3</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>This is print number: 2 for an array of size 3</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>This is print number: 3 for an array of size 3</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>This is print number: 4 for an array of size 3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The built-in <code>tostring</code> method now redirects calls to the <code>mt.__tostring</code> method. If we remove the metatable:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setmetatable</span><span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="kw">nil</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then <code>tostring(tbl)</code> reverts to something like:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>table: 0x15f852480</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Well, suppose the user is sophisticated enough to have added a custom <code>__tostring</code> metamethod to return a custom string for a particular table or class of tables. In that case, we should honour their effort by using that method.</p>
<p>We can add a call to the top of <code>table_string</code> to check for a custom <code>__tostring</code> metamethod and, if present, use that instead of our paltry efforts.</p>
<p>However, it is best to make that optional, which we do by adding a field to our options table:</p>
<div class="sourceCode" id="annotated-cell-196"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-196-1"><a href="#annotated-cell-196-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">options</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-196-2"><a href="#annotated-cell-196-2" aria-hidden="true" tabindex="-1"></a><span class="va">options</span><span class="op">.</span><span class="va">pretty</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="annotated-cell-196-3"><a href="#annotated-cell-196-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">indent</span>        <span class="op">=</span> <span class="st">'    '</span><span class="op">,</span></span>
<span id="annotated-cell-196-4"><a href="#annotated-cell-196-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_begin</span>   <span class="op">=</span> <span class="st">'{'</span><span class="op">,</span></span>
<span id="annotated-cell-196-5"><a href="#annotated-cell-196-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">table_end</span>     <span class="op">=</span> <span class="st">'}'</span><span class="op">,</span></span>
<span id="annotated-cell-196-6"><a href="#annotated-cell-196-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_begin</span>   <span class="op">=</span> <span class="st">'['</span><span class="op">,</span></span>
<span id="annotated-cell-196-7"><a href="#annotated-cell-196-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">array_end</span>     <span class="op">=</span> <span class="st">']'</span><span class="op">,</span></span>
<span id="annotated-cell-196-8"><a href="#annotated-cell-196-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_begin</span>     <span class="op">=</span> <span class="st">''</span><span class="op">,</span></span>
<span id="annotated-cell-196-9"><a href="#annotated-cell-196-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">key_end</span>       <span class="op">=</span> <span class="st">' = '</span><span class="op">,</span></span>
<span id="annotated-cell-196-10"><a href="#annotated-cell-196-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">sep</span>           <span class="op">=</span> <span class="st">','</span><span class="op">,</span></span>
<span id="annotated-cell-196-11"><a href="#annotated-cell-196-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_spacer</span> <span class="op">=</span> <span class="st">' '</span><span class="op">,</span></span>
<span id="annotated-cell-196-12"><a href="#annotated-cell-196-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">show_indices</span>  <span class="op">=</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="annotated-cell-196-13"><a href="#annotated-cell-196-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">comparator</span>    <span class="op">=</span> <span class="va">compare</span><span class="op">,</span></span>
<span id="annotated-cell-196-14"><a href="#annotated-cell-196-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">inline_size</span>   <span class="op">=</span> <span class="fu">math.huge</span><span class="op">,</span></span>
<span id="annotated-cell-196-15"><a href="#annotated-cell-196-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_root</span>     <span class="op">=</span> <span class="st">'table'</span><span class="op">,</span></span>
<span id="annotated-cell-196-16"><a href="#annotated-cell-196-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_sep</span>      <span class="op">=</span> <span class="st">'.'</span><span class="op">,</span></span>
<span id="annotated-cell-196-17"><a href="#annotated-cell-196-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_begin</span>    <span class="op">=</span> <span class="st">'&lt;'</span><span class="op">,</span></span>
<span id="annotated-cell-196-18"><a href="#annotated-cell-196-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">path_end</span>      <span class="op">=</span> <span class="st">'&gt;'</span><span class="op">,</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-196" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-196-19" class="code-annotation-target"><a href="#annotated-cell-196-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">use_metatable</span> <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="annotated-cell-196-20"><a href="#annotated-cell-196-20" aria-hidden="true" tabindex="-1"></a>    <span class="cn">COMPLETE</span>      <span class="op">=</span> <span class="kw">true</span></span>
<span id="annotated-cell-196-21"><a href="#annotated-cell-196-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-196" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-196" data-code-lines="19" data-code-annotation="1">If <code>true</code> and if there is a custom <code>__tostring</code> metamethod, then we redirect the table conversion to that method.</span>
</dd>
</dl>
<p>With that change, the top of the <code>table_string</code> looks like this:</p>
<div class="sourceCode" id="annotated-cell-197"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-197-1"><a href="#annotated-cell-197-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> table_string<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span></span>
<span id="annotated-cell-197-2"><a href="#annotated-cell-197-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-197-3"><a href="#annotated-cell-197-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="kw">function</span> process<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">path</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-197" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-197-4" class="code-annotation-target"><a href="#annotated-cell-197-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">opts</span><span class="op">.</span><span class="va">use_metatable</span> <span class="cf">then</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-197" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-197-5" class="code-annotation-target"><a href="#annotated-cell-197-5" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">mt</span> <span class="op">=</span> <span class="fu">getmetatable</span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-197" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-197-6" class="code-annotation-target"><a href="#annotated-cell-197-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">mt</span> <span class="kw">and</span> <span class="va">mt</span><span class="op">.</span><span class="va">__tostring</span> <span class="cf">then</span> <span class="cf">return</span> <span class="va">mt</span><span class="op">.</span>__tostring<span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-197-7"><a href="#annotated-cell-197-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-197-8"><a href="#annotated-cell-197-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">...</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-197" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-197" data-code-lines="4" data-code-annotation="1">Check whether we are allowed to use metamethods.</span>
</dd>
<dt data-target-cell="annotated-cell-197" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-197" data-code-lines="5" data-code-annotation="2">Check whether <code>tbl</code> has a metatable.</span>
</dd>
<dt data-target-cell="annotated-cell-197" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-197" data-code-lines="6" data-code-annotation="3">If <code>tbl</code> has an associated <code>__tostring</code> metamethod, invoke it and return early.</span>
</dd>
</dl>
<p>For example, if:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">count</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">mt</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">mt</span><span class="op">.</span>__tostring<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">count</span> <span class="op">=</span> <span class="va">count</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'This is print number: '</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">count</span><span class="op">)</span> <span class="op">..</span> <span class="st">' for a table of size: '</span> <span class="op">..</span> <span class="op">#</span><span class="va">tbl</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">tbl</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span> <span class="op">}</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="fu">setmetatable</span><span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">mt</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then <code>print(pretty(tbl))</code> yields:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>This is print number: 1 for a table of size: 3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="why-optional" class="level3">
<h3 class="anchored" data-anchor-id="why-optional">Why Optional?</h3>
<p>Can you guess why we made using any custom <code>__tostring</code> metamethod controllable as a format option? When wouldn’t we want to use it?</p>
<p>Metamethods like <code>__tostring</code> are usually attached to a whole <em>class</em> of tables instead of a particular instance. The method might do something specific to the class as a whole and then defer much of the work back to <code>scribe</code> to convert the instance data to a string.</p>
<p>You then run into the danger of chasing your tail. The custom <code>__tostring</code> method calls <code>table_string</code>, which then calls the <code>__tostring</code> method and so on, ad infinitum!</p>
<p>In this case, we must set the <code>opts.use_metatable</code> to <code>false</code> to break the cycle.</p>
<p>Here’s an example:</p>
<div class="sourceCode" id="annotated-cell-200"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-200-1"><a href="#annotated-cell-200-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">count</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="annotated-cell-200-2"><a href="#annotated-cell-200-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">mt</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-200-3"><a href="#annotated-cell-200-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">mt</span><span class="op">.</span>__tostring<span class="op">(</span><span class="va">tbl</span><span class="op">)</span></span>
<span id="annotated-cell-200-4"><a href="#annotated-cell-200-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">count</span> <span class="op">=</span> <span class="va">count</span> <span class="op">+</span> <span class="dv">1</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-200" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-200-5" class="code-annotation-target"><a href="#annotated-cell-200-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tbl_options</span> <span class="op">=</span> <span class="op">{</span> <span class="va">use_metatable</span> <span class="op">=</span> <span class="kw">false</span> <span class="op">}</span></span>
<span id="annotated-cell-200-6"><a href="#annotated-cell-200-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">tbl_string</span>  <span class="op">=</span> inline<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">tbl_options</span><span class="op">)</span></span>
<span id="annotated-cell-200-7"><a href="#annotated-cell-200-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">'Print: '</span> <span class="op">..</span> <span class="fu">tostring</span><span class="op">(</span><span class="va">count</span><span class="op">)</span> <span class="op">..</span> <span class="st">' for table: '</span> <span class="op">..</span> <span class="va">tbl_string</span></span>
<span id="annotated-cell-200-8"><a href="#annotated-cell-200-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-200" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-200" data-code-lines="5" data-code-annotation="1">With this override, the following line will cause a stack overflow.</span>
</dd>
</dl>
<p>Then:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">tbl</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span> <span class="op">}</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setmetatable</span><span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">mt</span><span class="op">)</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span>pretty<span class="op">(</span><span class="va">tbl</span><span class="op">))</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span>pretty<span class="op">(</span><span class="va">tbl</span><span class="op">))</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span>pretty<span class="op">(</span><span class="va">tbl</span><span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Yields:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>Print: 1 for table: [ 1, 2, 3 ]</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>Print: 2 for table: [ 1, 2, 3 ]</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>Print: 3 for table: [ 1, 2, 3 ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="the-scribe-module" class="level2">
<h2 class="anchored" data-anchor-id="the-scribe-module">The <code>scribe</code> Module</h2>
<p>In Lua, if you have a file where you set:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="va">answer</span> <span class="op">=</span> <span class="dv">42</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You are creating a <em>global</em> variable <code>answer</code> with the value <code>42</code>. This means that <code>answer</code> is available to all other Lua files that are loaded after this one.</p>
<p>On the other hand, if you write:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">answer</span> <span class="op">=</span> <span class="dv">42</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You are creating a <em>local</em> variable <code>answer</code> that is only available in the current file.</p>
<p>The same thing applies to functions. If you write:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> bump<span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">answer</span> <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">a</span> <span class="op">+</span> <span class="va">answer</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then <code>bump</code> is a <em>global</em> function that can be called from any other Lua file. Moreover, even though <code>answer</code> is set in the <code>bump</code> function, it is a <em>global</em> variable that can be accessed and modified from anywhere.</p>
<p>On the other hand, if you write:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> bump<span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">answer</span> <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">a</span> <span class="op">+</span> <span class="va">answer</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then <code>bump</code> is a <em>local</em> function that can only be called from within the current file. <code>answer</code> is a <em>local</em> variable that can only be accessed and modified within the function <code>bump</code>.</p>
<p>Prepending <code>local</code> to variables and functions confines them to the enclosing scope.</p>
<p>This is a good practice because it reduces the chance of inadvertently modifying variables or functions that are used elsewhere. It also makes the intent of the code much clearer.</p>
<p>In general, you should always use <code>local</code> unless you have a good reason not to.</p>
<div class="admonition note">
    <table><tbody><tr>
    <td class="icon"> <i class="fa icon-note" title="Note"></i></td>
    <td class="content">
    
In Lua, the <code>local</code> keyword is used to declare variables and functions as local to the block in which they are declared. I suspect that, with the benefit of hindsight, Lua’s designers would choose to make <code>local</code> the default and added some other keyword to make variables <code>global</code>. You will have many more <code>local</code> variables than <code>global</code> ones in your code, so that switch would be very beneficial. However, that is not the way Lua is designed, so you must remember to use <code>local</code> to keep your code clean and maintainable.
</td></tr></tbody></table></div>
<p>We have been fairly careful to use <code>local</code> in our code to this point.</p>
<section id="modules" class="level3">
<h3 class="anchored" data-anchor-id="modules">Modules</h3>
<p>There is a further level of encapsulation that we have not yet discussed: <em>modules</em>.</p>
<p>A module is a collection of functions and variables that are grouped together in a single Lua table. The table is returned by the module and can be used to access the functions and variables within it.</p>
<p>Here is a simple example of a module in a file called <code>answer.lua</code>:</p>
<div class="sourceCode" id="annotated-cell-207"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-207" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-207-1" class="code-annotation-target"><a href="#annotated-cell-207-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="cn">M</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-207-2"><a href="#annotated-cell-207-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-207" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-207-3" class="code-annotation-target"><a href="#annotated-cell-207-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">answer</span> <span class="op">=</span> <span class="dv">42</span></span>
<span id="annotated-cell-207-4"><a href="#annotated-cell-207-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-207" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-207-5" class="code-annotation-target"><a href="#annotated-cell-207-5" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>bump<span class="op">(</span><span class="va">a</span><span class="op">)</span></span>
<span id="annotated-cell-207-6"><a href="#annotated-cell-207-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">a</span> <span class="op">+</span> <span class="va">answer</span></span>
<span id="annotated-cell-207-7"><a href="#annotated-cell-207-7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-207-8"><a href="#annotated-cell-207-8" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-207" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-207-9" class="code-annotation-target"><a href="#annotated-cell-207-9" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="cn">M</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-207" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-207" data-code-lines="1" data-code-annotation="1">We create a local table <code>M</code> to hold our module. <br> The name <code>M</code> is a common convention and has nothing to do with how the module is stored or used.</span>
</dd>
<dt data-target-cell="annotated-cell-207" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-207" data-code-lines="3" data-code-annotation="2"><code>answer</code> is a local variable that is only accessible within the module (within <code>answer.lua</code>).</span>
</dd>
<dt data-target-cell="annotated-cell-207" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-207" data-code-lines="5" data-code-annotation="3">We define a function <code>bump</code> <em>within</em> the module. It will become publicly accessible.</span>
</dd>
<dt data-target-cell="annotated-cell-207" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-207" data-code-lines="9" data-code-annotation="4">We export the module at the end of the file where it’s defined. <br> The <code>return M</code> statement makes the module available to any other Lua file that <code>require</code>s it.</span>
</dd>
</dl>
<p>To use the module in another file, you would write:</p>
<div class="sourceCode" id="annotated-cell-208"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-208" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-208-1" class="code-annotation-target"><a href="#annotated-cell-208-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">answer</span> <span class="op">=</span> <span class="fu">require</span> <span class="st">'answer'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-208" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-208-2" class="code-annotation-target"><a href="#annotated-cell-208-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">answer</span><span class="op">.</span>bump<span class="op">(</span><span class="dv">10</span><span class="op">))</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-208" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-208" data-code-lines="1" data-code-annotation="1"><code>require</code> is a built-in Lua function that loads a module and returns the table that the module exports.</span>
</dd>
<dt data-target-cell="annotated-cell-208" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-208" data-code-lines="2" data-code-annotation="2">We call the <code>bump</code> function from the <code>answer</code> module to print 52.</span>
</dd>
</dl>
<p>Notice that the <code>answer</code> module is a self-contained unit. It has its own local variables (and potentially local functions) that are <em>private</em> and not accessible from outside the module. The only way to interact with the module is through the functions and variables that it exports. Generally, the only thing that a module exports is a table that contains the functions and variables that you want to make available to the outside world. What you call the module internally is up to you, but the convention is to use <code>M</code>.</p>
<p>Typically, the user of the module will import the module into a local variable with the same name as the module’s file (without the <code>.lua</code> extension) though that is not a requirement.</p>
<p>Modules are a powerful way to organize your code and keep it clean and maintainable.</p>
</section>
<section id="the-scribe-module-1" class="level3">
<h3 class="anchored" data-anchor-id="the-scribe-module-1">The <code>scribe</code> Module</h3>
<p>Here is a sketch of how we can turn our current code into a module defined in a file called <code>scribe.lua</code>:</p>
<div class="sourceCode" id="annotated-cell-209"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-209" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-209-1" class="code-annotation-target"><a href="#annotated-cell-209-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="cn">M</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-209-2"><a href="#annotated-cell-209-2" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-209" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-209-3" class="code-annotation-target"><a href="#annotated-cell-209-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> indent_string<span class="op">(</span><span class="va">str</span><span class="op">,</span> <span class="va">indent</span><span class="op">,</span> <span class="va">ignore_first_line</span><span class="op">)</span></span>
<span id="annotated-cell-209-4"><a href="#annotated-cell-209-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="annotated-cell-209-5"><a href="#annotated-cell-209-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-209-6"><a href="#annotated-cell-209-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-209-7"><a href="#annotated-cell-209-7" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> compare<span class="op">(</span><span class="va">a</span><span class="op">,</span> <span class="va">b</span><span class="op">)</span>              <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-8"><a href="#annotated-cell-209-8" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> ordered_pairs<span class="op">(</span><span class="va">comparator</span><span class="op">)</span>             <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-9"><a href="#annotated-cell-209-9" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> simple_string<span class="op">(</span><span class="va">obj</span><span class="op">)</span>                    <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-10"><a href="#annotated-cell-209-10" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> empty_table_string<span class="op">(</span><span class="va">opts</span><span class="op">)</span>              <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-11"><a href="#annotated-cell-209-11" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> metadata<span class="op">(</span><span class="va">root_tbl</span><span class="op">)</span>                    <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-12"><a href="#annotated-cell-209-12" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> table_string<span class="op">(</span><span class="va">root_tbl</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span>          <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-13"><a href="#annotated-cell-209-13" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> table_clone<span class="op">(</span><span class="va">tbl</span><span class="op">)</span>                      <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-14"><a href="#annotated-cell-209-14" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> complete_options_table<span class="op">(</span><span class="va">options</span><span class="op">,</span> <span class="va">from</span><span class="op">)</span> <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-15"><a href="#annotated-cell-209-15" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-209" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-209-16" class="code-annotation-target"><a href="#annotated-cell-209-16" aria-hidden="true" tabindex="-1"></a><span class="cn">M</span><span class="op">.</span><span class="va">options</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-209-17"><a href="#annotated-cell-209-17" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-209" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-209-18" class="code-annotation-target"><a href="#annotated-cell-209-18" aria-hidden="true" tabindex="-1"></a><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span>      <span class="op">=</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-209" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-209-19" class="code-annotation-target"><a href="#annotated-cell-209-19" aria-hidden="true" tabindex="-1"></a><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">inline</span>      <span class="op">=</span> table_clone<span class="op">(</span><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="annotated-cell-209-20"><a href="#annotated-cell-209-20" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="annotated-cell-209-21"><a href="#annotated-cell-209-21" aria-hidden="true" tabindex="-1"></a><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">classic</span>     <span class="op">=</span> table_clone<span class="op">(</span><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="annotated-cell-209-22"><a href="#annotated-cell-209-22" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="annotated-cell-209-23"><a href="#annotated-cell-209-23" aria-hidden="true" tabindex="-1"></a><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">alt</span>         <span class="op">=</span> table_clone<span class="op">(</span><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="annotated-cell-209-24"><a href="#annotated-cell-209-24" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="annotated-cell-209-25"><a href="#annotated-cell-209-25" aria-hidden="true" tabindex="-1"></a><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">json</span>        <span class="op">=</span> table_clone<span class="op">(</span><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="annotated-cell-209-26"><a href="#annotated-cell-209-26" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="annotated-cell-209-27"><a href="#annotated-cell-209-27" aria-hidden="true" tabindex="-1"></a><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">inline_json</span> <span class="op">=</span> table_clone<span class="op">(</span><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">json</span><span class="op">)</span></span>
<span id="annotated-cell-209-28"><a href="#annotated-cell-209-28" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="annotated-cell-209-29"><a href="#annotated-cell-209-29" aria-hidden="true" tabindex="-1"></a><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">debug</span>       <span class="op">=</span> table_clone<span class="op">(</span><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">)</span></span>
<span id="annotated-cell-209-30"><a href="#annotated-cell-209-30" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="annotated-cell-209-31"><a href="#annotated-cell-209-31" aria-hidden="true" tabindex="-1"></a><span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">default</span>     <span class="op">=</span> <span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">inline</span></span>
<span id="annotated-cell-209-32"><a href="#annotated-cell-209-32" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="annotated-cell-209-33"><a href="#annotated-cell-209-33" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-209" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-209-34" class="code-annotation-target"><a href="#annotated-cell-209-34" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>scribe<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">opts</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span></span>
<span id="annotated-cell-209-35"><a href="#annotated-cell-209-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">type</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="op">~=</span> <span class="st">'table'</span> <span class="cf">then</span> <span class="cf">return</span> simple_string<span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-209-36"><a href="#annotated-cell-209-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-209-37"><a href="#annotated-cell-209-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">opts</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="cf">return</span> table_string<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">default</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-209-38"><a href="#annotated-cell-209-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-209-39"><a href="#annotated-cell-209-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">opts</span><span class="op">.</span><span class="cn">COMPLETE</span> <span class="cf">then</span></span>
<span id="annotated-cell-209-40"><a href="#annotated-cell-209-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">from</span> <span class="op">=</span> <span class="va">opts</span><span class="op">.</span><span class="va">indent</span> <span class="op">==</span> <span class="st">''</span> <span class="kw">and</span> <span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">inline</span> <span class="kw">or</span> <span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="annotated-cell-209-41"><a href="#annotated-cell-209-41" aria-hidden="true" tabindex="-1"></a>        complete_options_table<span class="op">(</span><span class="va">opts</span><span class="op">,</span> <span class="va">from</span><span class="op">)</span></span>
<span id="annotated-cell-209-42"><a href="#annotated-cell-209-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-209-43"><a href="#annotated-cell-209-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">overrides</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="cf">return</span> table_string<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-209-44"><a href="#annotated-cell-209-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-209-45"><a href="#annotated-cell-209-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">overrides</span><span class="op">.</span><span class="cn">COMPLETE</span> <span class="cf">then</span> complete_options_table<span class="op">(</span><span class="va">overrides</span><span class="op">,</span> <span class="va">opts</span><span class="op">)</span> <span class="cf">end</span></span>
<span id="annotated-cell-209-46"><a href="#annotated-cell-209-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table_string<span class="op">(</span><span class="va">obj</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span></span>
<span id="annotated-cell-209-47"><a href="#annotated-cell-209-47" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-209-48"><a href="#annotated-cell-209-48" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-209" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-209-49" class="code-annotation-target"><a href="#annotated-cell-209-49" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>pretty<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span></span>
<span id="annotated-cell-209-50"><a href="#annotated-cell-209-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cn">M</span><span class="op">.</span>scribe<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="cn">M</span><span class="op">.</span><span class="va">options</span><span class="op">.</span><span class="va">pretty</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span></span>
<span id="annotated-cell-209-51"><a href="#annotated-cell-209-51" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-209-52"><a href="#annotated-cell-209-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-209-53"><a href="#annotated-cell-209-53" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>inline<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span>       <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-54"><a href="#annotated-cell-209-54" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>classic<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span>      <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-55"><a href="#annotated-cell-209-55" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>alt<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span>          <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-56"><a href="#annotated-cell-209-56" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>json<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span>         <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-57"><a href="#annotated-cell-209-57" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>inline_json<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span>  <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-58"><a href="#annotated-cell-209-58" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>debug<span class="op">(</span><span class="va">tbl</span><span class="op">,</span> <span class="va">overrides</span><span class="op">)</span>        <span class="op">...</span> <span class="kw">end</span></span>
<span id="annotated-cell-209-59"><a href="#annotated-cell-209-59" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-209" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-209-60" class="code-annotation-target"><a href="#annotated-cell-209-60" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="cn">M</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-209" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-209" data-code-lines="1" data-code-annotation="1">We create a local table <code>M</code> to hold our module. <br> It will contain all of the functions and variables that we want to export.</span>
</dd>
<dt data-target-cell="annotated-cell-209" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-209" data-code-lines="3" data-code-annotation="2">We define all the private helper functions that we need for our module. <br> These functions are declared as <code>local</code> and are not accessible from outside the module.</span>
</dd>
<dt data-target-cell="annotated-cell-209" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-209" data-code-lines="16" data-code-annotation="3">We create a table <code>M.options</code> to hold all of the options that we will use in our module. <br> These will all be accessible from the outside as we want the user to be able to modify them.</span>
</dd>
<dt data-target-cell="annotated-cell-209" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-209" data-code-lines="18" data-code-annotation="4">Where before we had <code>options.pretty = { ... }</code>, we now have <code>M.options.pretty = { ... }</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-209" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-209" data-code-lines="19" data-code-annotation="5">And so on for the other tables of formatting parameters.</span>
</dd>
<dt data-target-cell="annotated-cell-209" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-209" data-code-lines="34" data-code-annotation="6">The main <code>scribe</code> function is now a member of the module. <br> It is shown in full so you can see how it uses both public options data and private helper functions.</span>
</dd>
<dt data-target-cell="annotated-cell-209" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-209" data-code-lines="49" data-code-annotation="7">This is true for all our convenience facade functions, like <code>pretty</code>, <code>inline</code>, <code>classic</code>, etc.</span>
</dd>
<dt data-target-cell="annotated-cell-209" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-209" data-code-lines="60" data-code-annotation="8">We finish by <em>exporting</em> the module by returning the table <code>M</code>.</span>
</dd>
</dl>
<p>Here is how you would use the <code>scribe</code> module in another file:</p>
<div class="sourceCode" id="annotated-cell-210"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-210" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-210-1" class="code-annotation-target"><a href="#annotated-cell-210-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">scribe</span> <span class="op">=</span> <span class="fu">require</span> <span class="st">'scribe'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-210" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-210-2" class="code-annotation-target"><a href="#annotated-cell-210-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">scribe</span><span class="op">.</span>pretty<span class="op">({</span><span class="va">a</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="va">b</span> <span class="op">=</span> <span class="dv">2</span><span class="op">}))</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-210" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-210" data-code-lines="1" data-code-annotation="1">We import the <code>scribe</code> module into a local variable <code>scribe</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-210" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-210" data-code-lines="2" data-code-annotation="2">We call the <code>classic</code> function from the module to print a nicely formatted table.</span>
</dd>
</dl>
<p>This yields:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    a = 1,</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    b = 2</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="a-little-bonus" class="level3">
<h3 class="anchored" data-anchor-id="a-little-bonus">A Little Bonus</h3>
<p>Once you’ve loaded the <code>scribe</code> module, you can access the <code>pretty</code> function as <code>scribe.pretty</code> and so on. If you care about using the <code>pretty</code> function a lot, you can make it available as a local variable in your file:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">scribe</span> <span class="op">=</span> <span class="fu">require</span> <span class="st">'scribe'</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">pretty</span> <span class="op">=</span> <span class="va">scribe</span><span class="op">.</span><span class="va">pretty</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">inline</span> <span class="op">=</span> <span class="va">scribe</span><span class="op">.</span><span class="va">inline</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It would also be nice to have a shorthand for <code>scribe.scribe</code>.</p>
<p>We add a <code>__call</code> metamethod to the <code>scribe</code> table to do that. Lua calls this metamethod when you treat the table as a function (i.e.&nbsp;when you use <code>scribe(...)</code>).</p>
<p>Metamethods do not go in the module table itself. Instead, you give the module table a metatable that contains the metamethods. This extra level can seem confusing to judge by the number of questions about it on the internet.</p>
<p>In our case, we add the <code>__call</code> metamethod to the metatable of the <code>scribe</code> module as follows:</p>
<div class="sourceCode" id="annotated-cell-213"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-213" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-213-1" class="code-annotation-target"><a href="#annotated-cell-213-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">mt</span> <span class="op">=</span> <span class="op">{}</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-213" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-213-2" class="code-annotation-target"><a href="#annotated-cell-213-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">mt</span><span class="op">.</span>__call<span class="op">(</span><span class="cn">_</span><span class="op">,</span> <span class="op">...)</span> <span class="cf">return</span> <span class="cn">M</span><span class="op">.</span>scribe<span class="op">(...)</span> <span class="kw">end</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-213" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-213-3" class="code-annotation-target"><a href="#annotated-cell-213-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setmetatable</span><span class="op">(</span><span class="cn">M</span><span class="op">,</span> <span class="va">mt</span><span class="op">)</span></span>
<span id="annotated-cell-213-4"><a href="#annotated-cell-213-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-213-5"><a href="#annotated-cell-213-5" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="cn">M</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-213" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-213" data-code-lines="1" data-code-annotation="1">Start with an ordinary empty table <code>mt</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-213" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-213" data-code-lines="2" data-code-annotation="2">Add the <code>__call</code> metamethod to the table. <br> The first argument to the metamethod is the table itself, but we don’t need it so we use <code>_</code>. <br> The <code>...</code> collects all the arguments passed to the function.</span>
</dd>
<dt data-target-cell="annotated-cell-213" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-213" data-code-lines="3" data-code-annotation="3">We endow our module table <code>M</code> with the metatable <code>mt</code> that contains the metamethods.</span>
</dd>
</dl>
<p>You can use <code>_</code> as a placeholder for any argument you don’t need. Also, note that <code>...</code> is a special variable that collects all the arguments passed to a function and forwards them unchanged.</p>
<p>With that addition, you can now use <code>scribe</code> as a function:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">scribe</span> <span class="op">=</span> <span class="fu">require</span> <span class="st">'scribe'</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span>scribe<span class="op">({</span><span class="va">a</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="va">b</span> <span class="op">=</span> <span class="dv">2</span><span class="op">}))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will print the same table as before: <code>{a = 1, b = 2}</code>.</p>
</section>
<section id="require-gotcha" class="level3">
<h3 class="anchored" data-anchor-id="require-gotcha"><code>require</code> Gotcha</h3>
<p><code>require</code> is a built-in Lua function that loads a module and returns whatever the module exports.</p>
<p>It looks for the module’s source file using Lua’s <code>package.path</code> variable. This is a long string of directories that Lua searches for files when you <code>require</code> them. The different directories in <code>package.path</code> are separated by semicolons.</p>
<p>Running Lua from the command line and typing:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">package.path</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I get something like:</p>
<div class="sourceCode" id="annotated-cell-216"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><a class="code-annotation-anchor" data-target-cell="annotated-cell-216" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-216-1" class="code-annotation-target"><a href="#annotated-cell-216-1" aria-hidden="true" tabindex="-1"></a>/usr/local/share/lua/5.4/?.lua;</span>
<span id="annotated-cell-216-2"><a href="#annotated-cell-216-2" aria-hidden="true" tabindex="-1"></a>/usr/local/share/lua/5.4/?/init.lua;</span>
<span id="annotated-cell-216-3"><a href="#annotated-cell-216-3" aria-hidden="true" tabindex="-1"></a>/usr/local/lib/lua/5.4/?.lua;</span>
<span id="annotated-cell-216-4"><a href="#annotated-cell-216-4" aria-hidden="true" tabindex="-1"></a>/usr/local/lib/lua/5.4/?/init.lua;</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-216" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-216-5" class="code-annotation-target"><a href="#annotated-cell-216-5" aria-hidden="true" tabindex="-1"></a>./?.lua;</span>
<span id="annotated-cell-216-6"><a href="#annotated-cell-216-6" aria-hidden="true" tabindex="-1"></a>./?/init.lua</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-216" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-216" data-code-lines="1" data-code-annotation="1">Actually, the output is on a single line, but I have broken it up for clarity.</span>
</dd>
<dt data-target-cell="annotated-cell-216" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-216" data-code-lines="5" data-code-annotation="2">The <code>.</code> refers to the current directory.</span>
</dd>
</dl>
<p>The first four entries are the system directories where Lua looks for modules. Those were set when Lua was installed. The <code>./?.lua</code> entry tells Lua to also look for modules in the “current” directory.</p>
<p>By the way, the <code>?</code> is a wildcard that Lua replaces with the file name you are searching for.</p>
<p>With this setup you drop the <code>scribe.lua</code> in the same directory as your main Lua file and you can <code>require</code> it. Everything will work fine.</p>
<p>However, these days you are quite likely to run Lua from an IDE or perhaps via a plugin in another application. For example, I sometimes run Lua from <a href="https://studio.zerobrane.com">ZeroBrane Studio</a> which is a free lightweight IDE for Lua with a a full featured debugger (it’s cross-platform and highly recommended). Other times I run Lua from <a href="https://code.visualstudio.com">Visual Studio Code</a> with the <a href="https://marketplace.visualstudio.com/items?itemName=sumneko.lua">Lua for Visual Studio Code</a> extension.</p>
<p>In both these cases, the current directory is not the directory where your Lua files are! Instead, it is the directory where the IDE or plugin is installed.</p>
<p>When you run Lua from these environments, you will get an error when you try to <code>require</code> a module in the same directory as your main Lua file. The error will be something like:</p>
<div class="sourceCode" id="annotated-cell-217"><pre class="sourceCode txt code-annotation-code code-with-copy code-annotated"><code class="sourceCode default"><span id="annotated-cell-217-1"><a href="#annotated-cell-217-1" aria-hidden="true" tabindex="-1"></a>module 'scribe' not found:</span>
<span id="annotated-cell-217-2"><a href="#annotated-cell-217-2" aria-hidden="true" tabindex="-1"></a>    no field package.preload['scribe']</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-217" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-217-3" class="code-annotation-target"><a href="#annotated-cell-217-3" aria-hidden="true" tabindex="-1"></a>    no file './scribe.lua'</span>
<span id="annotated-cell-217-4"><a href="#annotated-cell-217-4" aria-hidden="true" tabindex="-1"></a>    no file '/usr/local/share/lua/5.4/scribe.lua'</span>
<span id="annotated-cell-217-5"><a href="#annotated-cell-217-5" aria-hidden="true" tabindex="-1"></a>    no file '/usr/local/share/lua/5.4/scribe/init.lua'</span>
<span id="annotated-cell-217-6"><a href="#annotated-cell-217-6" aria-hidden="true" tabindex="-1"></a>    ...</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-217" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-217" data-code-lines="3" data-code-annotation="1">This <code>no file</code> line will make you scratch your head!</span>
</dd>
</dl>
<p>It appears that Lua is looking for <code>./scribe.lua</code> and not finding it even though it is clearly in the same directory as your main Lua file. You’ll probably double and triple check the file is there and that you have spelled the name correctly. Nothing will help.</p>
<p>The confusion arises because you think <code>.</code> is the directory where your main Lua file is but the IDE or plugin sees it as the directory where the IDE or plugin is installed.</p>
<p>The solution is to add the script’s directory to <code>package.path</code>. You could hardcode that directory name and append it to <code>package.path</code> but that’s clunky. If you change the directory structure of your project, you will have to remember to change the hardcoded path.</p>
<p>Instead, you can use Lua’s <code>debug</code> library to get the directory of the current source file. Here is how you can do that:</p>
<div class="sourceCode" id="annotated-cell-218"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-218" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-218-1" class="code-annotation-target"><a href="#annotated-cell-218-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">source_dir</span> <span class="op">=</span> <span class="fu">debug.getinfo</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="st">'S'</span><span class="op">).</span><span class="va">source</span><span class="op">:</span><span class="fu">match</span> <span class="vs">[[^@?(.*[\/])[^\/]-$]]</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-218" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-218-2" class="code-annotation-target"><a href="#annotated-cell-218-2" aria-hidden="true" tabindex="-1"></a><span class="va">package.path</span> <span class="op">=</span> <span class="va">source_dir</span> <span class="op">..</span> <span class="st">"?.lua;"</span> <span class="op">..</span> <span class="va">package.path</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-218" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-218" data-code-lines="1" data-code-annotation="1">This magic incantation gets the directory of the current source file.</span>
</dd>
<dt data-target-cell="annotated-cell-218" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-218" data-code-lines="2" data-code-annotation="2">This line appends the directory to <code>package.path</code>.</span>
</dd>
</dl>
<p>You can put these lines at the top of your main Lua file and they will ensure that <code>require</code> works correctly.</p>
<p>This isn’t terribly elegant, but it is a portable way to ensure that your modules are found in the “current” directory when you run Lua from an IDE or plugin.</p>
</section>
<section id="luarocks" class="level3">
<h3 class="anchored" data-anchor-id="luarocks">LuaRocks</h3>
<p><code>scribe</code>, like many Lua modules, is available via LuaRocks.</p>
<p>LuaRocks is the package manager for Lua modules and, when you install LuaRocks, it makes sure that any modules you install using it are available to Lua via <code>require</code>. It adds some LuaRocks standard directories to <code>package.path</code> so that Lua can find the modules.</p>
<p>If you install <code>scribe</code> using LuaRocks, you won’t have to worry about the <code>require</code> gotcha. LuaRocks will take care of everything for you.</p>
</section>
<section id="summary" class="level3">
<h3 class="anchored" data-anchor-id="summary">Summary</h3>
<p>At this point we have a developed a production ready version of <code>scribe</code>. It produces readable outputs for complex tables with cyclical references. <code>scribe</code> also supports options for customizing the output in many ways.</p>
<p>Our module also comes with pre-packaged styles for common output formats and simple to user-friendly functions for printing tables in those formats. For the most part, the user can just call <code>pretty</code> or <code>json</code>, etc. and get a good result without having to worry about the details.</p>
</section>
</section>
<section id="formatted-output" class="level2">
<h2 class="anchored" data-anchor-id="formatted-output">Formatted Output</h2>
<p>Stringing together messages using concatenation quickly becomes cumbersome.</p>
<p>Lua provides a simple way to format strings using the <code>string.format</code> method, similar to the <a href="https://en.cppreference.com/w/c/io/fprintf"><code>sprintf</code></a> function in C.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="fu">string.format</span><span class="op">(</span><span class="st">"The value of %s is %.2f"</span><span class="op">,</span> <span class="st">'pi'</span><span class="op">,</span> <span class="va">math.pi</span><span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This prints <code>The value of pi is 3.14</code> to your screen.</p>
<p>The format string <code>"The value of %s is %.2f"</code> is a template containing placeholders for the values you want to insert. It is a recipe for baking a string by replacing the placeholders with the trailing arguments to <code>string.format</code>.</p>
<p>The general form for calling <code>string.format</code> is:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu">string.format</span><span class="op">(</span><span class="va">format_string</span><span class="op">,</span> <span class="va">arg1</span><span class="op">,</span> <span class="va">arg2</span><span class="op">,</span> <span class="op">...)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The first argument is the format string; the rest are the values that <code>string.format</code> will insert into the placeholders. It is a <em>variadic</em> function, which means it can take any number of arguments after the format string.</p>
<p>Placeholders like <code>%s</code> and <code>%f</code> are format <em>specifiers</em> that tell <code>string.format</code> to look for a trailing argument that is a string and another that is a floating point number. The <code>.2</code> in <code>%.2f</code> is a format <em>modifier</em>, and it tells <code>string.format</code> to round the floating point number to two decimal places. The placeholders are replaced by the trailing arguments in the order they appear in the format string.</p>
<p><code>string.format</code> is identical to the venerable <a href="https://en.cppreference.com/w/c/io/fprintf"><code>sprintf</code></a> function in C, and it supports almost all the same format specifiers and modifiers. We already mentioned that it adds a couple of extra format specifiers, like <code>%q</code>, which are not available in C. It drops a few of the more esoteric format specifiers rarely used in practice.</p>
<p>At some point, everyone recreates the same wrapper around <code>string.format</code> that looks like this:</p>
<div class="sourceCode" id="annotated-cell-221"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><a class="code-annotation-anchor" data-target-cell="annotated-cell-221" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-221-1" class="code-annotation-target"><a href="#annotated-cell-221-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> printf<span class="op">(</span><span class="va">format_string</span><span class="op">,</span> <span class="op">...)</span></span>
<span id="annotated-cell-221-2"><a href="#annotated-cell-221-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span><span class="op">(</span><span class="fu">string.format</span><span class="op">(</span><span class="va">format_string</span><span class="op">,</span> <span class="op">...))</span></span>
<span id="annotated-cell-221-3"><a href="#annotated-cell-221-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-221" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-221" data-code-lines="1" data-code-annotation="1">The name used here is <code>printf</code> to mimic the C function of the same name.</span>
</dd>
</dl>
<p>You can use this function to print formatted strings like this:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>printf<span class="op">(</span><span class="st">"The value of %s is %.2f"</span><span class="op">,</span> <span class="st">'pi'</span><span class="op">,</span> <span class="va">math.pi</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Creating formatted output using <code>string.format</code> is a big step up from concatenation, but it suffers from the problem of having no concept of a Lua table. The underlying C function is unaware of Lua’s data structures, so it sees tables as a blob of memory and prints their address.</p>
<section id="adding-tables-to-the-mix" class="level3">
<h3 class="anchored" data-anchor-id="adding-tables-to-the-mix">Adding Tables to the Mix</h3>
<p>Scribe provides a <code>scribe.format</code> function that is a drop-in replacement for <code>string.format</code> with the added ability to format Lua tables.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">person</span> <span class="op">=</span> <span class="op">{</span><span class="va">name</span> <span class="op">=</span> <span class="st">'Alice'</span><span class="op">,</span> <span class="va">age</span> <span class="op">=</span> <span class="dv">42</span><span class="op">}</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span><span class="va">scribe</span><span class="op">.</span>format<span class="op">(</span><span class="st">"Data: %t"</span><span class="op">,</span> <span class="va">person</span><span class="op">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This prints <code>Data: { age = 42, name = "Alice" }</code> to your screen.</p>
<p>We do this by adding a new format specifier, <code>%t</code>, that tells <code>scribe.format</code> to format the trailing argument as a table. We have added several new format specifiers that allow you to format Lua tables in various ways.</p>
<p>It happens that <code>%t</code>, <code>%T</code>, <code>%j</code>, and <code>%J</code> were not already claimed as specifiers by <code>string.format</code>. Moreover, those specifiers are mnemonic and easy to remember:</p>
<ul>
<li><code>%t</code> formats a table as an inline string.</li>
<li><code>%T</code> formats a table as a multiline string.</li>
<li><code>%j</code> formats a table as a compact inline JSON string.</li>
<li><code>%J</code> formats a table as a pretty-printed multiline JSON string.</li>
</ul>
<p>So, uppercase <code>%T</code> and <code>%J</code> are for multiline output, while lowercase <code>%t</code> and <code>%j</code> are for inline output.</p>
<p>The signature for <code>scribe.format</code> is the same as <code>string.format</code>:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>format<span class="op">(</span><span class="va">template</span><span class="op">,</span> <span class="op">...)</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The first argument is the format string; the rest are the values we will insert into the placeholders.</p>
<p>We know that all placeholders have the form <code>%&lt;modifier&gt;&lt;specifier&gt;</code>, where <code>&lt;specifier&gt;</code> is the only required part. Our new format specifiers <code>%t</code>, <code>%T</code>, <code>%j</code>, and <code>%J</code> are no different.</p>
<p>Our custom <code>format</code> method looks for those new specifiers in the format string. If none exist, it calls <code>string.format</code> with the same arguments and returns the result.</p>
<p>If it finds any new specifier, it formats the trailing table argument as a string according to the specifier. It can then replace the custom placeholder like <code>%t</code> in the format string with a <code>%s</code>. It also replaces the table argument with its formatted string description. At this point, it calls <code>string.format</code> with the modified format string and the rest of the arguments.</p>
<p>The tricky part is using Lua’s pattern matching to find the custom specifiers in the format string.</p>
<div class="sourceCode" id="annotated-cell-225"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-225-1"><a href="#annotated-cell-225-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>format<span class="op">(</span><span class="va">template</span><span class="op">,</span> <span class="op">...)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-225-2" class="code-annotation-target"><a href="#annotated-cell-225-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">template</span> <span class="op">==</span> <span class="kw">nil</span> <span class="cf">then</span> <span class="cf">return</span> <span class="st">""</span> <span class="cf">end</span></span>
<span id="annotated-cell-225-3"><a href="#annotated-cell-225-3" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-225-4" class="code-annotation-target"><a href="#annotated-cell-225-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">percent_rx</span> <span class="op">=</span> <span class="st">'%%+'</span></span>
<span id="annotated-cell-225-5"><a href="#annotated-cell-225-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">modifier_rx</span> <span class="op">=</span> <span class="st">'[%-%+ #0]?%d*%.?[%d%*]*[hljztL]?[hl]?'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-225-6" class="code-annotation-target"><a href="#annotated-cell-225-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">specifier_rx</span> <span class="op">=</span> <span class="st">'[diuoxXfFeEgGaAcspqtTjJ]'</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-225-7" class="code-annotation-target"><a href="#annotated-cell-225-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">placeholder_rx</span> <span class="op">=</span> <span class="fu">string.format</span><span class="op">(</span><span class="st">'%s(%s)(%s)'</span><span class="op">,</span> <span class="va">percent_rx</span><span class="op">,</span> <span class="va">modifier_rx</span><span class="op">,</span> <span class="va">specifier_rx</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-225-8" class="code-annotation-target"><a href="#annotated-cell-225-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">table_rx</span> <span class="op">=</span> <span class="va">percent_rx</span> <span class="op">..</span> <span class="st">'%d*[tTjJ]'</span></span>
<span id="annotated-cell-225-9"><a href="#annotated-cell-225-9" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-225-10" class="code-annotation-target"><a href="#annotated-cell-225-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">template</span><span class="op">:</span><span class="fu">find</span><span class="op">(</span><span class="va">table_rx</span><span class="op">)</span> <span class="cf">then</span> <span class="cf">return</span> <span class="fu">string.format</span><span class="op">(</span><span class="va">template</span><span class="op">,</span> <span class="op">...)</span> <span class="cf">end</span></span>
<span id="annotated-cell-225-11"><a href="#annotated-cell-225-11" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-225-12" class="code-annotation-target"><a href="#annotated-cell-225-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">table_placeholders</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="annotated-cell-225-13"><a href="#annotated-cell-225-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">n_placeholders</span> <span class="op">=</span> <span class="dv">0</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-225-14" class="code-annotation-target"><a href="#annotated-cell-225-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">mod</span><span class="op">,</span> <span class="va">spec</span> <span class="kw">in</span> <span class="va">template</span><span class="op">:</span><span class="fu">gmatch</span><span class="op">(</span><span class="va">placeholder_rx</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="annotated-cell-225-15"><a href="#annotated-cell-225-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">n_placeholders</span> <span class="op">=</span> <span class="va">n_placeholders</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-225-16"><a href="#annotated-cell-225-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">spec</span> <span class="op">==</span> <span class="st">'t'</span> <span class="kw">or</span> <span class="va">spec</span> <span class="op">==</span> <span class="st">'T'</span> <span class="kw">or</span> <span class="va">spec</span> <span class="op">==</span> <span class="st">'j'</span> <span class="kw">or</span> <span class="va">spec</span> <span class="op">==</span> <span class="st">'J'</span> <span class="cf">then</span></span>
<span id="annotated-cell-225-17"><a href="#annotated-cell-225-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">insert</span><span class="op">(</span><span class="va">table_placeholders</span><span class="op">,</span> <span class="op">{</span> <span class="va">n_placeholders</span><span class="op">,</span> <span class="va">mod</span><span class="op">,</span> <span class="va">spec</span> <span class="op">})</span></span>
<span id="annotated-cell-225-18"><a href="#annotated-cell-225-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-225-19"><a href="#annotated-cell-225-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-225-20"><a href="#annotated-cell-225-20" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="9" onclick="event.preventDefault();">9</a><span id="annotated-cell-225-21" class="code-annotation-target"><a href="#annotated-cell-225-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">local</span> <span class="va">args</span> <span class="op">=</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span>
<span id="annotated-cell-225-22"><a href="#annotated-cell-225-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">#</span><span class="va">args</span> <span class="op">~=</span> <span class="va">n_placeholders</span> <span class="cf">then</span></span>
<span id="annotated-cell-225-23"><a href="#annotated-cell-225-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">string.format</span><span class="op">(</span><span class="st">"[FORMAT ERROR]: %q -- needs %d args but you sent %d!</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> <span class="va">template</span><span class="op">,</span> <span class="va">n_placeholders</span><span class="op">,</span> <span class="op">#</span><span class="va">args</span><span class="op">)</span></span>
<span id="annotated-cell-225-24"><a href="#annotated-cell-225-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-225-25"><a href="#annotated-cell-225-25" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="10" onclick="event.preventDefault();">10</a><span id="annotated-cell-225-26" class="code-annotation-target"><a href="#annotated-cell-225-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="op">#</span><span class="va">table_placeholders</span> <span class="cf">do</span></span>
<span id="annotated-cell-225-27"><a href="#annotated-cell-225-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">index</span><span class="op">,</span> <span class="va">mod</span><span class="op">,</span> <span class="va">spec</span> <span class="op">=</span> <span class="fu">unpack</span><span class="op">(</span><span class="va">table_placeholders</span><span class="op">[</span><span class="va">i</span><span class="op">])</span></span>
<span id="annotated-cell-225-28"><a href="#annotated-cell-225-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">full_spec</span> <span class="op">=</span> <span class="va">mod</span> <span class="op">..</span> <span class="va">spec</span></span>
<span id="annotated-cell-225-29"><a href="#annotated-cell-225-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-225-30"><a href="#annotated-cell-225-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">full_spec</span> <span class="op">==</span> <span class="st">'t'</span> <span class="cf">then</span></span>
<span id="annotated-cell-225-31"><a href="#annotated-cell-225-31" aria-hidden="true" tabindex="-1"></a>            <span class="va">args</span><span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op">=</span> <span class="cn">M</span><span class="op">.</span>inline<span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="va">index</span><span class="op">])</span></span>
<span id="annotated-cell-225-32"><a href="#annotated-cell-225-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elseif</span> <span class="va">full_spec</span> <span class="op">==</span> <span class="st">'T'</span> <span class="cf">then</span></span>
<span id="annotated-cell-225-33"><a href="#annotated-cell-225-33" aria-hidden="true" tabindex="-1"></a>            <span class="va">args</span><span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op">=</span> <span class="cn">M</span><span class="op">.</span>pretty<span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="va">index</span><span class="op">])</span></span>
<span id="annotated-cell-225-34"><a href="#annotated-cell-225-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elseif</span> <span class="va">full_spec</span> <span class="op">==</span> <span class="st">'J'</span> <span class="cf">then</span></span>
<span id="annotated-cell-225-35"><a href="#annotated-cell-225-35" aria-hidden="true" tabindex="-1"></a>            <span class="va">args</span><span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op">=</span> <span class="cn">M</span><span class="op">.</span>json<span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="va">index</span><span class="op">])</span></span>
<span id="annotated-cell-225-36"><a href="#annotated-cell-225-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elseif</span> <span class="va">full_spec</span> <span class="op">==</span> <span class="st">'j'</span> <span class="cf">then</span></span>
<span id="annotated-cell-225-37"><a href="#annotated-cell-225-37" aria-hidden="true" tabindex="-1"></a>            <span class="va">args</span><span class="op">[</span><span class="va">index</span><span class="op">]</span> <span class="op">=</span> <span class="cn">M</span><span class="op">.</span>inline_json<span class="op">(</span><span class="va">args</span><span class="op">[</span><span class="va">index</span><span class="op">])</span></span>
<span id="annotated-cell-225-38"><a href="#annotated-cell-225-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="annotated-cell-225-39"><a href="#annotated-cell-225-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">string.format</span><span class="op">(</span><span class="st">"[FORMAT ERROR]: %q -- unknown table specifier: %q</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> <span class="va">template</span><span class="op">,</span> <span class="va">full_spec</span><span class="op">)</span></span>
<span id="annotated-cell-225-40"><a href="#annotated-cell-225-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="annotated-cell-225-41"><a href="#annotated-cell-225-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="annotated-cell-225-42"><a href="#annotated-cell-225-42" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="11" onclick="event.preventDefault();">11</a><span id="annotated-cell-225-43" class="code-annotation-target"><a href="#annotated-cell-225-43" aria-hidden="true" tabindex="-1"></a>    <span class="va">template</span> <span class="op">=</span> <span class="va">template</span><span class="op">:</span><span class="fu">gsub</span><span class="op">(</span><span class="va">table_rx</span><span class="op">,</span> <span class="st">'%%s'</span><span class="op">)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-225" data-target-annotation="12" onclick="event.preventDefault();">12</a><span id="annotated-cell-225-44" class="code-annotation-target"><a href="#annotated-cell-225-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">string.format</span><span class="op">(</span><span class="va">template</span><span class="op">,</span> <span class="fu">unpack</span><span class="op">(</span><span class="va">args</span><span class="op">))</span></span>
<span id="annotated-cell-225-45"><a href="#annotated-cell-225-45" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-225" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="2" data-code-annotation="1">An edge case: if the format string is <code>nil</code>, we return an empty string.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="4" data-code-annotation="2">The pattern for matching one or more percent signs.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="6" data-code-annotation="3">The pattern for matching a format specifier.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="7" data-code-annotation="4">The pattern for matching a placeholder.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="8" data-code-annotation="5">The pattern for matching our table specifiers.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="10" data-code-annotation="6">If the format string contains no table specifiers, we can call <code>string.format</code> and return the result.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="12" data-code-annotation="7">We create space to store the positions of the table placeholders.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="14" data-code-annotation="8">We iterate over the placeholders in the format string and store the position of any table specifiers.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="21" data-code-annotation="9">We store the trailing arguments in a local variable.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="26" data-code-annotation="10">We iterate over the table placeholders and format the table arguments according to the specifier.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="43" data-code-annotation="11">We replace the table specifiers with <code>%s</code> in the format string.</span>
</dd>
<dt data-target-cell="annotated-cell-225" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-225" data-code-lines="44" data-code-annotation="12">We call <code>string.format</code> with the modified format string and the rest of the arguments.</span>
</dd>
</dl>
<p>A lot is going on here, but the key points are: - We use Lua’s pattern matching to find the placeholders in the format string. - We store the positions of any table specifiers. - We format the table arguments according to the specifier. - We replace the table specifiers with <code>%s</code> in the format string. - We call <code>string.format</code> with the modified format string and the rest of the arguments.</p>
</section>
<section id="more-facades" class="level3">
<h3 class="anchored" data-anchor-id="more-facades">More Facades</h3>
<p>We have added a few more facades to the <code>scribe</code> module to make it easier to work with formatted output. For example:</p>
<div class="sourceCode" id="annotated-cell-226"><pre class="sourceCode lua code-annotation-code code-with-copy code-annotated"><code class="sourceCode lua"><span id="annotated-cell-226-1"><a href="#annotated-cell-226-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>put<span class="op">(</span><span class="va">template</span><span class="op">,</span> <span class="op">...)</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-226" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-226-2" class="code-annotation-target"><a href="#annotated-cell-226-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">io.stdout</span><span class="op">:</span><span class="fu">write</span><span class="op">(</span><span class="cn">M</span><span class="op">.</span>format<span class="op">(</span><span class="va">template</span><span class="op">,</span> <span class="op">...))</span></span>
<span id="annotated-cell-226-3"><a href="#annotated-cell-226-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-226" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-226" data-code-lines="2" data-code-annotation="1">The <code>put</code> function is a simple wrapper around <code>scribe.format</code> that writes the formatted string to the standard output.</span>
</dd>
</dl>
<p>A matching <code>putln</code> function appends a newline character to the same output.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="cn">M</span><span class="op">.</span>putln<span class="op">(</span><span class="va">template</span><span class="op">,</span> <span class="op">...)</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">io.stdout</span><span class="op">:</span><span class="fu">write</span><span class="op">(</span><span class="cn">M</span><span class="op">.</span>format<span class="op">(</span><span class="va">template</span><span class="op">,</span> <span class="op">...),</span> <span class="st">'</span><span class="sc">\n</span><span class="st">'</span><span class="op">)</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Corresponding <code>eput</code>, <code>eputln</code>, <code>fput</code>, and <code>fputln</code> functions write to the standard error stream and to files.</p>


</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/nessan\.github\.io\/scribe");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../pages/formatted-output.html" class="pagination-link" aria-label="Formatted Output">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Formatted Output</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2025 Nessan ∙ Made with <a href="https://quarto.org">Quarto</a></p>
</div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/nessan/scribe">
      <i class="bi bi-github" role="img" aria-label="GitHub Repo">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:nzznfitz+gh@icloud.com">
      <i class="bi bi-envelope" role="img" aria-label="EMail address">
</i> 
    </a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/nessan/scribe/edit/main/docs/pages/tutorial/index.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/nessan/scribe/issues/new/choose" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p><a href="https://opensource.org/license/mit">MIT Licensed</a></p>
</div>
  </div>
</footer>




</body></html>